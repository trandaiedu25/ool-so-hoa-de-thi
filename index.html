<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner: Ch·ªçn Model ƒê√∫ng</title>
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f9ff; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h1 { color: #0284c7; text-align: center; }
        
        .step { margin-bottom: 20px; padding: 15px; border: 1px solid #e0f2fe; border-radius: 8px; }
        .step-title { font-weight: bold; color: #0369a1; margin-bottom: 10px; display: block; }
        
        input, button { width: 100%; padding: 12px; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: #0284c7; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { background: #0369a1; }
        
        #modelList { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .model-tag { padding: 8px 12px; background: #e0f2fe; color: #0284c7; border-radius: 20px; cursor: pointer; border: 1px solid #bae6fd; font-size: 0.9em; }
        .model-tag:hover, .model-tag.selected { background: #0284c7; color: white; border-color: #0284c7; }
        
        #status { margin-top: 15px; padding: 10px; border-radius: 6px; display: none; }
        .error { background: #fee2e2; color: #b91c1c; display: block; }
        .success { background: #dcfce7; color: #15803d; display: block; }
        
        textarea { width: 100%; height: 300px; margin-top: 10px; font-family: monospace; border: 1px solid #ccc; border-radius: 6px; padding: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üì° M√ÅY QU√âT & CH·∫†Y ƒê·ªÄ THI</h1>

    <div class="step">
        <span class="step-title">B∆Ø·ªöC 1: Nh·∫≠p Key & Qu√©t Model kh·∫£ d·ª•ng</span>
        <input type="password" id="apiKey" placeholder="D√°n Gemini API Key v√†o ƒë√¢y...">
        <button onclick="scanModels()" style="margin-top: 10px;">üîç 1. QU√âT T√åM MODEL TRONG T√ÄI KHO·∫¢N</button>
        
        <div id="modelArea" style="display:none; margin-top:15px; border-top: 1px dashed #ccc; padding-top:10px;">
            <span style="font-size:0.9em; color:#555;">Google ƒë√£ t√¨m th·∫•y c√°c model sau trong t√†i kho·∫£n c·ªßa b·∫°n (H√£y b·∫•m ch·ªçn 1 c√°i):</span>
            <div id="modelList"></div>
            <input type="hidden" id="selectedModelId">
        </div>
    </div>

    <div class="step" id="step2" style="opacity: 0.5; pointer-events: none;">
        <span class="step-title">B∆Ø·ªöC 2: Upload ƒê·ªÅ & Ch·∫°y</span>
        <input type="file" id="fileInput" accept="image/*, application/pdf">
        <button onclick="runExam()" id="btnRun" style="margin-top: 10px; background: #16a34a;">üöÄ 2. T·∫†O ƒê·ªÄ THI NGAY</button>
    </div>

    <div id="status"></div>
    <textarea id="output" placeholder="K·∫øt qu·∫£ JSON s·∫Ω hi·ªán ·ªü ƒë√¢y..."></textarea>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // H√†m 1: D√πng fetch thu·∫ßn ƒë·ªÉ qu√©t list model (Gi·ªëng h·ªát tr√¨nh duy·ªát)
    window.scanModels = async () => {
        const key = document.getElementById('apiKey').value.trim();
        const status = document.getElementById('status');
        const listDiv = document.getElementById('modelList');
        const area = document.getElementById('modelArea');
        
        if (!key) { alert("Ch∆∞a nh·∫≠p Key!"); return; }

        status.style.display = 'block';
        status.className = ''; 
        status.innerText = "‚è≥ ƒêang k·∫øt n·ªëi t·ªõi Google...";
        listDiv.innerHTML = "";

        try {
            // G·ªçi API tr·ª±c ti·∫øp ƒë·ªÉ l·∫•y danh s√°ch
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
            const data = await res.json();

            if (data.error) throw new Error(data.error.message);
            if (!data.models) throw new Error("Kh√¥ng t√¨m th·∫•y model n√†o!");

            // L·ªçc ra c√°c model t·∫°o n·ªôi dung (generateContent)
            const validModels = data.models.filter(m => 
                m.supportedGenerationMethods.includes("generateContent")
            );

            if (validModels.length === 0) throw new Error("Key ƒë√∫ng nh∆∞ng kh√¥ng c√≥ model n√†o h·ªó tr·ª£ t·∫°o vƒÉn b·∫£n.");

            status.className = 'success';
            status.innerText = `‚úÖ ƒê√£ t√¨m th·∫•y ${validModels.length} model! H√£y b·∫•m ch·ªçn 1 c√°i b√™n d∆∞·ªõi.`;
            area.style.display = 'block';

            // V·∫Ω c√°c n√∫t b·∫•m
            validModels.forEach(m => {
                // Ch·ªâ l·∫•y t√™n ng·∫Øn (b·ªè models/) ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp
                const shortName = m.name.replace('models/', '');
                const btn = document.createElement('div');
                btn.className = 'model-tag';
                btn.innerText = shortName;
                btn.onclick = () => selectModel(m.name, btn);
                listDiv.appendChild(btn);
            });

        } catch (e) {
            status.className = 'error';
            status.innerText = "‚ùå L·ªói Qu√©t: " + e.message;
        }
    };

    // H√†m ch·ªçn model
    function selectModel(fullName, btnElement) {
        document.getElementById('selectedModelId').value = fullName; // L∆∞u t√™n ƒë·∫ßy ƒë·ªß (models/gemini-...)
        
        // Highlight n√∫t ƒë∆∞·ª£c ch·ªçn
        document.querySelectorAll('.model-tag').forEach(b => b.classList.remove('selected'));
        btnElement.classList.add('selected');

        // M·ªü kh√≥a B∆∞·ªõc 2
        document.getElementById('step2').style.opacity = '1';
        document.getElementById('step2').style.pointerEvents = 'auto';
        
        const status = document.getElementById('status');
        status.className = 'success';
        status.innerText = `ƒê√£ ch·ªçn: ${fullName}. S·∫µn s√†ng ch·∫°y!`;
    }

    // H√†m 2: Ch·∫°y ch√≠nh th·ª©c b·∫±ng SDK
    window.runExam = async () => {
        const key = document.getElementById('apiKey').value.trim();
        const modelName = document.getElementById('selectedModelId').value;
        const fileInput = document.getElementById('fileInput');
        const output = document.getElementById('output');
        const status = document.getElementById('status');
        const btn = document.getElementById('btnRun');

        if (!fileInput.files.length) { alert("Ch∆∞a ch·ªçn file!"); return; }
        if (!modelName) { alert("Ch∆∞a ch·ªçn model!"); return; }

        btn.disabled = true;
        status.className = '';
        status.innerText = "‚è≥ ƒêang x·ª≠ l√Ω ƒë·ªÅ thi... (Model: " + modelName + ")";
        output.value = "";

        try {
            // Chuy·ªÉn file
            const file = fileInput.files[0];
            const reader = new FileReader();
            const base64Promise = new Promise(resolve => {
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            const base64Data = await base64Promise;

            // G·ªçi AI
            const genAI = new GoogleGenerativeAI(key);
            // Quan tr·ªçng: Truy·ªÅn ƒë√∫ng t√™n model l·∫•y t·ª´ b∆∞·ªõc 1 (b·ªè prefix models/ n·∫øu SDK t·ª± th√™m, nh∆∞ng SDK m·ªõi x·ª≠ l√Ω ƒë∆∞·ª£c c·∫£ hai)
            // ƒê·ªÉ an to√†n nh·∫•t, ta d√πng modelName.replace('models/', '')
            const cleanModelName = modelName.replace('models/', '');
            
            const model = genAI.getGenerativeModel({ model: cleanModelName });
            
            const result = await model.generateContent([
                "Tr√≠ch xu·∫•t ƒë·ªÅ thi th√†nh JSON (c√¢u h·ªèi, ƒë√°p √°n, gi·∫£i th√≠ch). D√πng LaTeX cho to√°n. N·∫øu c√≥ h√¨nh th√¨ m√¥ t·∫£.",
                { inlineData: { data: base64Data, mimeType: file.type } }
            ]);
            
            const text = result.response.text();
            output.value = text.replace(/```json/g, "").replace(/```/g, "").trim();
            status.className = 'success';
            status.innerText = "‚úÖ TH√ÄNH C√îNG R·ª∞C R·ª†!";

        } catch (e) {
            console.error(e);
            status.className = 'error';
            status.innerText = "‚ùå L·ªói Ch·∫°y: " + e.message;
        } finally {
            btn.disabled = false;
        }
    };
</script>

</body>
</html>
