<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool S·ªë H√≥a ƒê·ªÅ Thi (Auto-Fix Model)</title>
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f6f8; max-width: 1200px; margin: 0 auto; }
        .container { display: flex; gap: 20px; }
        .box { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input, textarea, button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }
        .error { color: red; background: #fff0f0; padding: 10px; border-radius: 4px; margin-top: 10px; font-family: monospace; font-size: 0.9em; }
        .success { color: green; background: #f0fff4; padding: 10px; }
    </style>
</head>
<body>

<h1>Tool S·ªë H√≥a ƒê·ªÅ Thi (Phi√™n b·∫£n T·ª± D√≤ L·ªói)</h1>

<div class="container">
    <div class="box">
        <h3>1. C·∫•u h√¨nh</h3>
        <label>Gemini API Key (B·∫Øt bu·ªôc):</label>
        <input type="password" id="geminiKey" placeholder="D√°n Key AI Studio v√†o ƒë√¢y...">
        
        <label>ImgBB API Key (T√πy ch·ªçn):</label>
        <input type="text" id="imgbbKey" placeholder="D√°n Key ImgBB (n·∫øu c√≥)...">
        
        <label>Ch·ªçn ƒê·ªÅ Thi (·∫¢nh ho·∫∑c PDF):</label>
        <input type="file" id="fileInput" accept="image/*, application/pdf">
        
        <button id="btnRun" onclick="startProcess()">üöÄ CH·∫†Y NGAY</button>
        
        <div id="statusLog" style="margin-top: 15px;"></div>
    </div>

    <div class="box">
        <h3>2. K·∫øt qu·∫£ JSON</h3>
        <textarea id="output" rows="20" placeholder="K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y..."></textarea>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // Danh s√°ch c√°c t√™n Model ƒë·ªÉ th·ª≠ l·∫ßn l∆∞·ª£t (N·∫øu c√°i 1 l·ªói -> th·ª≠ c√°i 2 -> th·ª≠ c√°i 3)
    const MODEL_NAMES = [
        "gemini-1.5-flash",       // ∆Øu ti√™n 1: B·∫£n Flash chu·∫©n
        "gemini-1.5-flash-001",   // ∆Øu ti√™n 2: B·∫£n Flash ƒë·ªãnh danh c·ª• th·ªÉ
        "gemini-1.5-pro",         // ∆Øu ti√™n 3: B·∫£n Pro chu·∫©n
        "gemini-pro"              // ∆Øu ti√™n 4: B·∫£n Legacy (C≈© nh∆∞ng tr√¢u b√≤)
    ];

    async function fileToBase64(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(file);
        });
    }

    // H√†m th·ª≠ g·ªçi API v·ªõi m·ªôt t√™n model c·ª• th·ªÉ
    async function tryGenerate(apiKey, modelName, prompt, filePart) {
        const genAI = new GoogleGenerativeAI(apiKey);
        const model = genAI.getGenerativeModel({ model: modelName });
        
        // Th·ª≠ g·ª≠i request
        const result = await model.generateContent([prompt, filePart]);
        return result.response.text();
    }

    window.startProcess = async () => {
        const key = document.getElementById('geminiKey').value.trim();
        const fileInput = document.getElementById('fileInput');
        const log = document.getElementById('statusLog');
        const out = document.getElementById('output');
        const btn = document.getElementById('btnRun');

        if (!key || !fileInput.files.length) {
            alert("Thi·∫øu Key ho·∫∑c File!"); return;
        }

        btn.disabled = true;
        out.value = "";
        log.innerHTML = "‚è≥ ƒêang kh·ªüi ƒë·ªông...";

        try {
            const file = fileInput.files[0];
            const filePart = {
                inlineData: {
                    data: await fileToBase64(file),
                    mimeType: file.type
                }
            };

            const prompt = `Tr√≠ch xu·∫•t c√¢u h·ªèi t·ª´ ƒë·ªÅ thi n√†y th√†nh JSON. V·ªõi c√¥ng th·ª©c to√°n d√πng LaTeX. N·∫øu c√≥ h√¨nh v·∫Ω, h√£y m√¥ t·∫£ ho·∫∑c v·∫Ω SVG (type: svg_code). Tr·∫£ v·ªÅ JSON thu·∫ßn.`;

            // V√íNG L·∫∂P D√í T√åM MODEL
            let successContent = null;
            
            for (const name of MODEL_NAMES) {
                log.innerHTML += `<div style="color:blue">üîÑ ƒêang th·ª≠ model: <b>${name}</b>...</div>`;
                try {
                    successContent = await tryGenerate(key, name, prompt, filePart);
                    log.innerHTML += `<div class="success">‚úÖ Th√†nh c√¥ng v·ªõi model: ${name}!</div>`;
                    break; // Tho√°t v√≤ng l·∫∑p ngay khi th√†nh c√¥ng
                } catch (e) {
                    console.error(e);
                    let msg = e.message;
                    if (msg.includes("404")) msg = "Kh√¥ng t√¨m th·∫•y (404)";
                    if (msg.includes("400")) msg = "Key kh√¥ng h·ª£p l·ªá (400)";
                    log.innerHTML += `<div class="error">‚ùå ${name} th·∫•t b·∫°i: ${msg}</div>`;
                    
                    // N·∫øu l·ªói l√† do KEY sai (400), th√¨ kh√¥ng c·∫ßn th·ª≠ c√°c model kh√°c l√†m g√¨
                    if (msg.includes("400")) {
                        throw new Error("API Key c·ªßa b·∫°n b·ªã sai. H√£y ki·ªÉm tra l·∫°i Key!");
                    }
                }
            }

            if (successContent) {
                // L√†m s·∫°ch JSON
                const cleanJson = successContent.replace(/```json/g, "").replace(/```/g, "").trim();
                out.value = cleanJson;
            } else {
                throw new Error("ƒê√£ th·ª≠ t·∫•t c·∫£ c√°c model nh∆∞ng ƒë·ªÅu th·∫•t b·∫°i! Vui l√≤ng ki·ªÉm tra l·∫°i t√†i kho·∫£n Google AI Studio.");
            }

        } catch (err) {
            log.innerHTML += `<div class="error">‚õî L·ªñI NGHI√äM TR·ªåNG: ${err.message}</div>`;
        } finally {
            btn.disabled = false;
        }
    };
</script>
</body>
</html>
