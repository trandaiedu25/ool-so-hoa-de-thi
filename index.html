<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đề Thi Thử Tốt Nghiệp THPT 2025 - Môn Toán - Đề Số 01</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX for Math -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .katex { font-size: 1.1em; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        /* Custom scrollbar for tables */
        .overflow-x-auto::-webkit-scrollbar { height: 8px; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        
        /* Animation cho cảnh báo */
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
        }
        .animate-pulse-red { animation: pulse-red 2s infinite; }

        /* Animation cho đồng hồ sắp hết giờ */
        @keyframes blink-text {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-blink { animation: blink-text 1s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot, createPortal } = ReactDOM;

        // --- CẤU HÌNH FIREBASE ---
        const USER_CONFIG = {
            apiKey: "AIzaSyCEgOrAaEHjZbhYTSkVHGRkGa8WfjjnWvg",
            authDomain: "trandaiedu-39df1.firebaseapp.com",
            projectId: "trandaiedu-39df1",
            storageBucket: "trandaiedu-39df1.firebasestorage.app",
            messagingSenderId: "286264195114",
            appId: "1:286264195114:web:c6ca2fe8e1b3e7e25ceb53"
        };

        let db = null;
        let auth = null;
        const COLLECTION_NAME = "quiz_results_math12_thpt2025_de01_full";
        const QUIZ_DURATION_MINUTES = 90; 

        const initializeFirebase = () => {
            try {
                if (!window.firebase) return false;
                if (firebase.apps.length === 0) firebase.initializeApp(USER_CONFIG);
                auth = firebase.auth();
                db = firebase.firestore();
                return true;
            } catch (e) { console.error(e); return false; }
        };
        initializeFirebase();

        // --- COMPONENTS HỖ TRỢ ---
        const Icon = ({ name, size=24, className="" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                   const iconElement = window.lucide.icons[name];
                   if(iconElement) iconRef.current.innerHTML = iconElement.toSvg({ class: className, width: size, height: size });
                }
            }, [name, size, className]);
            return <span ref={iconRef} className={className} style={{display: 'inline-flex', alignItems: 'center'}}></span>;
        };

        const MathText = ({ text, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && text && window.renderMathInElement) {
                    renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "$", right: "$", display: false},
                            {left: "\\(", right: "\\)", display: false},
                            {left: "\\[", right: "\\]", display: true}
                        ],
                        throwOnError: false
                    });
                }
            }, [text]);
            return <span ref={containerRef} className={className} dangerouslySetInnerHTML={{__html: text}} />;
        };

        // --- HÌNH ẢNH & BẢNG BIỂU ---
        const TablePart1Q1 = () => (
            <div className="flex justify-center my-4 overflow-x-auto">
                <svg width="400" height="150" viewBox="0 0 400 150" className="bg-white rounded shadow-sm border border-gray-200 min-w-[400px]">
                    <defs>
                        <marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#000" />
                        </marker>
                    </defs>
                    <line x1="50" y1="0" x2="50" y2="150" stroke="#000" strokeWidth="1"/>
                    <line x1="0" y1="40" x2="400" y2="40" stroke="#000" strokeWidth="1"/>
                    <line x1="0" y1="80" x2="400" y2="80" stroke="#000" strokeWidth="1"/>
                    <text x="25" y="25" fontFamily="Arial" fontSize="14">x</text>
                    <text x="80" y="25" fontFamily="Arial" fontSize="14">-∞</text>
                    <text x="180" y="25" fontFamily="Arial" fontSize="14">-1</text>
                    <text x="280" y="25" fontFamily="Arial" fontSize="14">1</text>
                    <text x="370" y="25" fontFamily="Arial" fontSize="14">+∞</text>
                    <text x="10" y="65" fontFamily="Arial" fontSize="14">y'</text>
                    <text x="130" y="65" fontFamily="Arial" fontSize="14">+</text>
                    <text x="180" y="65" fontFamily="Arial" fontSize="14">0</text>
                    <text x="230" y="65" fontFamily="Arial" fontSize="14">-</text>
                    <text x="280" y="65" fontFamily="Arial" fontSize="14">0</text>
                    <text x="330" y="65" fontFamily="Arial" fontSize="14">+</text>
                    <text x="10" y="115" fontFamily="Arial" fontSize="14">y</text>
                    <path d="M70,130 L170,95" stroke="#000" fill="none" markerEnd="url(#arrow)"/>
                    <path d="M190,95 L270,130" stroke="#000" fill="none" markerEnd="url(#arrow)"/>
                    <path d="M290,130 L380,95" stroke="#000" fill="none" markerEnd="url(#arrow)"/>
                    <text x="60" y="135" fontFamily="Arial" fontSize="12">-∞</text>
                    <text x="175" y="90" fontFamily="Arial" fontSize="12">2</text>
                    <text x="275" y="140" fontFamily="Arial" fontSize="12">-2</text>
                    <text x="380" y="90" fontFamily="Arial" fontSize="12">+∞</text>
                </svg>
            </div>
        );

        const TablePart1Q3 = () => (
            <div className="my-4 overflow-x-auto">
                <table className="min-w-full border border-collapse border-gray-300 text-sm text-center">
                    <thead>
                        <tr className="bg-gray-100">
                            <th className="border border-gray-300 p-2 font-bold">Thời gian</th>
                            <th className="border border-gray-300 p-2">[0; 20)</th>
                            <th className="border border-gray-300 p-2">[20; 40)</th>
                            <th className="border border-gray-300 p-2">[40; 60)</th>
                            <th className="border border-gray-300 p-2">[60; 80)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th className="border border-gray-300 p-2 bg-gray-50 font-bold">Số HS</th>
                            <td className="border border-gray-300 p-2">5</td>
                            <td className="border border-gray-300 p-2">12</td>
                            <td className="border border-gray-300 p-2">18</td>
                            <td className="border border-gray-300 p-2">5</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        );

        const ParabolPart3Q2 = () => (
            <div className="flex justify-center my-4">
                <svg width="200" height="200" viewBox="-3 -5 6 6" className="bg-white rounded shadow-sm border border-gray-200">
                    <path d="M -2 0 Q 0 8 2 0" fill="none" stroke="black" strokeWidth="0.1" />
                    <line x1="-3" y1="0" x2="3" y2="0" stroke="black" strokeWidth="0.05" />
                    <line x1="0" y1="0" x2="0" y2="4" stroke="black" strokeWidth="0.05" strokeDasharray="0.1, 0.1" />
                    <circle cx="0" cy="3.75" r="0.1" fill="yellow" stroke="orange" strokeWidth="0.05" />
                    <text x="0.2" y="2" fontSize="0.5" fill="black">h=4m</text>
                    <text x="-1" y="-0.5" fontSize="0.5" fill="black">w=4m</text>
                </svg>
            </div>
        );

        // --- NGÂN HÀNG CÂU HỎI ---
        const QUESTION_BANK = [
            // --- PHẦN I ---
            { 
                id: 'p1_q1', type: 'mcq', 
                question: "Cho hàm số $y = f(x)$ có bảng biến thiên như sau. Hàm số đã cho đồng biến trên khoảng nào dưới đây?", 
                image: <TablePart1Q1 />,
                options: ["$(-1; 1)$", "$(1; +\\infty)$", "$(-\\infty; 1)$", "$(-1; 2)$"], 
                correct: 1, 
                explanation: "Nhìn vào bảng biến thiên, dấu của $y'$ dương (+) trên khoảng $(1; +\\infty)$ và $(-\\infty; -1)$.<br>Hàm số đồng biến khi $y' > 0$. Do đó hàm số đồng biến trên $(1; +\\infty)$." 
            },
            { 
                id: 'p1_q2', type: 'mcq', 
                question: "Trong không gian $Oxyz$, cho vectơ $\\vec{a} = 2\\vec{i} - 3\\vec{j} + \\vec{k}$. Tọa độ của vectơ $\\vec{a}$ là", 
                options: ["$(2; -3; 1)$", "$(2; 3; 1)$", "$(2; -3; 0)$", "$(1; -3; 2)$"], 
                correct: 0, 
                explanation: "Vectơ $\\vec{a} = x\\vec{i} + y\\vec{j} + z\\vec{k}$ có tọa độ là $(x; y; z)$.<br>Với $\\vec{a} = 2\\vec{i} - 3\\vec{j} + \\vec{k}$, ta có tọa độ là $(2; -3; 1)$." 
            },
            { 
                id: 'p1_q3', type: 'mcq', 
                question: "Cho mẫu số liệu ghép nhóm về thời gian tập thể dục mỗi ngày (phút) của một nhóm học sinh. Nhóm chứa mốt của mẫu số liệu trên là", 
                image: <TablePart1Q3 />,
                options: ["$[0; 20)$", "$[20; 40)$", "$[40; 60)$", "$[60; 80)$"], 
                correct: 2, 
                explanation: "Nhóm chứa mốt là nhóm có tần số lớn nhất.<br>Tần số các nhóm lần lượt là 5, 12, 18, 5.<br>Tần số lớn nhất là 18, tương ứng với nhóm $[40; 60)$." 
            },
            { 
                id: 'p1_q4', type: 'mcq', 
                question: "Cho cấp số nhân $(u_n)$ với $u_1 = 3$ và công bội $q = 2$. Giá trị của $u_3$ bằng", 
                options: ["6", "8", "12", "24"], 
                correct: 2, 
                explanation: "Công thức cấp số nhân: $u_n = u_1 \\cdot q^{n-1}$.<br>$u_3 = 3 \\cdot 2^{3-1} = 3 \\cdot 2^2 = 3 \\cdot 4 = 12$." 
            },
            { 
                id: 'p1_q5', type: 'mcq', 
                question: "Tập nghiệm của bất phương trình $\\log_2(x - 1) < 3$ là", 
                options: ["$(-\\infty; 9)$", "$(1; 9)$", "$(1; 7)$", "$(-\\infty; 7)$"], 
                correct: 1, 
                explanation: "Điều kiện: $x - 1 > 0 \\Leftrightarrow x > 1$.<br>Bất phương trình: $\\log_2(x - 1) < 3 \\Leftrightarrow x - 1 < 2^3 \\Leftrightarrow x - 1 < 8 \\Leftrightarrow x < 9$.<br>Kết hợp điều kiện, tập nghiệm là $(1; 9)$." 
            },
            { 
                id: 'p1_q6', type: 'mcq', 
                question: "Trong không gian với hệ tọa độ $Oxyz$, phương trình nào dưới đây là phương trình của mặt phẳng đi qua điểm $M(1; -2; 3)$ và có vectơ pháp tuyến $\\vec{n} = (2; 1; -1)$?", 
                options: ["$2x + y - z + 3 = 0$", "$x - 2y + 3z + 3 = 0$", "$2x + y - z - 3 = 0$", "$2x + y - z + 5 = 0$"], 
                correct: 0, 
                explanation: "Phương trình mặt phẳng qua $M(x_0; y_0; z_0)$ với VTPT $\\vec{n}(a; b; c)$ là: $a(x - x_0) + b(y - y_0) + c(z - z_0) = 0$.<br>Thay số: $2(x - 1) + 1(y + 2) - 1(z - 3) = 0$<br>$\\Leftrightarrow 2x - 2 + y + 2 - z + 3 = 0 \\Leftrightarrow 2x + y - z + 3 = 0$." 
            },
            { 
                id: 'p1_q7', type: 'mcq', 
                question: "Cho hai biến cố A và B độc lập với nhau. Biết $P(A) = 0,3$ và $P(B) = 0,4$. Xác suất của biến cố $A \\cup B$ là", 
                options: ["0,12", "0,7", "0,58", "0,82"], 
                correct: 2, 
                explanation: "Công thức: $P(A \\cup B) = P(A) + P(B) - P(A \\cap B)$.<br>Vì A, B độc lập nên $P(A \\cap B) = P(A) \\cdot P(B) = 0,3 \\cdot 0,4 = 0,12$.<br>$P(A \\cup B) = 0,3 + 0,4 - 0,12 = 0,58$." 
            },
            { 
                id: 'p1_q8', type: 'mcq', 
                question: "Hàm số $F(x) = x^2 + \\sin x$ là một nguyên hàm của hàm số nào dưới đây?", 
                options: ["$f(x) = 2x + \\cos x$", "$f(x) = 2x - \\cos x$", "$f(x) = \\frac{x^3}{3} - \\cos x$", "$f(x) = x^2 + \\cos x$"], 
                correct: 0, 
                explanation: "$f(x) = F'(x) = (x^2 + \\sin x)' = 2x + \\cos x$." 
            },
            { 
                id: 'p1_q9', type: 'mcq', 
                question: "Đồ thị hàm số $y = \\frac{2x - 1}{x + 1}$ có tiệm cận đứng là đường thẳng", 
                options: ["$x = 2$", "$y = 2$", "$x = -1$", "$y = -1$"], 
                correct: 2, 
                explanation: "Tiệm cận đứng của hàm phân thức hữu tỉ là nghiệm của mẫu số (nếu không bị triệt tiêu bởi tử).<br>$x + 1 = 0 \\Leftrightarrow x = -1$." 
            },
            { 
                id: 'p1_q10', type: 'mcq', 
                question: "Cho hình chóp S.ABCD có đáy ABCD là hình vuông cạnh $a$, $SA \\perp (ABCD)$ và $SA = a\\sqrt{2}$. Góc giữa đường thẳng SC và mặt phẳng (ABCD) bằng", 
                options: ["$30^\\circ$", "$45^\\circ$", "$60^\\circ$", "$90^\\circ$"], 
                correct: 1, 
                explanation: "Hình chiếu của SC lên (ABCD) là AC (vì $SA \\perp (ABCD)$).<br>Góc giữa SC và (ABCD) là góc $\\widehat{SCA}$.<br>AC là đường chéo hình vuông cạnh $a$ nên $AC = a\\sqrt{2}$.<br>Tam giác SAC vuông tại A có $SA = a\\sqrt{2}$, $AC = a\\sqrt{2}$ $\\Rightarrow$ Tam giác SAC vuông cân tại A.<br>Vậy $\\widehat{SCA} = 45^\\circ$." 
            },
            { 
                id: 'p1_q11', type: 'mcq', 
                question: "Phương trình đường tiệm cận xiên của đồ thị hàm số $y = 2x + 1 + \\frac{3}{x-1}$ là", 
                options: ["$y = 2x$", "$y = 2x + 1$", "$y = x - 1$", "$x = 1$"], 
                correct: 1, 
                explanation: "Hàm số $y = ax + b + g(x)$ với $\\lim_{x \\to \\infty} g(x) = 0$ thì $y = ax + b$ là tiệm cận xiên.<br>Ở đây $y = 2x + 1 + \\frac{3}{x-1}$. Vì $\\lim_{x \\to \\infty} \\frac{3}{x-1} = 0$ nên tiệm cận xiên là $y = 2x + 1$." 
            },
            { 
                id: 'p1_q12', type: 'mcq', 
                question: "Cho hàm số $y=f(x)$ liên tục trên $\\mathbb{R}$ và $\\int_0^2 f(x)dx = 5$, $\\int_2^5 f(x)dx = 3$. Tính $I = \\int_0^5 f(x)dx$.", 
                options: ["$I = 8$", "$I = 2$", "$I = 15$", "$I = -2$"], 
                correct: 0, 
                explanation: "Tính chất cộng của tích phân: $\\int_0^5 f(x)dx = \\int_0^2 f(x)dx + \\int_2^5 f(x)dx$.<br>$I = 5 + 3 = 8$." 
            },

            // --- PHẦN II ---
            {
                id: 'p2_q1', type: 'group_tf',
                question: "Cho hàm số $y = \\frac{x^2 - 3x + 3}{x - 1}$ có đồ thị $(C)$.",
                subQuestions: [
                    { id: 'a', text: "Tập xác định của hàm số là $D = \\mathbb{R} \\setminus \\{1\\}$.", correct: true },
                    { id: 'b', text: "Đồ thị hàm số có tiệm cận xiên là đường thẳng $y = x - 2$.", correct: true },
                    { id: 'c', text: "Hàm số đạt cực đại tại $x = 2$.", correct: false },
                    { id: 'd', text: "Đường thẳng $y = -2x + m$ cắt đồ thị $(C)$ tại hai điểm phân biệt với mọi giá trị của $m$.", correct: false }
                ],
                explanation: "Ta có: $y = \\frac{x^2 - 3x + 3}{x - 1} = \\frac{(x-1)(x-2) + 1}{x-1} = x - 2 + \\frac{1}{x-1}$.<br>$y' = 1 - \\frac{1}{(x-1)^2} = \\frac{(x-1)^2 - 1}{(x-1)^2} = \\frac{x^2 - 2x}{(x-1)^2}$.<br>$y' = 0 \\Leftrightarrow x = 0$ hoặc $x = 2$.<br><strong>a) Đúng.</strong> Điều kiện $x - 1 \\ne 0 \\Rightarrow x \\ne 1$.<br><strong>b) Đúng.</strong> Dạng $y = ax+b + \\frac{c}{x-1}$, nên TCX là $y = x - 2$.<br><strong>c) Sai.</strong> Lập BBT, tại $x=2$, $y'=0$ và đổi dấu từ (-) sang (+), nên $x=2$ là điểm cực tiểu. Cực đại tại $x=0$.<br><strong>d) Sai.</strong> Phương trình hoành độ giao điểm: $\\frac{x^2 - 3x + 3}{x - 1} = -2x + m \\Leftrightarrow 3x^2 - (5+m)x + (3+m) = 0$ (*).<br>Để cắt tại 2 điểm phân biệt thì (*) phải có 2 nghiệm phân biệt khác 1.<br>$\\Delta = (5+m)^2 - 12(3+m) = m^2 - 2m - 11$.<br>Kiểm tra lại mệnh đề: 'với mọi giá trị của m'. Nếu $m=1$ thì $\\Delta = 1 - 2 - 11 < 0$, vô nghiệm. Vậy ý d) là <strong>Sai</strong>."
            },
            {
                id: 'p2_q2', type: 'group_tf',
                question: "Trong không gian với hệ tọa độ $Oxyz$, cho 4 điểm $A(1; 0; 0)$, $B(0; 2; 0)$, $C(0; 0; 3)$ và $D(1; 2; 3)$.",
                subQuestions: [
                    { id: 'a', text: "Vectơ $\\vec{AB}$ có tọa độ là $(-1; 2; 0)$.", correct: true },
                    { id: 'b', text: "Phương trình mặt phẳng $(ABC)$ là $\\frac{x}{1} + \\frac{y}{2} + \\frac{z}{3} = 1$.", correct: true },
                    { id: 'c', text: "Điểm $D$ nằm trên mặt phẳng $(ABC)$.", correct: false },
                    { id: 'd', text: "Thể tích khối tứ diện $OBCD$ bằng 2 (với O là gốc tọa độ).", correct: false }
                ],
                explanation: "<strong>a) Đúng.</strong> $\\vec{AB} = (0-1; 2-0; 0-0) = (-1; 2; 0)$.<br><strong>b) Đúng.</strong> Phương trình mặt phẳng chắn: $\\frac{x}{1} + \\frac{y}{2} + \\frac{z}{3} = 1$.<br><strong>c) Sai.</strong> Thay $D(1;2;3)$ vào: $\\frac{1}{1} + \\frac{2}{2} + \\frac{3}{3} = 1 + 1 + 1 = 3 \\ne 1$. D không thuộc (ABC).<br><strong>d) Sai.</strong> Thể tích $V = \\frac{1}{3} \\cdot S_{OBC} \\cdot h = \\frac{1}{3} \\cdot 3 \\cdot 1 = 1$. (Diện tích OBC = 0.5 * 2 * 3 = 3, chiều cao từ D đến Oyz là 1)."
            },
            {
                id: 'p2_q3', type: 'group_tf',
                question: "Một công ty dự báo lợi nhuận (đơn vị: tỷ đồng) theo thời gian $t$ (tháng) được tính bởi công thức $P(t) = -t^3 + 12t^2 - 36t + 50$ với $0 \\le t \\le 8$.",
                subQuestions: [
                    { id: 'a', text: "Lợi nhuận của công ty giảm trong khoảng thời gian từ tháng thứ 2 đến tháng thứ 6.", correct: false },
                    { id: 'b', text: "Lợi nhuận đạt giá trị nhỏ nhất tại $t = 6$.", correct: false },
                    { id: 'c', text: "Tốc độ tăng trưởng lợi nhuận lớn nhất tại tháng thứ 4.", correct: true },
                    { id: 'd', text: "Lợi nhuận cao nhất trong 8 tháng đầu đạt 50 tỷ đồng.", correct: true }
                ],
                explanation: "$P'(t) = -3t^2 + 24t - 36$.<br>$P'(t) = 0 \\Leftrightarrow t^2 - 8t + 12 = 0 \\Leftrightarrow t=2$ hoặc $t=6$.<br>Bảng biến thiên trên $[0; 8]$: t: 0 -> 2 (Đồng biến) -> 6 (Nghịch biến) -> 8 (Đồng biến).<br>Wait, dấu tam thức bậc 2 hệ số âm: Trong trái (dương), ngoài cùng (âm). Vậy: Giảm trên (0;2), Tăng trên (2;6), Giảm trên (6;8).<br><strong>a) Sai.</strong> Trên (2; 6), $P'(t) > 0$, lợi nhuận tăng.<br><strong>b) Sai.</strong> Tại $t=6$ là cực đại.<br><strong>c) Đúng.</strong> Tốc độ tăng trưởng là $P'(t)$. Max của $P'(t)$ là đỉnh parabol $-3t^2 + 24t - 36$. Đỉnh tại $t = -b/2a = -24/-6 = 4$.<br><strong>d) Đúng.</strong> $P(0)=50, P(2)=18, P(6)=50, P(8)=18$. Max là 50."
            },
            {
                id: 'p2_q4', type: 'group_tf',
                question: "Cho hai mẫu số liệu ghép nhóm về điểm thi Toán của lớp 12A và 12B như sau: Lớp 12A: $S_A^2 = 1,25$, $\\bar{x}_A = 8,0$. Lớp 12B: $S_B^2 = 1,80$, $\\bar{x}_B = 7,5$.",
                subQuestions: [
                    { id: 'a', text: "Điểm trung bình của lớp 12A cao hơn lớp 12B.", correct: true },
                    { id: 'b', text: "Độ lệch chuẩn của điểm thi lớp 12A xấp xỉ 1,12.", correct: true },
                    { id: 'c', text: "Điểm thi của học sinh lớp 12B đồng đều hơn lớp 12A.", correct: false },
                    { id: 'd', text: "Nếu gộp chung hai lớp (giả sử sĩ số bằng nhau), điểm trung bình chung là 7,75.", correct: true }
                ],
                explanation: "<strong>a) Đúng.</strong> $\\bar{x}_A = 8.0 > \\bar{x}_B = 7.5$.<br><strong>b) Đúng.</strong> $S_A = \\sqrt{1.25} \\approx 1.118$.<br><strong>c) Sai.</strong> Phương sai $S_B^2 > S_A^2$ (1.8 > 1.25) nên độ phân tán lớp B cao hơn, nghĩa là lớp A đồng đều hơn.<br><strong>d) Đúng.</strong> $\\bar{x}_{chung} = \\frac{n\\bar{x}_A + n\\bar{x}_B}{2n} = \\frac{8 + 7.5}{2} = 7.75$."
            },

            // --- PHẦN III ---
            { 
                id: 'p3_q1', type: 'text', 
                question: "Một chất điểm chuyển động theo phương trình $s(t) = t^3 - 3t^2 + 4t + 1$, trong đó $t$ tính bằng giây, $s$ tính bằng mét. Tính vận tốc của chất điểm tại thời điểm gia tốc bằng $0$ $m/s^2$.", 
                acceptable: ["1"], 
                explanation: "Vận tốc $v(t) = s'(t) = 3t^2 - 6t + 4$.<br>Gia tốc $a(t) = v'(t) = 6t - 6$.<br>Gia tốc bằng 0 $\\Leftrightarrow 6t - 6 = 0 \\Leftrightarrow t = 1$.<br>Thay $t=1$ vào $v(t)$: $v(1) = 3(1)^2 - 6(1) + 4 = 1$ m/s." 
            },
            { 
                id: 'p3_q2', type: 'text', 
                question: "Người ta muốn thiết kế một chiếc cổng hình parabol (như hình vẽ) có chiều rộng chân cổng là 4m và chiều cao cổng là 4m. Để trang trí, người ta treo một bóng đèn tại tiêu điểm của parabol. Hỏi bóng đèn cách đỉnh cổng bao nhiêu mét?", 
                image: <ParabolPart3Q2 />,
                acceptable: ["0.25"], 
                explanation: "Gắn hệ trục tọa độ: Đỉnh parabol tại $I(0; 4)$. Chân cổng tại $A(-2; 0)$ và $B(2; 0)$ (vì rộng 4m).<br>Phương trình parabol có đỉnh $I(0; 4)$: $y = a x^2 + 4$.<br>Qua điểm $(2; 0) \\Rightarrow 0 = a(2^2) + 4 \\Rightarrow 4a = -4 \\Rightarrow a = -1$.<br>Vậy $y = -x^2 + 4$.<br>Đưa về dạng chính tắc để tìm tiêu điểm: $x^2 = -(y - 4)$ hay $x^2 = -1(y-4)$.<br>Dạng $X^2 = 4pY$ (với hệ trục dời về đỉnh). Ở đây $4p = 1 \\Rightarrow p = 1/4 = 0.25$.<br>Tiêu điểm F cách đỉnh một đoạn $p = 0.25$ (nằm phía dưới đỉnh).<br>Vậy bóng đèn cách đỉnh cổng 0.25 mét." 
            },
            { 
                id: 'p3_q3', type: 'text', 
                question: "Ông An gửi 100 triệu đồng vào ngân hàng theo thể thức lãi kép với lãi suất 6%/năm. Giả sử lãi suất không thay đổi, hỏi sau ít nhất bao nhiêu năm thì số tiền cả gốc và lãi của ông An vượt quá 150 triệu đồng?", 
                acceptable: ["7"], 
                explanation: "Công thức lãi kép: $A = P(1 + r)^n$.<br>$150 < 100(1 + 0.06)^n \\Leftrightarrow 1.5 < (1.06)^n$.<br>$n > \\log_{1.06}(1.5) \\approx 6.96$.<br>Vì n là số nguyên (năm) nên n = 7." 
            },
            { 
                id: 'p3_q4', type: 'text', 
                question: "Trong không gian $Oxyz$, cho hình hộp $ABCD.A'B'C'D'$ có $A(0;0;0)$, $B(3;0;0)$, $D(0;4;0)$, $A'(0;0;5)$. Tính khoảng cách từ điểm $A'$ đến mặt phẳng $(A B' D')$. (Làm tròn đến hàng phần mười).", 
                acceptable: ["2.2"], 
                explanation: "Hình hộp chữ nhật (do các tọa độ nằm trên trục).<br>$A(0;0;0)$, $B'(3;0;5)$, $D'(0;4;5)$.<br>Mặt phẳng $(A B' D')$ đi qua $A(0;0;0)$ và có cặp VTCP $\\vec{u_1} = \\vec{AB'} = (3;0;5)$, $\\vec{u_2} = \\vec{AD'} = (0;4;5)$.<br>VTPT $\\vec{n} = [\\vec{u_1}, \\vec{u_2}] = (-20; -15; 12)$.<br>Phương trình mp: $-20x - 15y + 12z = 0$.<br>Khoảng cách từ $A'(0;0;5)$ đến mp:<br>$d = \\frac{|-20(0) - 15(0) + 12(5)|}{\\sqrt{(-20)^2 + (-15)^2 + 12^2}} = \\frac{60}{\\sqrt{769}} \\approx 2.16$.<br>Làm tròn hàng phần mười: 2.2." 
            },
            { 
                id: 'p3_q5', type: 'text', 
                question: "Số lượng vi khuẩn trong một mẻ nuôi cấy tuân theo quy luật $N(t) = 500 \\cdot e^{0.2t}$, trong đó $t$ là thời gian tính bằng giờ. Tính tốc độ tăng trưởng tức thời của số lượng vi khuẩn tại thời điểm $t = 10$ giờ. (Làm tròn kết quả đến hàng đơn vị).", 
                acceptable: ["739"], 
                explanation: "Tốc độ tăng trưởng tức thời là đạo hàm $N'(t)$.<br>$N'(t) = 500 \\cdot 0.2 \\cdot e^{0.2t} = 100 \\cdot e^{0.2t}$.<br>Tại $t = 10$: $N'(10) = 100 \\cdot e^{2} \\approx 100 \\cdot 7.389 = 738.9$.<br>Làm tròn hàng đơn vị: 739." 
            },
            { 
                id: 'p3_q6', type: 'text', 
                question: "Một hộp chứa 5 quả cầu đỏ và 4 quả cầu xanh. Lấy ngẫu nhiên đồng thời 3 quả cầu. Tính xác suất để lấy được ít nhất 1 quả cầu đỏ. (Nhập kết quả dưới dạng số thập phân, làm tròn đến hàng phần trăm).", 
                acceptable: ["0.95"], 
                explanation: "Tổng số quả: 9. Chọn 3 quả: $C_9^3 = 84$ cách.<br>Dùng biến cố đối: 'Không lấy được quả đỏ nào' (tức là lấy 3 quả xanh).<br>Số quả xanh: 4. Số cách chọn 3 xanh: $C_4^3 = 4$.<br>P(toàn xanh) = $4/84 = 1/21$.<br>P(ít nhất 1 đỏ) = $1 - 1/21 = 20/21 \\approx 0.9523$.<br>Làm tròn hàng phần trăm: 0.95." 
            }
        ];
        
        // --- LOGIC TÍNH ĐIỂM ---
        const calculateScore = (currentQuestions, answers) => {
            let score = 0;
            let totalMaxScore = 0; 

            currentQuestions.forEach(q => {
                let questionMaxScore = 0;
                let questionScore = 0;

                if (q.type === 'mcq') {
                    questionMaxScore = 0.25; 
                    if (answers[q.id] === q.correct) questionScore = 0.25;
                } else if (q.type === 'text') {
                    questionMaxScore = 0.5; 
                    const userAns = (answers[q.id] || "").trim();
                    if (q.acceptable.includes(userAns)) questionScore = 0.5;
                } else if (q.type === 'group_tf') {
                    questionMaxScore = 1.0; 
                    let correctCount = 0;
                    const userGroupAns = answers[q.id] || {};
                    q.subQuestions.forEach(sub => {
                        if (userGroupAns[sub.id] === sub.correct) correctCount++;
                    });
                    if (correctCount === 1) questionScore = 0.1;
                    else if (correctCount === 2) questionScore = 0.25;
                    else if (correctCount === 3) questionScore = 0.5;
                    else if (correctCount === 4) questionScore = 1.0;
                }
                
                score += questionScore;
                totalMaxScore += questionMaxScore;
            });
            
            if (totalMaxScore > 0) {
                 const scaledScore = (score / totalMaxScore) * 10;
                 return Math.round(scaledScore * 100) / 100;
            }
            return 0;
        };
        
        // --- MÀN HÌNH CHÀO ---
        const WelcomeScreen = ({ onSelectMode }) => (
            <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-cyan-600 to-blue-800 p-4 text-white animate-fade-in">
                <div className="bg-white/10 backdrop-blur-md p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border border-white/20">
                    <h1 className="text-4xl font-bold mb-2">TRANDAIEDU</h1>
                    <h2 className="text-xl mb-8 text-cyan-100 font-medium">ĐỀ THI THỬ TỐT NGHIỆP THPT 2025</h2>
                    <h3 className="text-lg mb-4 text-white font-bold bg-blue-600/50 py-1 rounded">MÔN TOÁN - ĐỀ SỐ 01</h3>
                    <div className="space-y-4">
                        <button onClick={() => onSelectMode('student')} className="w-full py-4 bg-white text-blue-800 rounded-xl font-bold hover:bg-blue-50 transition-all shadow-lg flex items-center justify-center gap-2"><Icon name="user"/> Học Sinh Vào Thi</button>
                        <button onClick={() => onSelectMode('teacher')} className="w-full py-4 bg-blue-900/50 text-white rounded-xl font-bold hover:bg-blue-900 transition-all border border-blue-400/30 flex items-center justify-center gap-2"><Icon name="lock"/> Giáo Viên Xem Điểm</button>
                    </div>
                </div>
            </div>
        );

        // --- NHẬP TÊN ---
        const StudentNameInput = ({ onStart }) => {
            const [name, setName] = useState('');
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50 p-4 animate-fade-in">
                    <form onSubmit={(e) => { e.preventDefault(); if(name.trim()) onStart(name); }} className="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2 text-center">Nhập Thông Tin</h2>
                        <div className="mb-6">
                            <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500" placeholder="Họ và tên..." required />
                        </div>
                        <button type="submit" className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors">Bắt Đầu</button>
                    </form>
                </div>
            );
        };

        // --- HELPER: FORMAT TIME ---
        const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        // --- LÀM BÀI THI ---
        const QuizView = ({ studentName, questions, onSubmit }) => {
            const [answers, setAnswers] = useState({});
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            
            // State cho chức năng chống gian lận
            const [violationCount, setViolationCount] = useState(0);
            const [showWarning, setShowWarning] = useState(false);
            
            // State cho đồng hồ
            const [timeLeft, setTimeLeft] = useState(QUIZ_DURATION_MINUTES * 60);

            const answersRef = useRef(answers); // Dùng ref để lưu answers mới nhất cho event listener

            useEffect(() => { window.scrollTo(0, 0); }, []);
            
            // Cập nhật ref mỗi khi answers thay đổi
            useEffect(() => {
                answersRef.current = answers;
            }, [answers]);

            // Logic Đồng hồ đếm ngược
            useEffect(() => {
                const timer = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            clearInterval(timer);
                            // Hết giờ -> Tự động nộp
                            alert("HẾT GIỜ LÀM BÀI! HỆ THỐNG SẼ TỰ ĐỘNG NỘP BÀI.");
                            setIsSubmitting(true);
                            onSubmit(answersRef.current);
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(timer);
            }, [onSubmit]);

            // Logic phát hiện chuyển tab
            useEffect(() => {
                const handleVisibilityChange = () => {
                    if (document.hidden) {
                        // Người dùng rời tab
                        setViolationCount(prev => {
                            const newCount = prev + 1;
                            if (newCount >= 3) {
                                // Vi phạm quá 3 lần -> Tự động nộp
                                alert("BẠN ĐÃ VI PHẠM QUY CHẾ THI (RỜI MÀN HÌNH) QUÁ 3 LẦN. BÀI THI SẼ TỰ ĐỘNG NỘP.");
                                setIsSubmitting(true);
                                onSubmit(answersRef.current); // Nộp với đáp án hiện tại
                            }
                            return newCount;
                        });
                    } else {
                        // Người dùng quay lại
                        setViolationCount(prev => {
                            if (prev < 3 && prev > 0) {
                                setShowWarning(true);
                            }
                            return prev;
                        });
                    }
                };

                document.addEventListener("visibilitychange", handleVisibilityChange);
                return () => document.removeEventListener("visibilitychange", handleVisibilityChange);
            }, [onSubmit]);

            const handleMcqChange = (qId, optIdx) => setAnswers(prev => ({ ...prev, [qId]: optIdx }));
            const handleTfChange = (qId, subId, val) => setAnswers(prev => ({ ...prev, [qId]: { ...(prev[qId] || {}), [subId]: val } }));
            const handleTextChange = (qId, val) => setAnswers(prev => ({ ...prev, [qId]: val }));
            
            const handleConfirmSubmit = async () => {
                setShowConfirmModal(false);
                setIsSubmitting(true);
                onSubmit(answers);
            };

            // Style cho đồng hồ khi sắp hết giờ (< 5 phút)
            const isLowTime = timeLeft < 300; 

            return (
                <div className="min-h-screen bg-gray-100 pb-20 relative">
                    <div className="bg-white shadow-md p-4 sticky top-0 z-10 border-b border-gray-200">
                        <div className="max-w-4xl mx-auto flex flex-col md:flex-row justify-between items-center gap-3">
                            <div className="font-bold text-blue-700 flex items-center gap-2 w-full md:w-auto">
                                <Icon name="user" size={18}/> <span className="truncate">{studentName}</span>
                            </div>
                            
                            {/* Đồng hồ */}
                            <div className={`flex items-center gap-2 font-mono text-xl font-bold px-4 py-1 rounded-lg border ${isLowTime ? 'bg-red-50 text-red-600 border-red-200 animate-blink' : 'bg-gray-50 text-gray-700 border-gray-200'}`}>
                                <Icon name="clock" size={20} />
                                {formatTime(timeLeft)}
                            </div>

                            <div className="text-xs font-bold px-3 py-1 bg-red-100 text-red-600 rounded-full border border-red-200 w-full md:w-auto text-center">
                                Vi phạm: {violationCount}/3
                            </div>
                        </div>
                    </div>

                    <div className="max-w-3xl mx-auto p-4 space-y-8 mt-4 animate-fade-in">
                        {questions.map((q, idx) => (
                            <div key={q.id} className="bg-white rounded-xl shadow-sm p-6 transition-all hover:shadow-md">
                                <div className="mb-3">
                                    <span className={`inline-block text-xs font-bold px-2 py-1 rounded mb-2 ${q.type === 'mcq' ? 'bg-blue-100 text-blue-800' : q.type === 'group_tf' ? 'bg-purple-100 text-purple-800' : 'bg-orange-100 text-orange-800'}`}>
                                        {q.type === 'mcq' ? 'Phần 1: Trắc nghiệm' : q.type === 'group_tf' ? 'Phần 2: Đúng/Sai' : 'Phần 3: Trả lời ngắn'}
                                    </span>
                                    <div className="font-medium text-gray-800 flex gap-2">
                                        <span className="font-bold text-blue-600 whitespace-nowrap">Câu {idx + 1}:</span>
                                        <MathText text={q.question} />
                                    </div>
                                    {q.image && <div className="mt-3 flex justify-center">{q.image}</div>}
                                </div>
                                {q.type === 'mcq' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        {q.options.map((opt, optIdx) => (
                                            <button key={optIdx} onClick={() => handleMcqChange(q.id, optIdx)} className={`p-3 text-left rounded-lg border text-sm transition-all ${answers[q.id] === optIdx ? 'bg-blue-100 border-blue-500 text-blue-800 font-medium ring-1 ring-blue-500' : 'hover:bg-gray-50 border-gray-200'}`}>
                                                <span className="font-bold mr-2">{String.fromCharCode(65 + optIdx)}.</span><MathText text={opt} />
                                            </button>
                                        ))}
                                    </div>
                                )}
                                {q.type === 'group_tf' && (
                                    <div className="border rounded-lg overflow-hidden">
                                        <table className="w-full text-sm">
                                            <thead className="bg-gray-100"><tr><th className="p-3 text-left">Mệnh đề</th><th className="p-3 w-16 text-center">Đúng</th><th className="p-3 w-16 text-center">Sai</th></tr></thead>
                                            <tbody className="divide-y">
                                                {q.subQuestions.map(sub => {
                                                    const currentVal = (answers[q.id] || {})[sub.id];
                                                    return (
                                                        <tr key={sub.id} className="hover:bg-gray-50">
                                                            <td className="p-3"><MathText text={sub.text} /></td>
                                                            <td className="p-3 text-center"><input type="radio" name={`${q.id}-${sub.id}`} checked={currentVal === true} onChange={() => handleTfChange(q.id, sub.id, true)} className="w-5 h-5 cursor-pointer accent-blue-600"/></td>
                                                            <td className="p-3 text-center"><input type="radio" name={`${q.id}-${sub.id}`} checked={currentVal === false} onChange={() => handleTfChange(q.id, sub.id, false)} className="w-5 h-5 cursor-pointer accent-red-600"/></td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                                {q.type === 'text' && (
                                    <input type="text" value={answers[q.id] || ''} onChange={(e) => handleTextChange(q.id, e.target.value)} className="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nhập đáp án (số thập phân)..." />
                                )}
                            </div>
                        ))}
                        <div className="flex justify-center pt-6">
                            <button onClick={() => setShowConfirmModal(true)} disabled={isSubmitting} className={`px-8 py-4 text-white text-lg font-bold rounded-xl shadow-lg flex items-center gap-2 transition-all ${isSubmitting ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 transform hover:scale-105'}`}>
                                {isSubmitting ? <><Icon name="loader" className="animate-spin"/> ĐANG GỬI...</> : <><Icon name="save"/> NỘP BÀI</>}
                            </button>
                        </div>
                    </div>

                    {/* Modal Xác nhận nộp bài */}
                    {showConfirmModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                            <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center animate-fade-in">
                                <h3 className="text-lg font-bold text-gray-900 mb-2">Xác nhận nộp bài</h3>
                                <p className="text-sm text-gray-500 mb-6">Bạn có chắc chắn muốn nộp bài thi?</p>
                                <div className="flex gap-3 justify-center">
                                    <button onClick={() => setShowConfirmModal(false)} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition-colors">Hủy bỏ</button>
                                    <button onClick={handleConfirmSubmit} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-lg">Đồng ý nộp</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Cảnh báo gian lận */}
                    {showWarning && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-red-900/80 p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 text-center animate-pulse-red border-4 border-red-600">
                                <div className="flex justify-center mb-4 text-red-600">
                                    <Icon name="alert-triangle" size={64} />
                                </div>
                                <h3 className="text-2xl font-bold text-red-700 mb-2 uppercase">Cảnh báo gian lận!</h3>
                                <p className="text-gray-700 mb-4 font-medium">
                                    Hệ thống phát hiện bạn đã rời khỏi màn hình làm bài.
                                </p>
                                <div className="bg-red-50 p-4 rounded-lg border border-red-200 mb-6">
                                    <p className="text-red-800 font-bold text-lg">Số lần vi phạm: {violationCount}/3</p>
                                    <p className="text-xs text-red-600 mt-1">Nếu vi phạm 3 lần, bài thi sẽ tự động bị thu.</p>
                                </div>
                                <button onClick={() => setShowWarning(false)} className="w-full px-4 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition-colors shadow-lg">
                                    Tôi đã hiểu và tiếp tục làm bài
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- KẾT QUẢ & LỜI GIẢI ---
        const SolutionView = ({ questions, answers, score, onRetry }) => {
            const [openExplain, setOpenExplain] = useState({});
            const toggleExplain = (id) => setOpenExplain(prev => ({ ...prev, [id]: !prev[id] }));
            
            // Kiểm tra điều kiện điểm số
            const isPass = score >= 7.0;

            return (
                <div className="min-h-screen pb-20 animate-fade-in bg-gray-50">
                    <div className="bg-white shadow p-6 text-center mb-6">
                        <div className="flex justify-center mb-2">
                            {isPass ? <Icon name="trophy" size={56} className="text-yellow-500"/> : <Icon name="frown" size={56} className="text-gray-400"/>}
                        </div>
                        <h2 className="text-2xl font-bold text-gray-800">Kết Quả Bài Thi</h2>
                        <div className={`mt-4 inline-block px-6 py-3 rounded-xl border ${isPass ? 'bg-blue-50 border-blue-200' : 'bg-red-50 border-red-200'}`}>
                            <span className="text-gray-600 uppercase text-xs font-bold block">Tổng Điểm</span>
                            <span className={`text-4xl font-bold ${isPass ? 'text-blue-700' : 'text-red-600'}`}>{score.toFixed(2)}<span className="text-xl text-gray-500">/10</span></span>
                        </div>
                        {isPass ? (
                            <p className="mt-4 text-green-600 font-bold">Chúc mừng! Bạn đã đạt yêu cầu.</p>
                        ) : (
                            <p className="mt-4 text-red-600 font-bold">Bạn chưa đạt yêu cầu.</p>
                        )}
                    </div>

                    {/* Nếu không đạt điểm, hiển thị thông báo chặn xem lời giải */}
                    {!isPass && (
                        <div className="max-w-2xl mx-auto p-6 mb-8 bg-red-50 border border-red-200 rounded-xl text-center shadow-sm">
                            <div className="flex justify-center mb-3 text-red-500"><Icon name="lock" size={40}/></div>
                            <h3 className="text-xl font-bold text-red-700 mb-2">Chưa Đạt Yêu Cầu Xem Lời Giải</h3>
                            <p className="text-gray-700">
                                Bạn cần đạt tối thiểu <span className="font-bold text-red-700">7.0 điểm</span> để xem lời giải chi tiết.
                            </p>
                            <p className="text-gray-500 text-sm mt-2">Hãy ôn tập kỹ kiến thức và thử lại nhé!</p>
                        </div>
                    )}

                    {/* Chỉ hiển thị lời giải nếu đạt điểm */}
                    {isPass && (
                        <div className="max-w-3xl mx-auto p-4 space-y-6">
                            <h3 className="font-bold text-green-700 flex items-center gap-2 mb-4"><Icon name="check-circle" size={20}/> Chi Tiết Lời Giải</h3>
                            {questions.map((q, idx) => {
                                const isOpen = openExplain[q.id];
                                return (
                                    <div key={q.id} className="bg-white rounded-lg shadow-sm border-l-4 border-blue-400 overflow-hidden">
                                        <div className="p-4 cursor-pointer hover:bg-gray-50 transition-colors" onClick={() => toggleExplain(q.id)}>
                                            <div className="flex justify-between items-start">
                                                <div className="font-medium text-gray-800 flex-1 flex gap-2"><span className="font-bold whitespace-nowrap">Câu {idx + 1}:</span> <MathText text={q.question} /></div>
                                            </div>
                                            <div className="text-right text-xs text-blue-500 mt-2 font-medium flex items-center justify-end gap-1">{isOpen ? 'Thu gọn' : 'Xem chi tiết'} <Icon name={isOpen ? "chevron-up" : "chevron-down"} size={14}/></div>
                                        </div>
                                        {isOpen && (
                                            <div className="bg-blue-50 p-4 text-sm text-blue-900 border-t border-blue-100">
                                                {q.image && <div className="mb-4 flex justify-center">{q.image}</div>}
                                                <span className="font-bold block mb-1">💡 Lời giải chi tiết:</span>
                                                <MathText text={q.explanation} />
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    <div className="flex justify-center pt-6 pb-10">
                        <button onClick={onRetry} className="px-8 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 shadow-lg flex items-center gap-2 transform hover:scale-105 transition-all">
                            <Icon name="refresh-ccw"/> Làm lại đề mới
                        </button>
                    </div>
                </div>
            );
        };

        // --- GIÁO VIÊN ---
        const TeacherLogin = ({ onLogin, onBack }) => {
            const [pass, setPass] = useState('');
            const handleLogin = (e) => { e.preventDefault(); if (pass === '12345678T') onLogin(); };
            return ( <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4 animate-fade-in"> <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm"> <h2 className="text-xl font-bold mb-6 text-gray-800 text-center">Giáo Viên Đăng Nhập</h2> <form onSubmit={handleLogin} className="space-y-4"> <input type="password" value={pass} onChange={(e) => setPass(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Nhập mật khẩu..." autoFocus/> <button type="submit" className="w-full py-3 bg-blue-700 text-white rounded-lg font-bold hover:bg-blue-800">Truy cập</button> <button type="button" onClick={onBack} className="w-full py-2 text-gray-500 hover:text-gray-800 text-sm">Quay lại</button> </form> </div> </div> );
        };

        // Component Modal Chi Tiết Học Sinh - SỬ DỤNG PORTAL
        const StudentDetailModal = ({ result, onClose }) => {
            if (!result) return null;
            const answers = result.answers || {};

            // Sử dụng Portal để render modal ra ngoài root, tránh bị ảnh hưởng bởi CSS của cha
            return createPortal(
                <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col animate-fade-in">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                            <div>
                                <h3 className="text-lg font-bold text-gray-800">{result.name}</h3>
                                <p className="text-sm text-gray-500">Điểm: <span className="font-bold text-blue-600">{result.score?.toFixed(2)}</span> - {new Date(result.timestamp).toLocaleString('vi-VN')}</p>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-full"><Icon name="x" size={20}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto flex-1 space-y-6">
                            {QUESTION_BANK.map((q, idx) => {
                                let isCorrect = false;
                                let userAnsDisplay = "Chưa trả lời";
                                let correctAnsDisplay = "";

                                if (q.type === 'mcq') {
                                    const userIdx = answers[q.id];
                                    if (userIdx !== undefined) userAnsDisplay = String.fromCharCode(65 + userIdx);
                                    correctAnsDisplay = String.fromCharCode(65 + q.correct);
                                    isCorrect = userIdx === q.correct;
                                } else if (q.type === 'text') {
                                    const userVal = (answers[q.id] || "").trim();
                                    userAnsDisplay = userVal || "Trống";
                                    correctAnsDisplay = q.acceptable.join(" hoặc ");
                                    isCorrect = q.acceptable.includes(userVal);
                                } else if (q.type === 'group_tf') {
                                    const userGroup = answers[q.id] || {};
                                    let correctCount = 0;
                                    q.subQuestions.forEach(sub => {
                                        if (userGroup[sub.id] === sub.correct) correctCount++;
                                    });
                                    userAnsDisplay = `${correctCount}/4 ý đúng`;
                                    correctAnsDisplay = "4/4 ý đúng";
                                    isCorrect = correctCount === 4; 
                                }

                                return (
                                    <div key={q.id} className={`p-4 rounded-lg border ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                        <div className="flex gap-2 mb-2">
                                            <span className="font-bold text-gray-700">Câu {idx + 1}:</span>
                                            <div className="flex-1"><MathText text={q.question} /></div>
                                        </div>
                                        <div className="flex flex-col sm:flex-row gap-4 text-sm mt-2">
                                            <div className={`${isCorrect ? 'text-green-700' : 'text-red-700'} font-medium`}>
                                                Trả lời: {userAnsDisplay}
                                            </div>
                                            {!isCorrect && (
                                                <div className="text-gray-600">
                                                    Đáp án đúng: <span className="font-bold">{correctAnsDisplay}</span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="p-4 border-t bg-gray-50 rounded-b-xl text-right">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Đóng</button>
                        </div>
                    </div>
                </div>,
                document.body // Render trực tiếp vào body
            );
        };

        const TeacherDashboard = ({ onLogout }) => {
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedResult, setSelectedResult] = useState(null);

            useEffect(() => {
                if (!db) { setLoading(false); return; }
                const unsubscribe = db.collection(COLLECTION_NAME).orderBy('timestamp', 'desc').onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setResults(data);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // Xử lý xóa
            const handleDelete = async (id) => {
                if(confirm("Bạn có chắc chắn muốn xóa kết quả này?")) {
                    try {
                        await db.collection(COLLECTION_NAME).doc(id).delete();
                    } catch (e) { alert("Lỗi khi xóa: " + e.message); }
                }
            };

            // Xử lý xuất Excel (CSV đơn giản)
            const handleExport = () => {
                const header = "Thoi Gian,Ho Ten,Diem So\n";
                const rows = results.map(r => `${new Date(r.timestamp).toLocaleString('vi-VN').replace(/,/g, '')},${r.name},${r.score}`).join("\n");
                const blob = new Blob([header + rows], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "ket_qua_thi.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Filter
            const filteredResults = results.filter(r => r.name.toLowerCase().includes(searchTerm.toLowerCase()));

            // Stats
            const stats = useMemo(() => {
                const total = results.length;
                if (total === 0) return { avg: 0, pass: 0, excellent: 0 };
                const sum = results.reduce((acc, curr) => acc + (curr.score || 0), 0);
                const passCount = results.filter(r => r.score >= 5).length;
                const excCount = results.filter(r => r.score >= 8).length;
                return {
                    avg: (sum / total).toFixed(2),
                    pass: ((passCount / total) * 100).toFixed(1),
                    excellent: ((excCount / total) * 100).toFixed(1)
                };
            }, [results]);

            return (
                <div className="min-h-screen bg-gray-50 animate-fade-in pb-10">
                    {/* Header */}
                    <div className="bg-white shadow px-6 py-4 flex justify-between items-center sticky top-0 z-10">
                        <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2"><Icon name="layout-dashboard" className="text-blue-600"/> Bảng Điều Khiển Giáo Viên</h1>
                        <button onClick={onLogout} className="text-red-600 hover:bg-red-50 px-4 py-2 rounded-lg flex items-center gap-2 font-medium"><Icon name="log-out" size={18}/> Đăng xuất</button>
                    </div>

                    <div className="max-w-7xl mx-auto p-6 space-y-6">
                        {/* Stats Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-blue-100">
                                <div className="text-gray-500 text-sm font-medium">Tổng bài thi</div>
                                <div className="text-2xl font-bold text-blue-700">{results.length}</div>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-green-100">
                                <div className="text-gray-500 text-sm font-medium">Điểm trung bình</div>
                                <div className="text-2xl font-bold text-green-700">{stats.avg}</div>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-yellow-100">
                                <div className="text-gray-500 text-sm font-medium">Tỷ lệ đạt (>=5)</div>
                                <div className="text-2xl font-bold text-yellow-600">{stats.pass}%</div>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-purple-100">
                                <div className="text-gray-500 text-sm font-medium">Tỷ lệ giỏi (>=8)</div>
                                <div className="text-2xl font-bold text-purple-600">{stats.excellent}%</div>
                            </div>
                        </div>

                        {/* Toolbar */}
                        <div className="flex flex-col md:flex-row justify-between gap-4">
                            <div className="relative flex-1 max-w-md">
                                <Icon name="search" className="absolute left-3 top-3 text-gray-400" size={20}/>
                                <input 
                                    type="text" 
                                    placeholder="Tìm kiếm theo tên học sinh..." 
                                    className="w-full pl-10 pr-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <button onClick={handleExport} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2 font-medium shadow-sm">
                                <Icon name="download" size={18}/> Xuất Excel
                            </button>
                        </div>

                        {/* Table */}
                        <div className="bg-white rounded-xl shadow overflow-hidden border border-gray-200">
                            <div className="overflow-x-auto">
                                <table className="w-full whitespace-nowrap">
                                    <thead className="bg-gray-50 border-b">
                                        <tr>
                                            <th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Thời gian</th>
                                            <th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Họ và Tên</th>
                                            <th className="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Điểm Số</th>
                                            <th className="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Trạng thái</th>
                                            <th className="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Hành động</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {loading ? (
                                            <tr><td colSpan="5" className="p-8 text-center text-gray-500">Đang tải dữ liệu...</td></tr>
                                        ) : filteredResults.length === 0 ? (
                                            <tr><td colSpan="5" className="p-8 text-center text-gray-500">Không tìm thấy kết quả nào.</td></tr>
                                        ) : (
                                            filteredResults.map((res) => (
                                                <tr key={res.id} className="hover:bg-gray-50 transition-colors">
                                                    <td className="px-6 py-4 text-sm text-gray-500">{new Date(res.timestamp).toLocaleString('vi-VN')}</td>
                                                    <td className="px-6 py-4 font-medium text-gray-900">{res.name}</td>
                                                    <td className="px-6 py-4 text-center">
                                                        <span className={`inline-flex items-center justify-center px-3 py-1 rounded-full text-sm font-bold ${res.score >= 8 ? 'bg-green-100 text-green-800' : res.score >= 5 ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}`}>
                                                            {res.score?.toFixed(2)}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4 text-center text-sm">
                                                        {res.score >= 5 ? <span className="text-green-600 flex items-center justify-center gap-1"><Icon name="check" size={14}/> Đạt</span> : <span className="text-red-500 flex items-center justify-center gap-1"><Icon name="x" size={14}/> Trượt</span>}
                                                    </td>
                                                    <td className="px-6 py-4 text-right space-x-2">
                                                        <button onClick={() => setSelectedResult(res)} className="bg-blue-600 text-white hover:bg-blue-700 p-2 rounded-lg shadow-sm transition-colors" title="Xem chi tiết"><Icon name="eye" size={18}/></button>
                                                        <button onClick={() => handleDelete(res.id)} className="bg-red-600 text-white hover:bg-red-700 p-2 rounded-lg shadow-sm transition-colors" title="Xóa"><Icon name="trash-2" size={18}/></button>
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* Modal Chi Tiết */}
                    {selectedResult && <StudentDetailModal result={selectedResult} onClose={() => setSelectedResult(null)} />}
                </div>
            );
        };

        // --- APP CHÍNH ---
        const App = () => {
            const [view, setView] = useState('welcome');
            const [studentName, setStudentName] = useState('');
            const [currentQuestions, setCurrentQuestions] = useState([]);
            const [finalScore, setFinalScore] = useState(0);
            const [userAnswers, setUserAnswers] = useState({});

            useEffect(() => {
                if (auth) auth.signInAnonymously().catch(console.error);
            }, []);

            const startNewQuiz = (name) => {
                setStudentName(name);
                setCurrentQuestions(QUESTION_BANK); 
                setView('quiz');
            };

            const handleSubmitQuiz = async (answers) => {
                const score = calculateScore(currentQuestions, answers);
                setFinalScore(score);
                setUserAnswers(answers);
                
                if (db && auth && auth.currentUser) {
                    db.collection(COLLECTION_NAME).add({
                        name: studentName, 
                        score: score, 
                        answers: answers, 
                        timestamp: new Date().toISOString()
                    });
                }
                setView('result'); 
            };

            return (
                <div>
                    {view === 'welcome' && <WelcomeScreen onSelectMode={(mode) => setView(mode === 'student' ? 'name' : 'login')} />}
                    {view === 'name' && <StudentNameInput onStart={startNewQuiz} />}
                    {view === 'quiz' && <QuizView studentName={studentName} questions={currentQuestions} onSubmit={handleSubmitQuiz} />}
                    {view === 'result' && <SolutionView questions={currentQuestions} answers={userAnswers} score={finalScore} onRetry={() => startNewQuiz(studentName)} />}
                    {view === 'login' && <TeacherLogin onLogin={() => setView('teacher')} onBack={() => setView('welcome')} />}
                    {view === 'teacher' && <TeacherDashboard onLogout={() => setView('welcome')} />}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
