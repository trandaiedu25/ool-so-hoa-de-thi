<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRANDAIEDU - ƒê·ªÅ Thi H·ªçc K·ª≥ 1 To√°n 12</title>
    
    <!-- React & ReactDOM (UMD) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase (Compat version for simple HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .katex { font-size: 1.1em; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- C·∫§U H√åNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        let db = null;
        let auth = null;
        let isFirebaseReady = false;
        const appId = "math12_hk1"; // Unique ID for this specific quiz

        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE" && window.firebase) {
                const app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseReady = true;
                console.log("Firebase connected.");
            } else {
                console.warn("Ch·∫°y ch·∫ø ƒë·ªô Offline (ch∆∞a c·∫•u h√¨nh Firebase).");
            }
        } catch (e) {
            console.error("L·ªói Firebase:", e);
        }

        const COLLECTION_NAME = "quiz_results_math12_hk1";

        // --- ICONS ---
        const Icon = ({ name, size=24, className="" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                   const iconElement = window.lucide.icons[name];
                   if(iconElement) {
                       iconRef.current.innerHTML = iconElement.toSvg({ class: className, width: size, height: size });
                   }
                }
            }, [name, size, className]);
            return <span ref={iconRef} className={className} style={{display: 'inline-flex', alignItems: 'center'}}></span>;
        };

        // --- MATH RENDERER ---
        const MathText = ({ text, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && text && window.renderMathInElement) {
                    renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "$", right: "$", display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, [text]);
            return <span ref={containerRef} className={className} dangerouslySetInnerHTML={{__html: text}} />;
        };

        // --- SVG IMAGES (Converted from Text to React Components) ---
        
        const ImageQ1 = () => (
            <div className="flex justify-center my-4">
                <svg width="300" height="200" viewBox="0 0 300 200" className="bg-white border rounded">
                    <line x1="20" y1="180" x2="280" y2="180" stroke="black" strokeWidth="1.5"/>
                    <line x1="150" y1="20" x2="150" y2="190" stroke="black" strokeWidth="1.5"/>
                    <text x="270" y="175" fontSize="12">x</text>
                    <text x="155" y="30" fontSize="12">y</text>
                    <text x="140" y="195" fontSize="12">O</text>
                    <path d="M 50 190 Q 90 -20 150 50 T 250 190" stroke="blue" strokeWidth="2" fill="none" strokeDasharray="5,0"/>
                    <path d="M 70 180 C 110 180, 110 60, 150 60 S 190 140, 230 140 S 260 20, 260 20" stroke="blue" strokeWidth="2" fill="none" transform="translate(-40, 20)"/>
                    <line x1="110" y1="80" x2="110" y2="180" stroke="gray" strokeDasharray="4"/>
                    <text x="105" y="195" fontSize="12">-1</text>
                    <line x1="190" y1="160" x2="190" y2="180" stroke="gray" strokeDasharray="4"/>
                    <text x="185" y="195" fontSize="12">1</text>
                </svg>
            </div>
        );

        const ImageQ5 = () => (
            <div className="flex justify-center my-4">
                <svg width="300" height="200" viewBox="0 0 300 200" className="bg-white border rounded">
                    <defs>
                        <marker id="arrowQ5" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="red" />
                        </marker>
                    </defs>
                    <polygon points="50,150 150,150 200,100 100,100" fill="none" stroke="black" /> 
                    <polygon points="50,50 150,50 200,0 100,0" fill="none" stroke="black" transform="translate(0, 50)" /> 
                    <line x1="50" y1="150" x2="50" y2="100" stroke="black" /> 
                    <line x1="150" y1="150" x2="150" y2="100" stroke="black" /> 
                    <line x1="200" y1="100" x2="200" y2="50" stroke="black" /> 
                    <line x1="100" y1="100" x2="100" y2="50" stroke="black" strokeDasharray="4" /> 
                    <line x1="50" y1="150" x2="150" y2="150" stroke="red" strokeWidth="2" markerEnd="url(#arrowQ5)" /> 
                    <text x="40" y="165">A</text> <text x="160" y="165">B</text>
                    <text x="210" y="110">C</text> <text x="90" y="110">D</text>
                    <text x="40" y="100">A'</text> <text x="160" y="100">B'</text>
                    <text x="210" y="50">C'</text> <text x="90" y="50">D'</text>
                </svg>
            </div>
        );

        const ImageQ7 = () => (
            <div className="flex justify-center my-4">
                <svg width="200" height="200" viewBox="0 0 200 200" className="bg-white border rounded">
                    <rect x="50" y="80" width="80" height="80" fill="none" stroke="black"/> 
                    <polyline points="50,80 80,50 160,50 160,130 130,160" fill="none" stroke="black"/>
                    <line x1="130" y1="80" x2="160" y2="50" stroke="black"/>
                    <line x1="80" y1="50" x2="80" y2="130" stroke="black" strokeDasharray="4"/> 
                    <line x1="50" y1="160" x2="80" y2="130" stroke="black" strokeDasharray="4"/> 
                    <line x1="80" y1="130" x2="160" y2="130" stroke="black" strokeDasharray="4"/> 
                    <line x1="50" y1="160" x2="130" y2="160" stroke="red" strokeWidth="2"/> 
                    <line x1="80" y1="50" x2="160" y2="50" stroke="blue" strokeWidth="2"/> 
                </svg>
            </div>
        );

        const ImageQ11 = () => (
            <div className="flex justify-center my-4">
                <svg width="200" height="200" viewBox="0 0 200 200" className="bg-white border rounded">
                    <line x1="20" y1="100" x2="180" y2="100" stroke="black"/> 
                    <line x1="100" y1="20" x2="100" y2="180" stroke="black"/> 
                    <path d="M 95 180 Q 90 140 60 110" stroke="blue" fill="none"/> 
                    <path d="M 20 80 Q 80 80 90 20" stroke="blue" fill="none" />
                    <path d="M 110 180 Q 120 120 180 120" stroke="blue" fill="none" />
                    <line x1="95" y1="20" x2="95" y2="180" stroke="gray" strokeDasharray="2" /> 
                    <line x1="20" y1="95" x2="180" y2="95" stroke="gray" strokeDasharray="2" /> 
                </svg>
            </div>
        );

        const ImageTF1 = () => (
            <div className="flex justify-center my-4">
                <svg width="200" height="200" viewBox="0 0 200 200" className="bg-white border rounded">
                    <line x1="20" y1="100" x2="180" y2="100" stroke="black"/>
                    <line x1="100" y1="20" x2="100" y2="180" stroke="black"/>
                    <line x1="130" y1="20" x2="130" y2="180" stroke="red" strokeDasharray="4"/>
                    <text x="135" y="190" fontSize="10" fill="red">x=1</text>
                    <line x1="20" y1="70" x2="180" y2="70" stroke="red" strokeDasharray="4"/>
                    <text x="25" y="65" fontSize="10" fill="red">y=2</text>
                    <path d="M 20 85 Q 100 90 125 180" stroke="blue" fill="none"/>
                    <path d="M 135 20 Q 140 50 180 60" stroke="blue" fill="none"/>
                </svg>
            </div>
        );

        const ImageTF2 = () => (
            <div className="flex justify-center my-4">
                <svg width="200" height="200" viewBox="0 0 200 200" className="bg-white border rounded">
                    <line x1="100" y1="100" x2="180" y2="150" stroke="black"/> 
                    <line x1="100" y1="100" x2="20" y2="150" stroke="black"/> 
                    <line x1="100" y1="100" x2="100" y2="20" stroke="black"/> 
                    <text x="180" y="160">y</text> <text x="10" y="160">x</text> <text x="105" y="15">z</text>
                    <path d="M 60 130 L 150 130 L 100 40 Z" fill="none" stroke="blue"/> 
                    <line x1="100" y1="40" x2="130" y2="20" stroke="blue"/> 
                </svg>
            </div>
        );

        const ImageTF4 = () => (
            <div className="flex justify-center my-4">
                <svg width="200" height="250" viewBox="0 0 200 250" className="bg-white border rounded">
                    <rect x="50" y="100" width="100" height="120" fill="none" stroke="black"/>
                    <path d="M 50 100 A 50 50 0 0 1 150 100" fill="none" stroke="black"/>
                    <text x="40" y="230">D</text> <text x="160" y="230">C</text>
                    <text x="40" y="100">A</text> <text x="160" y="100">B</text>
                </svg>
            </div>
        );

        const ImageShort3 = () => (
            <div className="flex justify-center my-4">
                <svg width="200" height="200" viewBox="0 0 200 200" className="bg-white border rounded">
                    <defs>
                        <marker id="arrowShort3" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="black" />
                        </marker>
                    </defs>
                    <line x1="100" y1="100" x2="160" y2="100" stroke="black" strokeWidth="2" markerEnd="url(#arrowShort3)"/> <text x="165" y="100">b</text>
                    <line x1="100" y1="100" x2="140" y2="60" stroke="black" strokeWidth="2" markerEnd="url(#arrowShort3)"/> <text x="145" y="60">a</text>
                    <text x="90" y="110">O</text>
                </svg>
            </div>
        );

        const ImageShort4 = () => (
            <div className="flex justify-center my-4">
                <svg width="300" height="200" viewBox="0 0 300 200" className="bg-white border rounded">
                    <line x1="30" y1="180" x2="280" y2="180" stroke="black"/> <line x1="30" y1="20" x2="30" y2="180" stroke="black"/> <text x="270" y="170">v</text>
                    <text x="40" y="30">C</text>
                    <path d="M 40 20 Q 80 150 150 150 T 260 20" stroke="green" fill="none"/>
                    <text x="140" y="170">vmin</text>
                </svg>
            </div>
        );

        const ImageShort6 = () => (
            <div className="flex justify-center my-4">
                <svg width="200" height="300" viewBox="0 0 200 300" className="bg-white border rounded">
                    <polygon points="50,250 150,250 100,200" fill="none" stroke="black"/> <polygon points="50,100 150,100 100,50" fill="none" stroke="black"/> <line x1="50" y1="250" x2="50" y2="100" stroke="black"/>
                    <line x1="150" y1="250" x2="150" y2="100" stroke="black"/>
                    <line x1="100" y1="200" x2="100" y2="50" stroke="black" strokeDasharray="4"/> <line x1="50" y1="250" x2="150" y2="250" stroke="black"/> <circle cx="100" cy="250" r="2" fill="red"/> <text x="100" y="270">M</text>
                    <circle cx="100" cy="50" r="2" fill="red"/> <text x="100" y="40">A'</text>
                    <line x1="100" y1="50" x2="100" y2="250" stroke="red" strokeDasharray="4"/> <line x1="100" y1="200" x2="100" y2="250" stroke="black" strokeDasharray="4"/> 
                </svg>
            </div>
        );

        // --- QUESTION BANK (NEW CONTENT) ---
        const QUESTION_BANK = [
            // --- PH·∫¶N 1: TR·∫ÆC NGHI·ªÜM (12 c√¢u) ---
            { 
                id: 'p1_q1', type: 'mcq', 
                question: "Cho h√†m s·ªë $y=f(x)$ c√≥ ƒë·ªì th·ªã nh∆∞ h√¨nh v·∫Ω b√™n d∆∞·ªõi. H√†m s·ªë ƒë√£ cho ƒë·ªìng bi·∫øn tr√™n kho·∫£ng n√†o d∆∞·ªõi ƒë√¢y?", 
                options: ["$(-\\infty; -1)$", "$(-1; 1)$", "$(1; +\\infty)$", "$(0; 1)$"], 
                correct: 2, 
                image: <ImageQ1 />,
                explanation: "Quan s√°t h√¨nh v·∫Ω, ƒë·ªì th·ªã ƒëi l√™n trong kho·∫£ng $(-\\infty; -1)$ v√† $(1; +\\infty)$. Trong c√°c ƒë√°p √°n, kho·∫£ng $(1; +\\infty)$ l√† ƒë√°p √°n ƒë√∫ng." 
            },
            { 
                id: 'p1_q2', type: 'mcq', 
                question: "Gi√° tr·ªã c·ª±c ƒë·∫°i c·ªßa h√†m s·ªë $y = x^3 - 3x + 2$ l√†:", 
                options: ["4", "0", "2", "-2"], 
                correct: 0, 
                explanation: "$y' = 3x^2 - 3$. $y'=0 \\Leftrightarrow x=\\pm 1$. T·∫°i $x=-1$, $y=4$ (Cƒê). T·∫°i $x=1$, $y=0$ (CT). Gi√° tr·ªã c·ª±c ƒë·∫°i l√† 4." 
            },
            { 
                id: 'p1_q3', type: 'mcq', 
                question: "Ti·ªám c·∫≠n xi√™n c·ªßa ƒë·ªì th·ªã h√†m s·ªë $y = 2x - 1 + \\frac{3}{x+1}$ l√† ƒë∆∞·ªùng th·∫≥ng:", 
                options: ["$y = 2x$", "$y = 2x - 1$", "$x = -1$", "$y = 2x + 2$"], 
                correct: 1, 
                explanation: "Ta c√≥ $\\lim_{x \\to \\infty} [y - (2x-1)] = 0$. V·∫≠y ti·ªám c·∫≠n xi√™n l√† $y = 2x - 1$." 
            },
            { 
                id: 'p1_q4', type: 'mcq', 
                question: "Trong kh√¥ng gian v·ªõi h·ªá t·ªça ƒë·ªô Oxyz, cho $\\vec{a} = (2; -3; 1)$ v√† $\\vec{b} = (-1; 0; 4)$. T·ªça ƒë·ªô c·ªßa vect∆° $\\vec{u} = \\vec{a} - 2\\vec{b}$ l√†:", 
                options: ["$(4; -3; -7)$", "$(0; -3; 9)$", "$(4; -3; 9)$", "$(0; -3; -7)$"], 
                correct: 0, 
                explanation: "$\\vec{u} = (2 - 2(-1); -3 - 2(0); 1 - 2(4)) = (4; -3; -7)$." 
            },
            { 
                id: 'p1_q5', type: 'mcq', 
                question: "Cho h√¨nh h·ªôp ch·ªØ nh·∫≠t $ABCD.A'B'C'D'$ nh∆∞ h√¨nh v·∫Ω. Vect∆° n√†o d∆∞·ªõi ƒë√¢y b·∫±ng vect∆° $\\vec{AB}$?", 
                options: ["$\\vec{DC}$", "$\\vec{BA}$", "$\\vec{A'C'}$", "$\\vec{AD}$"], 
                correct: 0, 
                image: <ImageQ5 />,
                explanation: "Trong h√¨nh h·ªôp ch·ªØ nh·∫≠t, $\\vec{AB} = \\vec{DC}$." 
            },
            { 
                id: 'p1_q6', type: 'mcq', 
                question: "Cho m·∫´u s·ªë li·ªáu gh√©p nh√≥m v·ªÅ th·ªùi gian t·∫≠p th·ªÉ d·ª•c: Nh√≥m [0;20): 5, [20;40): 12, [40;60): 8, [60;80): 3. Nh√≥m ch·ª©a m·ªët c·ªßa m·∫´u s·ªë li·ªáu l√†:", 
                options: ["$[0; 20)$", "$[20; 40)$", "$[40; 60)$", "$[60; 80)$"], 
                correct: 1, 
                explanation: "T·∫ßn s·ªë l·ªõn nh·∫•t l√† 12, t∆∞∆°ng ·ª©ng v·ªõi nh√≥m $[20; 40)$." 
            },
            { 
                id: 'p1_q7', type: 'mcq', 
                question: "Cho h√¨nh l·∫≠p ph∆∞∆°ng $ABCD.A'B'C'D'$. G√≥c gi·ªØa hai vect∆° $\\vec{AB}$ v√† $\\vec{A'D'}$ b·∫±ng:", 
                options: ["$45^\\circ$", "$90^\\circ$", "$60^\\circ$", "$180^\\circ$"], 
                correct: 1, 
                image: <ImageQ7 />,
                explanation: "$\\vec{A'D'} = \\vec{AD}$. G√≥c $(\\vec{AB}, \\vec{A'D'}) = (\\vec{AB}, \\vec{AD}) = 90^\\circ$ (do ABCD l√† h√¨nh vu√¥ng)." 
            },
            { 
                id: 'p1_q8', type: 'mcq', 
                question: "T√¨m gi√° tr·ªã nh·ªè nh·∫•t $m$ c·ªßa h√†m s·ªë $y = x + \\frac{4}{x}$ tr√™n kho·∫£ng $(0; +\\infty)$.", 
                options: ["$m = 2$", "$m = 4$", "$m = -4$", "$m = 5$"], 
                correct: 1, 
                explanation: "√Åp d·ª•ng BƒêT Cauchy: $x + \\frac{4}{x} \\ge 2\\sqrt{4} = 4$. D·∫•u b·∫±ng khi $x=2$." 
            },
            { 
                id: 'p1_q9', type: 'mcq', 
                question: "Trong kh√¥ng gian Oxyz, cho ƒëi·ªÉm $M(1; -2; 3)$. H√¨nh chi·∫øu vu√¥ng g√≥c c·ªßa M l√™n tr·ª•c Oz c√≥ t·ªça ƒë·ªô l√†:", 
                options: ["$(1; -2; 0)$", "$(1; 0; 3)$", "$(0; 0; 3)$", "$(0; -2; 0)$"], 
                correct: 2, 
                explanation: "H√¨nh chi·∫øu l√™n Oz gi·ªØ nguy√™n z, x=0, y=0. V·∫≠y l√† $(0; 0; 3)$." 
            },
            { 
                id: 'p1_q10', type: 'mcq', 
                question: "Cho hai vect∆° $\\vec{u} = (1; 1; -2)$ v√† $\\vec{v} = (1; 0; m)$. ƒê·ªÉ $\\vec{u} \\perp \\vec{v}$ th√¨ gi√° tr·ªã c·ªßa m l√†:", 
                options: ["$m = 1/2$", "$m = 0$", "$m = 2$", "$m = 1$"], 
                correct: 0, 
                explanation: "$\\vec{u} \\cdot \\vec{v} = 1 + 0 - 2m = 0 \\Leftrightarrow m = 1/2$." 
            },
            { 
                id: 'p1_q11', type: 'mcq', 
                question: "ƒê∆∞·ªùng cong trong h√¨nh b√™n l√† ƒë·ªì th·ªã c·ªßa h√†m s·ªë n√†o?", 
                options: ["$y = \\frac{x-1}{x+1}$", "$y = \\frac{x}{x+1}$", "$y = \\frac{x+1}{x-1}$", "$y = \\frac{2x}{x+1}$"], 
                correct: 1, 
                image: <ImageQ11 />,
                explanation: "ƒê·ªì th·ªã ƒëi qua g·ªëc t·ªça ƒë·ªô O(0;0). Ch·ªâ c√≥ ƒë√°p √°n B th·ªèa m√£n $y(0)=0$." 
            },
            { 
                id: 'p1_q12', type: 'mcq', 
                question: "Kho·∫£ng t·ª© ph√¢n v·ªã $\\Delta_Q$ c·ªßa m·∫´u s·ªë li·ªáu l√†:", 
                options: ["$Q_3 + Q_1$", "$Q_3 - Q_1$", "$(Q_3 - Q_1)/2$", "$Q_2 - Q_1$"], 
                correct: 1, 
                explanation: "Kho·∫£ng t·ª© ph√¢n v·ªã l√† hi·ªáu s·ªë gi·ªØa t·ª© ph√¢n v·ªã th·ª© ba v√† th·ª© nh·∫•t: $\\Delta_Q = Q_3 - Q_1$." 
            },

            // --- PH·∫¶N 2: ƒê√öNG SAI (4 c√¢u) ---
            {
                id: 'p2_q1', type: 'group_tf',
                question: "Cho h√†m s·ªë $y = f(x) = \\frac{2x-1}{x-1}$ c√≥ ƒë·ªì th·ªã (C).",
                image: <ImageTF1 />,
                subQuestions: [
                    { id: 'a', text: "H√†m s·ªë ngh·ªãch bi·∫øn tr√™n t·ª´ng kho·∫£ng x√°c ƒë·ªãnh.", correct: true },
                    { id: 'b', text: "ƒê·ªì th·ªã h√†m s·ªë c√≥ ti·ªám c·∫≠n ƒë·ª©ng l√† ƒë∆∞·ªùng th·∫≥ng $x=2$.", correct: false },
                    { id: 'c', text: "ƒê·ªì th·ªã h√†m s·ªë c·∫Øt tr·ª•c tung t·∫°i ƒëi·ªÉm c√≥ tung ƒë·ªô b·∫±ng 1.", correct: true },
                    { id: 'd', text: "T√¢m ƒë·ªëi x·ª©ng c·ªßa ƒë·ªì th·ªã l√† ƒëi·ªÉm $I(1; 2)$.", correct: true }
                ],
                explanation: "a) ƒê√∫ng ($y'<0$). b) Sai (TCƒê $x=1$). c) ƒê√∫ng ($x=0 \\Rightarrow y=1$). d) ƒê√∫ng (Giao 2 ti·ªám c·∫≠n)."
            },
            {
                id: 'p2_q2', type: 'group_tf',
                question: "Trong kh√¥ng gian Oxyz, cho $A(1;0;0), B(0;2;0), C(0;0;3), D(1;2;3)$.",
                image: <ImageTF2 />,
                subQuestions: [
                    { id: 'a', text: "Vect∆° $\\vec{AB} = (-1; 2; 0)$.", correct: true },
                    { id: 'b', text: "Ba ƒëi·ªÉm A, B, C c√πng n·∫±m tr√™n m·∫∑t ph·∫≥ng (Oxy).", correct: false },
                    { id: 'c', text: "Tr·ªçng t√¢m G c·ªßa tam gi√°c ABC l√† $G(\\frac{1}{3}; \\frac{2}{3}; 1)$.", correct: true },
                    { id: 'd', text: "ƒê·ªô d√†i ƒëo·∫°n th·∫≥ng $OD = \\sqrt{14}$.", correct: true }
                ],
                explanation: "a) ƒê√∫ng. b) Sai (C thu·ªôc Oz). c) ƒê√∫ng. d) ƒê√∫ng ($1^2+2^2+3^2=14$)."
            },
            {
                id: 'p2_q3', type: 'group_tf',
                question: "Cho m·∫´u s·ªë li·ªáu doanh thu: [10;12): 4, [12;14): 8, [14;16): 6, [16;18): 2.",
                subQuestions: [
                    { id: 'a', text: "S·ªë chi nh√°nh c√≥ doanh thu d∆∞·ªõi 14 t·ª∑ ƒë·ªìng l√† 8.", correct: false },
                    { id: 'b', text: "Nh√≥m ch·ª©a trung v·ªã l√† nh√≥m $[12; 14)$.", correct: true },
                    { id: 'c', text: "Gi√° tr·ªã ƒë·∫°i di·ªán c·ªßa nh√≥m $[14; 16)$ l√† 15.", correct: true },
                    { id: 'd', text: "Doanh thu trung b√¨nh x·∫•p x·ªâ 13,8 t·ª∑ ƒë·ªìng.", correct: false }
                ],
                explanation: "a) Sai (4+8=12). b) ƒê√∫ng (V·ªã tr√≠ 10,11 thu·ªôc nh√≥m 2). c) ƒê√∫ng. d) Sai (TB = 13.6)."
            },
            {
                id: 'p2_q4', type: 'group_tf',
                question: "Khung c·ª≠a s·ªï h√¨nh ch·ªØ nh·∫≠t ABCD v√† h√¨nh b√°n nguy·ªát ƒë∆∞·ªùng k√≠nh AB. Chu vi 4m.",
                image: <ImageTF4 />,
                subQuestions: [
                    { id: 'a', text: "Chi·ªÅu r·ªông AB c·ªßa h√¨nh ch·ªØ nh·∫≠t l√† $2R$.", correct: true },
                    { id: 'b', text: "Chi·ªÅu cao AD bi·ªÉu di·ªÖn theo R l√† $2 - R(2 + \\frac{\\pi}{2})$.", correct: false },
                    { id: 'c', text: "Di·ªán t√≠ch S ƒë∆∞·ª£c t√≠nh b·∫±ng $S = 4R - R^2(4 + \\frac{\\pi}{2})$.", correct: false },
                    { id: 'd', text: "B√°n k√≠nh R ƒë·ªÉ di·ªán t√≠ch l·ªõn nh·∫•t x·∫•p x·ªâ 0,56 m√©t.", correct: true }
                ],
                explanation: "a) ƒê√∫ng. b) Sai (CT sai h·ªá s·ªë). c) Sai. d) ƒê√∫ng ($R \\approx 0.56$)."
            },

            // --- PH·∫¶N 3: TR·∫¢ L·ªúI NG·∫ÆN (6 c√¢u) ---
            { 
                id: 'p3_q1', type: 'text', 
                question: "T√¨m gi√° tr·ªã nh·ªè nh·∫•t c·ªßa h√†m s·ªë $f(x) = x^3 - 3x + 1$ tr√™n ƒëo·∫°n $[0; 2]$.", 
                acceptable: ["-1"], 
                explanation: "Min t·∫°i $x=1$, $f(1) = -1$." 
            },
            { 
                id: 'p3_q2', type: 'text', 
                question: "M·ªôt ch·∫•t ƒëi·ªÉm chuy·ªÉn ƒë·ªông $S(t) = t^3 - 3t^2 + 2t + 1$. T√≠nh v·∫≠n t·ªëc (m/s) t·∫°i th·ªùi ƒëi·ªÉm gia t·ªëc b·∫±ng 0.", 
                acceptable: ["-1"], 
                explanation: "$a(t)=0 \\Rightarrow t=1$. $v(1) = -1$." 
            },
            { 
                id: 'p3_q3', type: 'text', 
                question: "Cho $\\vec{a} = (1; 0; -1)$ v√† $\\vec{b} = (0; 1; 1)$. T√≠nh cosin c·ªßa g√≥c gi·ªØa hai vect∆°.", 
                acceptable: ["-0.5", "-0,5"], 
                image: <ImageShort3 />,
                explanation: "$\\cos = \\frac{-1}{\\sqrt{2}\\sqrt{2}} = -0.5$." 
            },
            { 
                id: 'p3_q4', type: 'text', 
                question: "Chi ph√≠ $C(v) = \\frac{1600}{v} + \\frac{v}{4}$. V·∫≠n t·ªëc (km/h) ƒë·ªÉ chi ph√≠ th·∫•p nh·∫•t l√† bao nhi√™u?", 
                acceptable: ["80"], 
                image: <ImageShort4 />,
                explanation: "Cauchy: $v=80$." 
            },
            { 
                id: 'p3_q5', type: 'text', 
                question: "H√¨nh b√¨nh h√†nh ABCD c√≥ $A(1; 1; 1), B(2; 3; 4), C(6; 5; 2)$. T√¨m cao ƒë·ªô c·ªßa ƒë·ªânh D.", 
                acceptable: ["-1"], 
                explanation: "$\\vec{AD} = \\vec{BC} \\Rightarrow z-1 = 2-4 \\Rightarrow z=-1$." 
            },
            { 
                id: 'p3_q6', type: 'text', 
                question: "LƒÉng tr·ª• ƒë·ªÅu ABC.A'B'C' c·∫°nh ƒë√°y 2, c·∫°nh b√™n 4. M l√† trung ƒëi·ªÉm BC. T√≠nh A'M (l√†m tr√≤n 2 ch·ªØ s·ªë th·∫≠p ph√¢n).", 
                acceptable: ["4.36", "4,36"], 
                image: <ImageShort6 />,
                explanation: "$AM=\\sqrt{3}, AA'=4 \\Rightarrow A'M = \\sqrt{16+3} = \\sqrt{19} \\approx 4.36$." 
            }
        ];
        
        // --- LOGIC H√ÄM ---
        const PASSING_SCORE = 5.0; // Thang ƒëi·ªÉm 10, trung b√¨nh l√† 5
        
        const generateRandomQuiz = () => {
             // ƒê·ªÅ thi n√†y c·ªë ƒë·ªãnh 22 c√¢u, kh√¥ng c·∫ßn random t·ª´ pool l·ªõn
             // S·∫Øp x·∫øp theo th·ª© t·ª± Ph·∫ßn 1 -> Ph·∫ßn 2 -> Ph·∫ßn 3
             const p1 = QUESTION_BANK.filter(q => q.type === 'mcq');
             const p2 = QUESTION_BANK.filter(q => q.type === 'group_tf');
             const p3 = QUESTION_BANK.filter(q => q.type === 'text');
             return [...p1, ...p2, ...p3];
        };

        const calculateScore = (currentQuestions, answers) => {
            let score = 0;
            // C·∫•u tr√∫c ƒëi·ªÉm:
            // Ph·∫ßn 1: 12 c√¢u, m·ªói c√¢u 0.25ƒë -> 3.0ƒë
            // Ph·∫ßn 2: 4 c√¢u, m·ªói c√¢u 1.0ƒë -> 4.0ƒë (Quy t·∫Øc: 1 √Ω 0.1, 2 √Ω 0.25, 3 √Ω 0.5, 4 √Ω 1.0)
            // Ph·∫ßn 3: 6 c√¢u, m·ªói c√¢u 0.5ƒë -> 3.0ƒë
            // T·ªïng: 10ƒë

            currentQuestions.forEach(q => {
                if (q.type === 'mcq') {
                    if (answers[q.id] === q.correct) score += 0.25;
                } else if (q.type === 'text') {
                    const userAns = (answers[q.id] || "").trim().replace(',', '.'); // Normalize decimal
                    const acceptables = q.acceptable.map(a => a.replace(',', '.'));
                    if (acceptables.includes(userAns)) score += 0.5;
                } else if (q.type === 'group_tf') {
                    let correctCount = 0;
                    const userGroupAns = answers[q.id] || {};
                    q.subQuestions.forEach(sub => {
                        if (userGroupAns[sub.id] === sub.correct) correctCount++;
                    });
                    if (correctCount === 1) score += 0.1;
                    else if (correctCount === 2) score += 0.25;
                    else if (correctCount === 3) score += 0.5;
                    else if (correctCount === 4) score += 1.0;
                }
            });
            
            return Math.round(score * 100) / 100;
        };
        
        // --- COMPONENTS (Gi·ªØ nguy√™n c·∫•u tr√∫c c≈©) ---
        
        const WelcomeScreen = ({ onSelectMode, isOnline }) => (
            <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-cyan-600 to-blue-800 p-4 text-white">
                <div className="bg-white/10 backdrop-blur-md p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border border-white/20">
                    <h1 className="text-4xl font-bold mb-2">TRANDAIEDU</h1>
                    <h2 className="text-xl mb-8 text-cyan-100 font-medium">ƒê·ªÄ THI H·ªåC K·ª≤ 1 TO√ÅN 12</h2>
                    {!isOnline && (<div className="mb-6 bg-yellow-500/20 text-yellow-200 p-3 rounded-lg text-sm border border-yellow-500/50 flex items-center justify-center gap-2"><Icon name="alert-triangle" size={16}/> Ch·∫ø ƒë·ªô Offline: K·∫øt qu·∫£ s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u.</div>)}
                    <div className="space-y-4">
                        <button onClick={() => onSelectMode('student')} className="w-full py-4 bg-white text-blue-800 rounded-xl font-bold hover:bg-blue-50 transition-all shadow-lg flex items-center justify-center gap-2"><Icon name="user"/> H·ªçc Sinh V√†o Thi</button>
                        <button onClick={() => onSelectMode('teacher')} className="w-full py-4 bg-blue-900/50 text-white rounded-xl font-bold hover:bg-blue-900 transition-all border border-blue-400/30 flex items-center justify-center gap-2"><Icon name="lock"/> Gi√°o Vi√™n Xem ƒêi·ªÉm</button>
                    </div>
                </div>
            </div>
        );

        const StudentNameInput = ({ onStart }) => {
            const [name, setName] = useState('');
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50 p-4">
                    <form onSubmit={(e) => { e.preventDefault(); if(name.trim()) onStart(name); }} className="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2 text-center">Nh·∫≠p Th√¥ng Tin</h2>
                        <div className="mb-6">
                            <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500" placeholder="H·ªç v√† t√™n..." required />
                            <p className="text-xs text-green-600 mt-2 flex items-center gap-1"><Icon name="check" size={12}/> Ch·∫ø ƒë·ªô: H·ªçc sinh (Kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p)</p>
                        </div>
                        <button type="submit" className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors">B·∫Øt ƒê·∫ßu</button>
                    </form>
                </div>
            );
        };

        const QuizView = ({ studentName, questions, onSubmit, isConnected }) => {
            const [answers, setAnswers] = useState({});
            const [isSubmitting, setIsSubmitting] = useState(false);
            useEffect(() => { window.scrollTo(0, 0); }, []);
            const handleMcqChange = (qId, optIdx) => setAnswers(prev => ({ ...prev, [qId]: optIdx }));
            const handleTfChange = (qId, subId, val) => setAnswers(prev => ({ ...prev, [qId]: { ...(prev[qId] || {}), [subId]: val } }));
            const handleTextChange = (qId, val) => setAnswers(prev => ({ ...prev, [qId]: val }));
            const handleConfirmSubmit = async () => {
                if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?")) {
                    setIsSubmitting(true);
                    try { await onSubmit(answers); } catch (error) { setIsSubmitting(false); }
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 pb-20 relative">
                    <div className="bg-white shadow-md p-4 sticky top-0 z-10 border-b border-gray-200">
                        <div className="max-w-3xl mx-auto flex justify-between items-center">
                            <div className="font-bold text-blue-700 flex items-center gap-2"><Icon name="user" size={18}/> {studentName}</div>
                            <div className="flex items-center gap-3">
                                {isConnected ? <span className="flex items-center gap-1 text-xs text-green-600 font-bold bg-green-50 px-2 py-1 rounded-full border border-green-200"><Icon name="wifi" size={14}/> Online</span> : <span className="flex items-center gap-1 text-xs text-red-600 font-bold bg-red-50 px-2 py-1 rounded-full border border-red-200 animate-pulse"><Icon name="wifi-off" size={14}/> Offline</span>}
                            </div>
                        </div>
                    </div>
                    <div className="max-w-3xl mx-auto p-4 space-y-8 mt-4">
                        {questions.map((q, idx) => (
                            <div key={q.id} className="bg-white rounded-xl shadow-sm p-6">
                                <div className="mb-3">
                                    <span className={`inline-block text-xs font-bold px-2 py-1 rounded mb-2 ${q.type === 'mcq' ? 'bg-blue-100 text-blue-800' : q.type === 'group_tf' ? 'bg-purple-100 text-purple-800' : 'bg-orange-100 text-orange-800'}`}>
                                        {q.type === 'mcq' ? 'Ph·∫ßn 1: Tr·∫Øc nghi·ªám' : q.type === 'group_tf' ? 'Ph·∫ßn 2: ƒê√∫ng/Sai' : 'Ph·∫ßn 3: Tr·∫£ l·ªùi ng·∫Øn'}
                                    </span>
                                    <div className="font-medium text-gray-800 flex gap-2">
                                        <span className="font-bold text-blue-600 whitespace-nowrap">C√¢u {idx + 1}:</span>
                                        <MathText text={q.question} />
                                    </div>
                                    {q.image && <div className="mt-3 flex justify-center">{q.image}</div>}
                                </div>
                                {q.type === 'mcq' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        {q.options.map((opt, optIdx) => (
                                            <button key={optIdx} onClick={() => handleMcqChange(q.id, optIdx)} className={`p-3 text-left rounded-lg border text-sm transition-all ${answers[q.id] === optIdx ? 'bg-blue-100 border-blue-500 text-blue-800 font-medium ring-1 ring-blue-500' : 'hover:bg-gray-50 border-gray-200'}`}>
                                                <span className="font-bold mr-2">{String.fromCharCode(65 + optIdx)}.</span><MathText text={opt} />
                                            </button>
                                        ))}
                                    </div>
                                )}
                                {q.type === 'group_tf' && (
                                    <div className="border rounded-lg overflow-hidden">
                                        <table className="w-full text-sm">
                                            <thead className="bg-gray-100"><tr><th className="p-3 text-left">M·ªánh ƒë·ªÅ</th><th className="p-3 w-16 text-center">ƒê√∫ng</th><th className="p-3 w-16 text-center">Sai</th></tr></thead>
                                            <tbody className="divide-y">
                                                {q.subQuestions.map(sub => {
                                                    const currentVal = (answers[q.id] || {})[sub.id];
                                                    return (
                                                        <tr key={sub.id} className="hover:bg-gray-50">
                                                            <td className="p-3"><MathText text={sub.text} /></td>
                                                            <td className="p-3 text-center"><input type="radio" name={`${q.id}-${sub.id}`} checked={currentVal === true} onChange={() => handleTfChange(q.id, sub.id, true)} className="w-5 h-5 cursor-pointer accent-blue-600"/></td>
                                                            <td className="p-3 text-center"><input type="radio" name={`${q.id}-${sub.id}`} checked={currentVal === false} onChange={() => handleTfChange(q.id, sub.id, false)} className="w-5 h-5 cursor-pointer accent-red-600"/></td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                                {q.type === 'text' && (
                                    <input type="text" value={answers[q.id] || ''} onChange={(e) => handleTextChange(q.id, e.target.value)} className="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nh·∫≠p ƒë√°p √°n (d√πng d·∫•u ch·∫•m ho·∫∑c ph·∫©y)..." />
                                )}
                            </div>
                        ))}
                        <div className="flex justify-center pt-6">
                            <button onClick={handleConfirmSubmit} disabled={isSubmitting} className={`px-8 py-4 text-white text-lg font-bold rounded-xl shadow-lg flex items-center gap-2 transition-all ${isSubmitting ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 transform hover:scale-105'}`}>
                                {isSubmitting ? <><Icon name="loader"/> ƒêANG G·ª¨I...</> : <><Icon name="save"/> N·ªòP B√ÄI</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const SolutionView = ({ questions, answers, score, onRetry }) => {
            const [openExplain, setOpenExplain] = useState({});
            const toggleExplain = (id) => setOpenExplain(prev => ({ ...prev, [id]: !prev[id] }));
            const isPassed = score >= PASSING_SCORE;

            return (
                <div className={`min-h-screen pb-20 ${isPassed ? 'bg-green-50' : 'bg-red-50'}`}>
                    <div className={`shadow p-6 text-center mb-6 ${isPassed ? 'bg-white' : 'bg-white border-b-4 border-red-500'}`}>
                        <div className="flex justify-center mb-2">{isPassed ? <Icon name="trophy" size={56} className="text-yellow-500"/> : <Icon name="alert-circle" size={56} className="text-red-500"/>}</div>
                        <h2 className={`text-2xl font-bold ${isPassed ? 'text-green-700' : 'text-red-700'}`}>{isPassed ? "Ch√∫c M·ª´ng! B·∫°n ƒê√£ Ho√†n Th√†nh" : "C·∫ßn C·ªë G·∫Øng H∆°n"}</h2>
                        <div className={`mt-4 inline-block px-6 py-3 rounded-xl border ${isPassed ? 'bg-green-100 border-green-200' : 'bg-red-100 border-red-200'}`}>
                            <span className="text-gray-600 uppercase text-xs font-bold block">T·ªïng ƒêi·ªÉm</span>
                            <span className={`text-4xl font-bold ${isPassed ? 'text-green-700' : 'text-red-700'}`}>{score.toFixed(2)}<span className="text-xl text-gray-500">/10</span></span>
                        </div>
                        <p className="text-gray-600 mt-3 text-sm max-w-md mx-auto">{isPassed ? "K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c l∆∞u. H√£y xem l·∫°i l·ªùi gi·∫£i chi ti·∫øt b√™n d∆∞·ªõi." : `B·∫°n c·∫ßn ƒë·∫°t t·ªëi thi·ªÉu ${PASSING_SCORE} ƒëi·ªÉm. H√£y xem l·∫°i l·ªùi gi·∫£i v√† th·ª≠ l·∫°i.`}</p>
                    </div>

                    {isPassed ? (
                        <div className="max-w-3xl mx-auto p-4 space-y-6">
                            <h3 className="font-bold text-gray-700 flex items-center gap-2 mb-4"><Icon name="check-circle" size={20}/> Chi Ti·∫øt B√†i L√†m & L·ªùi Gi·∫£i</h3>
                            {questions.map((q, idx) => {
                                const isOpen = openExplain[q.id];
                                return (
                                    <div key={q.id} className="bg-white rounded-lg shadow-sm border-l-4 border-blue-400 overflow-hidden">
                                        <div className="p-4 cursor-pointer" onClick={() => toggleExplain(q.id)}>
                                            <div className="flex justify-between items-start">
                                                <div className="font-medium text-gray-800 flex-1 flex gap-2"><span className="font-bold whitespace-nowrap">C√¢u {idx + 1}:</span> <MathText text={q.question} /></div>
                                            </div>
                                            <div className="text-right text-xs text-blue-500 mt-2">Xem chi ti·∫øt l·ªùi gi·∫£i ‚ñº</div>
                                        </div>
                                        {isOpen && (
                                            <div className="bg-blue-50 p-4 text-sm text-blue-900 border-t border-blue-100">
                                                {q.image && <div className="mb-4 flex justify-center">{q.image}</div>}
                                                <span className="font-bold block mb-1">üí° L·ªùi gi·∫£i chi ti·∫øt:</span>
                                                <MathText text={q.explanation} />
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <div className="max-w-md mx-auto p-8 text-center text-gray-500">
                            <div className="flex justify-center mb-4"><Icon name="eye-off" size={64} className="text-gray-300"/></div>
                            <p className="text-lg font-medium text-gray-600 mb-2">Ch·∫ø ƒë·ªô √¥n t·∫≠p</p>
                            <p className="text-sm">H·ªá th·ªëng ƒë√£ ·∫©n to√†n b·ªô c√¢u h·ªèi v√† l·ªùi gi·∫£i ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh kh√°ch quan khi b·∫°n l√†m l·∫°i ƒë·ªÅ.</p>
                        </div>
                    )}
                    <div className="flex justify-center pt-6 pb-10">
                        {isPassed ? <button onClick={() => window.location.reload()} className="px-8 py-3 bg-gray-600 text-white rounded-lg font-bold hover:bg-gray-700 shadow-lg flex items-center gap-2"><Icon name="log-out"/> V·ªÅ trang ch·ªß</button> : <button onClick={onRetry} className="px-8 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 shadow-lg flex items-center gap-2 animate-bounce"><Icon name="refresh-cw"/> L√†m l·∫°i ƒë·ªÅ m·ªõi</button>}
                    </div>
                </div>
            );
        };

        const TeacherLogin = ({ onLogin, onBack }) => {
            const [pass, setPass] = useState('');
            const [error, setError] = useState('');
            const handleLogin = (e) => { e.preventDefault(); if (pass === '12345678T') { onLogin(); } else { setError('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!'); } };
            return ( <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4"> <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm"> <h2 className="text-xl font-bold mb-6 text-gray-800 text-center">Gi√°o Vi√™n ƒêƒÉng Nh·∫≠p</h2> <form onSubmit={handleLogin} className="space-y-4"> <input type="password" value={pass} onChange={(e) => setPass(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." autoFocus/> {error && <p className="text-red-500 text-sm text-center">{error}</p>} <button type="submit" className="w-full py-3 bg-blue-700 text-white rounded-lg font-bold hover:bg-blue-800">Truy c·∫≠p</button> <button type="button" onClick={onBack} className="w-full py-2 text-gray-500 hover:text-gray-800 text-sm">Quay l·∫°i</button> </form> </div> </div> );
        };

        const TeacherDashboard = ({ onLogout }) => {
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!isFirebaseReady || !db) {
                    setResults([
                        { id: 1, timestamp: { seconds: Date.now()/1000 }, name: "Nguy·ªÖn VƒÉn Demo", score: 8.5 },
                        { id: 2, timestamp: { seconds: Date.now()/1000 - 3600 }, name: "Tr·∫ßn Th·ªã Test", score: 6.0 },
                        { id: 3, timestamp: { seconds: Date.now()/1000 - 7200 }, name: "L√™ VƒÉn M·∫´u", score: 9.25 },
                    ]);
                    setLoading(false);
                    return;
                }
                const q = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(COLLECTION_NAME);
                const unsubscribe = q.onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => {
                        const d = doc.data();
                        let time = 0;
                        if (d.timestamp && d.timestamp.seconds) { time = d.timestamp.seconds; } 
                        else if (typeof d.timestamp === 'string') { time = new Date(d.timestamp).getTime() / 1000; }
                        return { id: doc.id, ...d, sortTime: time };
                    });
                    data.sort((a, b) => b.sortTime - a.sortTime);
                    setResults(data);
                    setLoading(false);
                }, (error) => { console.error("L·ªói t·∫£i d·ªØ li·ªáu:", error); setLoading(false); });
                return () => unsubscribe();
            }, []);

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="bg-white shadow px-6 py-4 flex justify-between items-center sticky top-0 z-10">
                        <div className="flex items-center gap-3">
                            <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2"><Icon name="list" className="text-blue-600"/> B·∫£ng ƒêi·ªÉm</h1>
                            {!isFirebaseReady && <span className="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded border border-yellow-200">Ch·∫ø ƒë·ªô Demo (D·ªØ li·ªáu m·∫´u)</span>}
                        </div>
                        <button onClick={onLogout} className="text-red-600 hover:bg-red-50 px-4 py-2 rounded-lg flex items-center gap-2 font-medium"><Icon name="log-out" size={18}/> ƒêƒÉng xu·∫•t</button>
                    </div>
                    <div className="max-w-6xl mx-auto p-6">
                        <div className="bg-white rounded-xl shadow overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-100 border-b"><tr><th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase">Th·ªùi gian</th><th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase">H·ªç v√† T√™n</th><th className="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase">ƒêi·ªÉm S·ªë (10)</th><th className="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase">X·∫øp lo·∫°i</th></tr></thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {loading ? ( <tr><td colSpan="4" className="p-8 text-center text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr> ) : results.length === 0 ? ( <tr><td colSpan="4" className="p-8 text-center text-gray-500">Ch∆∞a c√≥ b√†i thi n√†o ƒë∆∞·ª£c n·ªôp.</td></tr> ) : results.map((res) => (
                                            <tr key={res.id} className="hover:bg-gray-50">
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{res.timestamp ? new Date((res.sortTime || res.timestamp.seconds) * 1000).toLocaleString('vi-VN') : 'V·ª´a xong'}</td>
                                                <td className="px-6 py-4 whitespace-nowrap font-medium text-gray-900">{res.name}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-center"><span className="text-lg font-bold text-blue-700">{res.score?.toFixed(2)}</span></td>
                                                <td className="px-6 py-4 whitespace-nowrap text-center"><span className={`px-3 py-1 rounded-full text-xs font-bold ${res.score >= 8 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>{res.score >= 8 ? 'Gi·ªèi' : res.score >= 6.5 ? 'Kh√°' : 'Trung B√¨nh'}</span></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('welcome');
            const [user, setUser] = useState(null);
            const [studentName, setStudentName] = useState('');
            const [currentQuestions, setCurrentQuestions] = useState([]);
            const [finalScore, setFinalScore] = useState(0);
            const [userAnswers, setUserAnswers] = useState({});

            useEffect(() => {
                if (isFirebaseReady && auth) {
                    auth.signInAnonymously().catch(e => console.warn(e));
                    const unsubscribe = auth.onAuthStateChanged((u) => { if (u) setUser(u); });
                    return () => unsubscribe();
                }
            }, []);

            const startNewQuiz = (name) => {
                setStudentName(name);
                const newQuestions = generateRandomQuiz();
                setCurrentQuestions(newQuestions);
                setView('quiz');
            };

            const handleRetry = () => {
                const newQuestions = generateRandomQuiz();
                setCurrentQuestions(newQuestions);
                setView('quiz');
            };

            const handleSubmitQuiz = async (answers) => {
                const score = calculateScore(currentQuestions, answers);
                setFinalScore(score);
                setUserAnswers(answers);
                if (score >= PASSING_SCORE && isFirebaseReady && user) {
                    try {
                        const sanitizedAnswers = JSON.parse(JSON.stringify(answers));
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection(COLLECTION_NAME).add({
                            name: studentName, score: score, questionIds: currentQuestions.map(q => q.id), answers: sanitizedAnswers, timestamp: new Date().toISOString()
                        });
                    } catch (error) { console.error("L·ªói Firestore:", error); }
                }
                setView('result'); 
            };

            return (
                <div>
                    {view === 'welcome' && <WelcomeScreen onSelectMode={(mode) => setView(mode === 'student' ? 'name' : 'login')} isOnline={isFirebaseReady} />}
                    {view === 'name' && <StudentNameInput onStart={startNewQuiz} />}
                    {view === 'quiz' && <QuizView studentName={studentName} questions={currentQuestions} onSubmit={handleSubmitQuiz} isConnected={isFirebaseReady} />}
                    {view === 'result' && <SolutionView questions={currentQuestions} answers={userAnswers} score={finalScore} onRetry={handleRetry} />}
                    {view === 'login' && <TeacherLogin onLogin={() => setView('teacher')} onBack={() => setView('welcome')} />}
                    {view === 'teacher' && <TeacherDashboard onLogout={() => setView('welcome')} />}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
