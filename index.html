<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool S·ªë H√≥a ƒê·ªÅ Thi (Final Version)</title>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; display: flex; gap: 20px; }
        .col { flex: 1; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #333; }
        input, button, textarea { width: 100%; padding: 10px; margin-bottom: 15px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; }
        button { background: #007bff; color: white; font-weight: bold; cursor: pointer; border: none; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }
        textarea { flex-grow: 1; font-family: monospace; }
        .status { font-weight: bold; color: #d9534f; margin-bottom: 10px; }
        .success { color: #28a745; }
        #preview img { max-width: 100%; height: auto; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="col">
    <h2>1. C·∫•u h√¨nh & Upload</h2>
    
    <label>Gemini API Key:</label>
    <input type="password" id="geminiKey" placeholder="D√°n key AI Studio v√†o ƒë√¢y...">
    
    <label>ImgBB API Key:</label>
    <input type="text" id="imgbbKey" placeholder="D√°n key ImgBB v√†o ƒë√¢y...">

    <label>Ch·ªçn ƒê·ªÅ Thi (·∫¢nh ho·∫∑c PDF):</label>
    <input type="file" id="fileInput" accept="image/*, application/pdf">
    
    <div id="preview"></div>
    <div id="status" class="status">S·∫µn s√†ng.</div>
    
    <button id="btnRun" onclick="runProcess()">üöÄ B·∫ÆT ƒê·∫¶U X·ª¨ L√ù</button>
</div>

<div class="col">
    <h2>2. K·∫øt qu·∫£ JSON</h2>
    <textarea id="output" placeholder="K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y..."></textarea>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // H√†m Upload ·∫£nh l√™n ImgBB
    async function uploadImgBB(file, key) {
        const formData = new FormData();
        formData.append("image", file);
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${key}`, { method: "POST", body: formData });
        const data = await res.json();
        if(!data.success) throw new Error("L·ªói ImgBB: " + data.error.message);
        return data.data.url;
    }

    // H√†m ƒë·ªçc file cho Gemini
    async function fileToBase64(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(file);
        });
    }

    // H√ÄM CH√çNH
    window.runProcess = async () => {
       // const geminiKey = document.getElementById('geminiKey').value.trim(); // D√≤ng c≈© b·ªè ƒëi
const geminiKey = "AIzaSyBcXKTm0w611xLyfuVi2LCK_klPSIPA1Ek"; // D√≤ng m·ªõi
        const imgbbKey = document.getElementById('imgbbKey').value.trim();
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        const status = document.getElementById('status');
        const btn = document.getElementById('btnRun');
        const output = document.getElementById('output');

        if (!geminiKey || !file) { alert("Thi·∫øu Gemini Key ho·∫∑c ch∆∞a ch·ªçn file!"); return; }

        btn.disabled = true;
        status.innerText = "‚è≥ ƒêang kh·ªüi ƒë·ªông AI...";
        status.className = "status";
        output.value = "";

        try {
            // 1. C·∫•u h√¨nh Gemini
            const genAI = new GoogleGenerativeAI(geminiKey);
            // D√πng model Pro ƒë·ªÉ ·ªïn ƒë·ªãnh h∆°n Flash (tr√°nh l·ªói 404)
            // ƒê·ªïi sang model 1.5 Pro b·∫£n ·ªïn ƒë·ªãnh nh·∫•t
const model = genAI.getGenerativeModel({ model: "gemini-1.5-pro-latest" });
            // 2. Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i ƒëi
            const base64Data = await fileToBase64(file);
            const mimeType = file.type;

            // 3. Vi·∫øt Prompt (L·ªánh)
            const prompt = `
                B·∫°n l√† tr·ª£ l√Ω so·∫°n ƒë·ªÅ thi. H√£y tr√≠ch xu·∫•t n·ªôi dung t·ª´ file ƒë√≠nh k√®m th√†nh JSON.
                
                QUY T·∫ÆC:
                1. ƒê·ªçc to√†n b·ªô c√¢u h·ªèi v√† ƒë√°p √°n. D√πng LaTeX ($...$) cho c√¥ng th·ª©c to√°n.
                2. X·ª≠ l√Ω h√¨nh ·∫£nh:
                   - N·∫øu l√† h√¨nh h·ªçc/ƒë·ªì th·ªã v·∫Ω ƒë∆∞·ª£c b·∫±ng code: T·∫°o "media": { "type": "svg_code", "src": "<svg>...</svg>" }
                   - N·∫øu l√† ·∫£nh ph·ª©c t·∫°p/th·ª±c t·∫ø: T·∫°o "media": { "type": "image_url", "src": "NEED_UPLOAD" }
                3. Tr·∫£ v·ªÅ m·∫£ng JSON (Array) c√°c c√¢u h·ªèi. KH√îNG d√πng markdown.
            `;

            status.innerText = "ü§ñ AI ƒëang ƒë·ªçc ƒë·ªÅ (Vi·ªác n√†y m·∫•t kho·∫£ng 10-20s)...";
            
            const result = await model.generateContent([
                prompt,
                { inlineData: { data: base64Data, mimeType: mimeType } }
            ]);
            
            let text = result.response.text();
            // L√†m s·∫°ch JSON
            text = text.replace(/```json/g, "").replace(/```/g, "").trim();
            let jsonData = JSON.parse(text);

            // 4. X·ª≠ l√Ω Upload ·∫£nh ImgBB (N·∫øu AI y√™u c·∫ßu)
            // L∆∞u √Ω: Logic n√†y ch·ªâ ch·∫°y t·ªët nh·∫•t v·ªõi file ·∫¢NH ƒë∆°n l·∫ª. 
            // V·ªõi PDF nhi·ªÅu trang, ta t·∫°m th·ªùi b·ªè qua b∆∞·ªõc upload t·ª± ƒë·ªông ƒë·ªÉ tr√°nh ph·ª©c t·∫°p, 
            // ho·∫∑c ch·ªâ upload n·∫øu ƒë·∫ßu v√†o l√† file ·∫£nh.
            
            if (file.type.startsWith('image/') && imgbbKey) {
                // Ki·ªÉm tra xem trong JSON c√≥ ch·ªó n√†o c·∫ßn upload kh√¥ng
                let needUpload = false;
                // Duy·ªát qua c√°c c√¢u h·ªèi, n·∫øu th·∫•y type l√† image_url th√¨ upload ·∫£nh g·ªëc l√™n
                // (ƒê√¢y l√† c√°ch ƒë∆°n gi·∫£n: Upload ·∫£nh g·ªëc cho t·∫•t c·∫£ c√¢u c·∫ßn ·∫£nh)
                const imgUrl = await uploadImgBB(file, imgbbKey);
                
                jsonData.forEach(q => {
                    if (q.media && q.media.type === 'image_url' && q.media.src === 'NEED_UPLOAD') {
                        q.media.src = imgUrl; // ƒêi·ªÅn link ·∫£nh v·ª´a upload v√†o
                        status.innerText = "‚òÅÔ∏è ƒê√£ upload ·∫£nh l√™n ImgBB...";
                    }
                });
            }

            // 5. Ho√†n t·∫•t
            output.value = JSON.stringify(jsonData, null, 2);
            status.innerText = "‚úÖ Th√†nh c√¥ng!";
            status.className = "status success";

        } catch (err) {
            console.error(err);
            status.innerText = "‚ùå L·ªói: " + err.message;
            if (err.message.includes("404")) {
                status.innerText += " (Kh·∫£ nƒÉng t√™n Model sai ho·∫∑c Key ch∆∞a k√≠ch ho·∫°t)";
            }
        } finally {
            btn.disabled = false;
        }
    };
    
    // Preview ·∫£nh
    document.getElementById('fileInput').addEventListener('change', function() {
        const f = this.files[0];
        if (f && f.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(f);
            document.getElementById('preview').innerHTML = "";
            document.getElementById('preview').appendChild(img);
        } else if (f) {
            document.getElementById('preview').innerText = "ƒê√£ ch·ªçn file: " + f.name;
        }
    });
</script>

</body>
</html>
