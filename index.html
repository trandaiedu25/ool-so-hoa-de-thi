<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRANDAIEDU - Chuy√™n ƒë·ªÅ Nguy√™n H√†m T√≠ch Ph√¢n</title>
    
    <!-- React & ReactDOM (UMD) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase (Compat version for simple HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .katex { font-size: 1.1em; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- C·∫§U H√åNH FIREBASE ---
        // Thay th·∫ø b·∫±ng config c·ªßa b·∫°n. N·∫øu ƒë·ªÉ tr·ªëng, app s·∫Ω ch·∫°y Offline.
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        let db = null;
        let auth = null;
        let isFirebaseReady = false;

        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE" && window.firebase) {
                const app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseReady = true;
                console.log("Firebase connected.");
            } else {
                console.warn("Ch·∫°y ch·∫ø ƒë·ªô Offline (ch∆∞a c·∫•u h√¨nh Firebase).");
            }
        } catch (e) {
            console.error("L·ªói Firebase:", e);
        }

        const COLLECTION_NAME = "quiz_results_conditional_prob";

        // --- ICONS ---
        const Icon = ({ name, size=24, className="" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                   const iconElement = window.lucide.icons[name];
                   if(iconElement) {
                       iconRef.current.innerHTML = iconElement.toSvg({ class: className, width: size, height: size });
                   }
                }
            }, [name, size, className]);
            return <span ref={iconRef} className={className} style={{display: 'inline-flex', alignItems: 'center'}}></span>;
        };

        // --- MATH RENDERER ---
        const MathText = ({ text, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && text && window.renderMathInElement) {
                    renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "$", right: "$", display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, [text]);
            return <span ref={containerRef} className={className} dangerouslySetInnerHTML={{__html: text}} />;
        };

        // --- SVG IMAGES (S·ª≠a l·ªói stroke-width -> strokeWidth) ---
        const ParabolImage = () => (
            <div className="flex justify-center my-4">
                <svg width="200" height="150" viewBox="-50 -10 100 80" className="border border-gray-200 bg-white rounded shadow-sm">
                    <path d="M -40 70 Q 0 -10 40 70" fill="none" stroke="#2563eb" strokeWidth="2" />
                    <line x1="-40" y1="70" x2="40" y2="70" stroke="black" strokeWidth="1" />
                    <line x1="0" y1="0" x2="0" y2="70" stroke="black" strokeWidth="1" strokeDasharray="4" />
                    <text x="-5" y="75" fontSize="8" textAnchor="middle">0</text>
                    <text x="0" y="-2" fontSize="8" textAnchor="middle">h = 2.25m</text>
                    <text x="0" y="85" fontSize="8" textAnchor="middle">w = 3m</text>
                </svg>
            </div>
        );

        const MachinePartImage = () => (
            <div className="flex justify-center my-4">
                <svg width="200" height="100" viewBox="0 0 200 100" className="border border-gray-200 bg-white rounded shadow-sm">
                    <ellipse cx="30" cy="50" rx="10" ry="30" fill="none" stroke="black" />
                    <ellipse cx="170" cy="50" rx="10" ry="30" fill="none" stroke="black" />
                    <line x1="30" y1="20" x2="170" y2="20" stroke="black" strokeWidth="2" />
                    <line x1="30" y1="80" x2="170" y2="80" stroke="black" strokeWidth="2" />
                    <path d="M 30 20 Q 100 50 170 20" fill="none" stroke="#2563eb" strokeDasharray="4" />
                    <text x="100" y="95" fontSize="10" textAnchor="middle">Chi ti·∫øt m√°y</text>
                </svg>
            </div>
        );

        const ThuanhImage = () => (
          <div className="flex justify-center my-4">
            <svg width="300" height="200" viewBox="0 0 500 350" className="max-w-full h-auto border rounded bg-white">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="black" />
                    </marker>
                </defs>
                <rect width="100%" height="100%" fill="white" />
                <path d="M 50 160 C 150 160, 250 220, 350 220 L 350 250 C 250 250, 150 190, 50 190 Z" fill="#87CEFA" stroke="none" />
                <rect x="50" y="160" width="300" height="90" fill="none" stroke="#4682B4" strokeWidth="2" />
                <line x1="50" y1="250" x2="400" y2="250" stroke="black" strokeWidth="2" markerEnd="url(#arrowhead)" />
                <line x1="50" y1="250" x2="50" y2="100" stroke="black" strokeWidth="2" markerEnd="url(#arrowhead)" />
                <text x="250" y="320" fontFamily="serif" fontSize="24" textAnchor="middle">H√¨nh minh h·ªça</text>
            </svg>
          </div>
        );

        // --- QUESTION BANK ---
        const QUESTION_BANK = [
             // --- M√É ƒê·ªÄ 145 ---
             { id: 'd145_q1', type: 'mcq', question: "H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=3x^2+\\sin 2x$ l√†:", options: ["$x^3+\\cos 2x+C$", "$6x+2\\cos 2x+C$", "$x^3-\\frac{1}{2}\\cos 2x+C$", "$6x+\\frac{1}{2}\\cos 2x+C$"], correct: 2, explanation: "Ta c√≥ $\\int (3x^2+\\sin 2x)dx = x^3 - \\frac{1}{2}\\cos 2x + C$." },
             { id: 'd145_q2', type: 'mcq', question: "M·ªánh ƒë·ªÅ n√†o sau ƒë√¢y SAI?", options: ["$\\int [f_1(x)+f_2(x)]dx = \\int f_1(x)dx + \\int f_2(x)dx$", "$\\int kf(x)dx = k\\int f(x)dx$ ($k \\ne 0$)", "$\\int f'(x)dx = f(x) + C$", "$\\int [f_1(x).f_2(x)]dx = \\int f_1(x)dx . \\int f_2(x)dx$"], correct: 3, explanation: "Nguy√™n h√†m c·ªßa t√≠ch kh√¥ng b·∫±ng t√≠ch c√°c nguy√™n h√†m." },
             { id: 'd145_q3', type: 'mcq', question: "T√¨m nguy√™n h√†m $F(x)$ c·ªßa h√†m s·ªë $f(x) = e^x + 2x$ bi·∫øt $F(0) = \\frac{3}{2}$.", options: ["$F(x) = e^x + x^2 + \\frac{1}{2}$", "$F(x) = e^x + x^2 + \\frac{3}{2}$", "$F(x) = e^x + x^2 + \\frac{5}{2}$", "$F(x) = 2e^x + x^2 - \\frac{1}{2}$"], correct: 0, explanation: "$F(x) = e^x + x^2 + C$. $F(0) = 1 + 0 + C = 1,5 \\Rightarrow C = 0,5$." },
             { id: 'd145_q4', type: 'mcq', question: "T√≠nh t√≠ch ph√¢n $I = \\int_{0}^{1} (3x^2 + 1)dx$.", options: ["2", "4", "6", "-2"], correct: 0, explanation: "$(x^3 + x) \\Big|_0^1 = (1+1) - 0 = 2$." },
             { id: 'd145_q5', type: 'mcq', question: "Cho $\\int f(x)dx = F(x) + C$. Khi ƒë√≥ $\\int f(2x)dx$ b·∫±ng:", options: ["$2F(2x) + C$", "$F(2x) + C$", "$\\frac{1}{2} F(2x) + C$", "$F(x) + C$"], correct: 2, explanation: "√Åp d·ª•ng c√¥ng th·ª©c: $\\int f(ax+b)dx = \\frac{1}{a}F(ax+b) + C$." },
             { id: 'd145_q6', type: 'mcq', question: "Cho $\\int_{0}^{10} f(x)dx = 7$ v√† $\\int_{2}^{6} f(x)dx = 3$. T√≠nh $P = \\int_{0}^{2} f(x)dx + \\int_{6}^{10} f(x)dx$.", options: ["10", "4", "7", "-4"], correct: 1, explanation: "$P = \\int_{0}^{10} f(x)dx - \\int_{2}^{6} f(x)dx = 7 - 3 = 4$." },
             { id: 'd145_q7', type: 'mcq', question: "Di·ªán t√≠ch h√¨nh ph·∫≥ng gi·ªõi h·∫°n b·ªüi $y = x^3$, tr·ª•c ho√†nh, $x=1, x=3$ l√†:", options: ["20", "21", "22", "80/4"], correct: 0, explanation: "$S = \\int_{1}^{3} x^3 dx = \\frac{x^4}{4} \\Big|_1^3 = \\frac{81-1}{4} = 20$." },
             { id: 'd145_q8', type: 'mcq', question: "Cho $F(x)$ l√† nguy√™n h√†m c·ªßa $f(x) = \\frac{1}{x-1}$ tr√™n $(1; +\\infty)$, bi·∫øt $F(2) = 1$. T√≠nh $F(3)$.", options: ["$\\ln 2 + 1$", "$\\ln 2$", "$\\ln 3$", "$1 - \\ln 2$"], correct: 0, explanation: "$F(x) = \\ln|x-1| + C$. $F(2)=\\ln 1 + C = 1 \\Rightarrow C=1$. $F(3) = \\ln 2 + 1$." },
             { id: 'd145_q9', type: 'mcq', question: "Th·ªÉ t√≠ch kh·ªëi tr√≤n xoay khi quay h√¨nh ph·∫≥ng gi·ªõi h·∫°n b·ªüi $y = \\sqrt{x}, y=0, x=4$ quanh $Ox$ l√†:", options: ["$8\\pi$", "$4\\pi$", "$16\\pi$", "8"], correct: 0, explanation: "$V = \\pi \\int_{0}^{4} (\\sqrt{x})^2 dx = \\pi \\int_{0}^{4} x dx = 8\\pi$." },
             { id: 'd145_q10', type: 'mcq', question: "H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $y = \\cos(3x)$ l√†:", options: ["$-\\sin(3x) + C$", "$3\\sin(3x) + C$", "$\\frac{1}{3} \\sin(3x) + C$", "$-\\frac{1}{3} \\sin(3x) + C$"], correct: 2, explanation: "$\\int \\cos(ax)dx = \\frac{1}{a}\\sin(ax) + C$." },
             { id: 'd145_q11', type: 'mcq', question: "Bi·∫øt $\\int_{1}^{2} f(x)dx = 2$ v√† $\\int_{1}^{2} g(x)dx = 6$. T√≠nh $I = \\int_{1}^{2} [f(x) - g(x)]dx$.", options: ["-4", "4", "8", "-8"], correct: 0, explanation: "$I = 2 - 6 = -4$." },
             { id: 'd145_q12', type: 'mcq', question: "H√†m s·ªë $F(x) = x^2 + \\sin x$ l√† m·ªôt nguy√™n h√†m c·ªßa h√†m s·ªë n√†o?", options: ["$2x + \\cos x$", "$2x - \\cos x$", "$\\frac{x^3}{3} - \\cos x$", "$\\frac{x^3}{3} + \\cos x$"], correct: 0, explanation: "$F'(x) = (x^2)' + (\\sin x)' = 2x + \\cos x$." },

             { id: 'd145_q13', type: 'group_tf', question: "Cho h√†m s·ªë $f(x) = \\frac{1}{x}$ x√°c ƒë·ªãnh tr√™n $(0; +\\infty)$.", subQuestions: [ { id: 'a', text: "$F(x) = \\ln|x|$ l√† m·ªôt nguy√™n h√†m c·ªßa $f(x)$.", correct: true }, { id: 'b', text: "$F(x) = \\ln x + 5$ l√† m·ªôt nguy√™n h√†m c·ªßa $f(x)$.", correct: true }, { id: 'c', text: "$\\int f(x)dx = -\\frac{1}{x^2} + C$.", correct: false }, { id: 'd', text: "Tr√™n $(-\\infty; 0)$, nguy√™n h√†m l√† $\\ln(-x) + C$.", correct: true } ], explanation: "ƒê·∫°o h√†m $\\ln|x|$ l√† $1/x$." },
             { id: 'd145_q14', type: 'group_tf', question: "X√©t t√≠ch ph√¢n $I = \\int_{0}^{\\pi/2} \\sin x dx$.", subQuestions: [ { id: 'a', text: "Nguy√™n h√†m c·ªßa $\\sin x$ l√† $-\\cos x$.", correct: true }, { id: 'b', text: "Gi√° tr·ªã $I = 1$.", correct: true }, { id: 'c', text: "N·∫øu ƒë·ªïi c·∫≠n th√†nh $0$ ƒë·∫øn $\\pi$, $I = 0$.", correct: false }, { id: 'd', text: "Di·ªán t√≠ch h√¨nh ph·∫≥ng gi·ªõi h·∫°n b·ªüi $y=\\sin x, Ox, x=0, x=\\pi/2$ b·∫±ng 1.", correct: true } ], explanation: "$\\int_{0}^{\\pi} \\sin x dx = 2$ (c sai)." },
             { id: 'd145_q15', type: 'group_tf', question: "Cho h√¨nh ph·∫≥ng (H) gi·ªõi h·∫°n b·ªüi $y = x^2 - 2x$ v√† tr·ª•c ho√†nh.", subQuestions: [ { id: 'a', text: "Ho√†nh ƒë·ªô giao ƒëi·ªÉm l√† $x=0$ v√† $x=2$.", correct: true }, { id: 'b', text: "Di·ªán t√≠ch $S = \\int_{0}^{2} (x^2 - 2x) dx$.", correct: false }, { id: 'c', text: "Di·ªán t√≠ch $S = \\int_{0}^{2} |x^2 - 2x| dx$.", correct: true }, { id: 'd', text: "Gi√° tr·ªã di·ªán t√≠ch l√† $4/3$.", correct: true } ], explanation: "b sai v√¨ thi·∫øu tr·ªã tuy·ªát ƒë·ªëi." },
             { id: 'd145_q16', type: 'group_tf', question: "V·ªÅ ph∆∞∆°ng ph√°p ƒë·ªïi bi·∫øn s·ªë trong t√≠ch ph√¢n:", subQuestions: [ { id: 'a', text: "N·∫øu $u = u(x)$ th√¨ $du = u'(x)dx$.", correct: true }, { id: 'b', text: "Khi ƒë·ªïi bi·∫øn kh√¥ng c·∫ßn ƒë·ªïi c·∫≠n.", correct: false }, { id: 'c', text: "$\\int f(x)dx = \\int f(t)dt$ l√† sai k√Ω hi·ªáu n·∫øu kh√¥ng ƒë·ªïi vi ph√¢n.", correct: true }, { id: 'd', text: "T√≠ch ph√¢n x√°c ƒë·ªãnh kh√¥ng ph·ª• thu·ªôc v√†o t√™n bi·∫øn s·ªë.", correct: true } ], explanation: "Khi ƒë·ªïi bi·∫øn b·∫Øt bu·ªôc ph·∫£i ƒë·ªïi c·∫≠n." },

             { id: 'd145_q17', type: 'text', question: "Di·ªán t√≠ch ph·∫ßn ƒë∆∞·ª£c ngh·ªá sƒ© t√¥ m√†u ƒëen (h√¨nh hoa vƒÉn) c√≥ di·ªán t√≠ch b·∫±ng bao nhi√™u cm¬≤? (l√†m tr√≤n h√†ng ƒë∆°n v·ªã)", acceptable: ["2016"], image: <ThuanhImage />, explanation: "2016." },
             { id: 'd145_q18', type: 'text', question: "T√≠nh t√≠ch ph√¢n $I = \\int_{0}^{1} e^{2x} dx$. (L√†m tr√≤n 2 ch·ªØ s·ªë th·∫≠p ph√¢n)", acceptable: ["3.19", "3,19"], explanation: "$3.19$" },
             { id: 'd145_q19', type: 'text', question: "V·∫≠n t·ªëc $v(t) = 3t^2 + 2$. Qu√£ng ƒë∆∞·ªùng sau 2 gi√¢y?", acceptable: ["12", "12m"], explanation: "$S = 12$." },
             { id: 'd145_q20', type: 'text', question: "Cho $F(x)$ nguy√™n h√†m $f(x)=2x+1$, $F(1)=3$. T√≠nh $F(0)$.", acceptable: ["1"], explanation: "$F(0)=1$." },
             { id: 'd145_q21', type: 'text', question: "Gi√° tr·ªã c·ªßa $I = \\int_{1}^{e} \\frac{1}{x} dx$ l√†:", acceptable: ["1"], explanation: "1" },
             { id: 'd145_q22', type: 'text', question: "Th·ªÉ t√≠ch kh·ªëi c·∫ßu b√°n k√≠nh $R=3$ l√†:", acceptable: ["36œÄ", "113.1", "113,1"], explanation: "$36\\pi$." },

             // --- M√É ƒê·ªÄ 215 ---
             { id: 'd215_q1', type: 'mcq', question: "H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=\\frac{x^2}{2}+2x-5$ l√†:", options: ["$\\frac{2x^3}{3}+x^2-5x+C$", "$\\frac{x^3}{3}+x^2-5x+C$", "$\\frac{x^3}{6}+x^2-5x+C$", "$\\frac{x^3}{6}+x^2-5x$"], correct: 2, explanation: "$\\frac{x^3}{6} + x^2 - 5x + C$." },
             { id: 'd215_q2', type: 'mcq', question: "Kh·∫≥ng ƒë·ªãnh n√†o ƒê√öNG?", options: ["$\\int e^x dx = e^x + C$", "$\\int \\sin x dx = \\cos x + C$", "$\\int \\frac{1}{x} dx = -\\frac{1}{x^2} + C$", "$\\int \\ln x dx = \\frac{1}{x} + C$"], correct: 0, explanation: "Nguy√™n h√†m $e^x$ l√† ch√≠nh n√≥." },
             { id: 'd215_q3', type: 'mcq', question: "Di·ªán t√≠ch h√¨nh ph·∫≥ng gi·ªõi h·∫°n b·ªüi $y = x^2$ v√† $y = x + 2$ l√†:", options: ["9/2", "3/2", "13/6", "10/3"], correct: 0, explanation: "9/2" },
             { id: 'd215_q4', type: 'mcq', question: "Cho $\\int_{1}^{2} f(x)dx = 3$. T√≠nh $I = \\int_{1}^{2} [3f(x) - 2]dx$.", options: ["7", "5", "9", "3"], correct: 0, explanation: "7" },
             { id: 'd215_q5', type: 'mcq', question: "Nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = (2x+1)^3$ l√†:", options: ["$(2x+1)^4/4 + C$", "$(2x+1)^4/8 + C$", "$3(2x+1)^2 + C$", "$4(2x+1)^4 + C$"], correct: 1, explanation: "$\\frac{(2x+1)^4}{8}$." },
             { id: 'd215_q6', type: 'mcq', question: "Th·ªÉ t√≠ch quay $y = 2x, y=0, x=0, x=3$ quanh $Ox$ l√†:", options: ["$18\\pi$", "$36\\pi$", "$54\\pi$", "$12\\pi$"], correct: 1, explanation: "$36\\pi$." },
             { id: 'd215_q7', type: 'mcq', question: "Nguy√™n h√†m c·ªßa $f(x) = \\frac{1}{2x+3}$ l√†:", options: ["$\\ln|2x+3| + C$", "$\\frac{1}{2} \\ln|2x+3| + C$", "$2 \\ln|2x+3| + C$", "$(2x+3)^{-2} + C$"], correct: 1, explanation: "$\\frac{1}{2} \\ln|2x+3|$." },
             { id: 'd215_q8', type: 'mcq', question: "Cho $f(1)=5, f(0)=2$. T√≠nh $\\int_{0}^{1} f'(x)dx$.", options: ["3", "7", "-3", "10"], correct: 0, explanation: "3" },
             { id: 'd215_q9', type: 'mcq', question: "N·∫øu $\\int f = 5$ v√† $\\int g = -3$ th√¨ $\\int (f+g)$ b·∫±ng:", options: ["2", "8", "-15", "-2"], correct: 0, explanation: "2" },
             { id: 'd215_q10', type: 'mcq', question: "T√≠ch ph√¢n $I = \\int_{0}^{\\pi/4} \\cos(2x)dx$ b·∫±ng:", options: ["1/2", "1", "-1/2", "0"], correct: 0, explanation: "1/2" },
             { id: 'd215_q11', type: 'mcq', question: "H√†m s·ªë n√†o KH√îNG l√† nguy√™n h√†m c·ªßa $f(x) = x^3$?", options: ["$x^4/4 + 1$", "$x^4/4 - 10$", "$x^4/4$", "$3x^2$"], correct: 3, explanation: "$3x^2$ l√† ƒë·∫°o h√†m." },
             { id: 'd215_q12', type: 'mcq', question: "Di·ªán t√≠ch $S$ gi·ªõi h·∫°n b·ªüi $y=f(x) < 0$ tr√™n $[a,b]$ l√†:", options: ["$\\int_a^b f(x)dx$", "$-\\int_a^b f(x)dx$", "$\\int_b^a f(x)dx$", "$|\\int f(x)dx|^2$"], correct: 1, explanation: "Do √¢m n√™n c√≥ d·∫•u tr·ª´." },

             { id: 'd215_q13', type: 'group_tf', question: "Cho h√†m s·ªë $f(x) = \\cos x$.", subQuestions: [ { id: 'a', text: "Nguy√™n h√†m l√† $\\sin x + C$.", correct: true }, { id: 'b', text: "$\\int_{0}^{\\pi} f(x)dx = 0$.", correct: true }, { id: 'c', text: "Di·ªán t√≠ch h√¨nh ph·∫≥ng gi·ªõi h·∫°n b·ªüi $\\cos x, Ox, x=0, x=\\pi$ l√† 0.", correct: false }, { id: 'd', text: "$F(x) = \\sin x + 2024$ l√† m·ªôt nguy√™n h√†m.", correct: true } ], explanation: "Di·ªán t√≠ch lu√¥n d∆∞∆°ng." },
             { id: 'd215_q14', type: 'group_tf', question: "X√©t t√≠ch ph√¢n $I = \\int_{1}^{e} \\ln x dx$.", subQuestions: [ { id: 'a', text: "D√πng ph∆∞∆°ng ph√°p t√≠ch ph√¢n t·ª´ng ph·∫ßn.", correct: true }, { id: 'b', text: "ƒê·∫∑t $u = \\ln x, dv = dx$.", correct: true }, { id: 'c', text: "K·∫øt qu·∫£ $I = 1$.", correct: true }, { id: 'd', text: "K·∫øt qu·∫£ $I = e$.", correct: false } ], explanation: "$I=1$." },
             { id: 'd215_q15', type: 'group_tf', question: "Cho v·∫≠n t·ªëc $v(t) = 10 - 2t$.", subQuestions: [ { id: 'a', text: "Chuy·ªÉn ƒë·ªông ch·∫≠m d·∫ßn ƒë·ªÅu.", correct: true }, { id: 'b', text: "V·∫≠t d·ª´ng l·∫°i t·∫°i $t = 5s$.", correct: true }, { id: 'c', text: "Qu√£ng ƒë∆∞·ªùng l√† $\\int_{0}^{5} (10-2t)dt$.", correct: true }, { id: 'd', text: "Qu√£ng ƒë∆∞·ªùng b·∫±ng $50m$.", correct: false } ], explanation: "S=25m." },
             { id: 'd215_q16', type: 'group_tf', question: "T√≠ch ph√¢n h√†m s·ªë l·∫ª v√† ch·∫µn tr√™n $[-a; a]$:", subQuestions: [ { id: 'a', text: "N·∫øu $f(x)$ l·∫ª th√¨ t√≠ch ph√¢n b·∫±ng 0.", correct: true }, { id: 'b', text: "N·∫øu $f(x)$ ch·∫µn th√¨ t√≠ch ph√¢n b·∫±ng 2 l·∫ßn t√≠ch ph√¢n t·ª´ 0 ƒë·∫øn a.", correct: true }, { id: 'c', text: "$\\int_{-1}^{1} x^5 dx = 0$.", correct: true }, { id: 'd', text: "$\\int_{-1}^{1} x^2 dx = 0$.", correct: false } ], explanation: "$x^2$ ch·∫µn n√™n t√≠ch ph√¢n kh√°c 0." },

             { id: 'd215_q17', type: 'text', question: "T√≠nh th·ªÉ t√≠ch n∆∞·ªõc trong c·ªëc bi·∫øt $V=\\int_{-4}^{4}\\frac{3}{2}(16-x^2)dx$. (K·∫øt qu·∫£ l√† s·ªë nguy√™n)", acceptable: ["128"], explanation: "$V = 128$." },
             { id: 'd215_q18', type: 'text', question: "Tr∆∞·ªùng mu·ªën l√†m c·ª≠a Parabol cao 2,25m, r·ªông 3m. Gi√° 1.500.000ƒë/m2. T√≠nh s·ªë ti·ªÅn (ngh√¨n ƒë·ªìng).", acceptable: ["6750"], image: <ParabolImage />, explanation: "6750 ngh√¨n ƒë·ªìng." },
             { id: 'd215_q19', type: 'text', question: "Gi√° tr·ªã c·ªßa $\\int_{0}^{3} 2x dx$ l√†:", acceptable: ["9"], explanation: "9" },
             { id: 'd215_q20', type: 'text', question: "T√¨m $m>0$ ƒë·ªÉ $\\int_{0}^{m} (2x+5)dx = 6$.", acceptable: ["1"], explanation: "1" },
             { id: 'd215_q21', type: 'text', question: "Bi·∫øt $F(x) = x^3$ l√† nguy√™n h√†m c·ªßa $f(x)$. T√≠nh $f(2)$.", acceptable: ["12"], explanation: "12" },
             { id: 'd215_q22', type: 'text', question: "V·∫≠t tƒÉng t·ªëc v·ªõi $a(t)=3, v(0)=2$. T√≠nh $v(4)$.", acceptable: ["14"], explanation: "14" },

             // ============================================================
             // M√É ƒê·ªÄ 317
             // ============================================================
             // --- Ph·∫ßn 1: Tr·∫Øc nghi·ªám ---
             {
                id: 'd317_q1', type: 'mcq',
                question: "Tr√™n kho·∫£ng $(-\\infty;+\\infty)$, h√†m s·ªë $F(x)=\\frac{1}{2}\\sin 2x$ l√† m·ªôt nguy√™n h√†m c·ªßa h√†m s·ªë n√†o?",
                options: ["$f(x)=-\\cos 2x$", "$f(x)=\\sin 2x$", "$f(x)=\\cos 2x$", "$f(x)=-\\frac{1}{2}\\cos 2x$"],
                correct: 2, explanation: "$F'(x) = \\cos 2x$."
             },
             { id: 'd317_q2', type: 'mcq', question: "Cho $\\int f(x)dx = 3x^2 + C$. Khi ƒë√≥ $f(x)$ b·∫±ng:", options: ["$6x$", "$x^3 + C$", "$3x$", "6"], correct: 0, explanation: "6x" },
             { id: 'd317_q3', type: 'mcq', question: "Di·ªán t√≠ch h√¨nh ph·∫≥ng gi·ªõi h·∫°n b·ªüi $y = e^x, Ox, x=0, x=1$ l√†:", options: ["$e - 1$", "$e$", "$e + 1$", "$1 - e$"], correct: 0, explanation: "$e-1$" },
             { id: 'd317_q4', type: 'mcq', question: "T√≠nh $I = \\int_{1}^{2} \\frac{1}{x^2} dx$.", options: ["1/2", "-1/2", "3/4", "1"], correct: 0, explanation: "1/2" },
             { id: 'd317_q5', type: 'mcq', question: "ƒê·∫∑t $u = x^2 + 1$ th√¨ $\\int 2x(x^2 + 1)^3 dx$ tr·ªü th√†nh:", options: ["$\\int u^3 du$", "$\\int 2u^3 du$", "$\\int u^2 du$", "$\\frac{1}{2} \\int u^3 du$"], correct: 0, explanation: "$\\int u^3 du$" },
             { id: 'd317_q6', type: 'mcq', question: "Th·ªÉ t√≠ch quay $y = 2x, x=0, x=1$ quanh $Ox$ l√†:", options: ["$4\\pi/3$", "$2\\pi$", "$4\\pi$", "$\\pi$"], correct: 0, explanation: "$4\\pi/3$" },
             { id: 'd317_q7', type: 'mcq', question: "Nguy√™n h√†m c·ªßa $f(x) = 5^x$ l√†:", options: ["$\\frac{5^x}{\\ln 5} + C$", "$5^x \\ln 5 + C$", "$\\frac{5^{x+1}}{x+1}$", "$5^x + C$"], correct: 0, explanation: "$\\frac{5^x}{\\ln 5}$" },
             { id: 'd317_q8', type: 'mcq', question: "Bi·∫øt $F(2)=5, F(0)=1$. T√≠nh $I = \\int_{0}^{2} f(x)dx$.", options: ["4", "6", "5", "3"], correct: 0, explanation: "4" },
             { id: 'd317_q9', type: 'mcq', question: "T√≠ch ph√¢n $I = \\int_{0}^{1} \\frac{1}{1+x} dx$ b·∫±ng:", options: ["$\\ln 2$", "$\\ln 3$", "1", "0"], correct: 0, explanation: "$\\ln 2$" },
             { id: 'd317_q10', type: 'mcq', question: "Di·ªán t√≠ch S gi·ªõi h·∫°n b·ªüi $y=x$ v√† $y=x^3$ ($x>0$) l√†:", options: ["1/4", "1/2", "1", "1/3"], correct: 0, explanation: "1/4" },
             { id: 'd317_q11', type: 'mcq', question: "Cho $I = \\int_{0}^{\\pi/2} \\sin x \\cos x dx$. Gi√° tr·ªã l√†:", options: ["1/2", "1", "2", "1/4"], correct: 0, explanation: "1/2" },
             { id: 'd317_q12', type: 'mcq', question: "H√†m s·ªë n√†o c√≥ nguy√™n h√†m l√† $F(x) = x + \\ln x$?", options: ["$1 + 1/x$", "$1 - 1/x$", "$x + 1/x$", "$1/x$"], correct: 0, explanation: "$1+1/x$" },

             // --- Ph·∫ßn 2: ƒê√∫ng/Sai (M√£ 317) ---
             { id: 'd317_q13', type: 'group_tf', question: "Cho h√†m s·ªë $y = f(x)$ li√™n t·ª•c tr√™n $[a, b]$.", subQuestions: [ { id: 'a', text: "Di·ªán t√≠ch $S = \\int_{a}^{b} f(x) dx$.", correct: false }, { id: 'b', text: "Th·ªÉ t√≠ch quay quanh $Ox$ l√† $V = \\pi\\int_{a}^{b} f^2(x) dx$.", correct: true }, { id: 'c', text: "$\\int_{a}^{a} f(x) dx = 0$.", correct: true }, { id: 'd', text: "N·∫øu $f(x) > 0$ th√¨ t√≠ch ph√¢n d∆∞∆°ng.", correct: true } ], explanation: "a sai v√¨ thi·∫øu tr·ªã tuy·ªát ƒë·ªëi." },
             { id: 'd317_q14', type: 'group_tf', question: "X√©t t√≠ch ph√¢n $I = \\int_{0}^{1} x e^x dx$.", subQuestions: [ { id: 'a', text: "D√πng ph∆∞∆°ng ph√°p ƒë·ªïi bi·∫øn s·ªë.", correct: false }, { id: 'b', text: "D√πng t√≠ch ph√¢n t·ª´ng ph·∫ßn: $u=x, dv=e^x dx$.", correct: true }, { id: 'c', text: "Bi·ªÉu th·ª©c $v = e^x$.", correct: true }, { id: 'd', text: "K·∫øt qu·∫£ $I = 1$.", correct: true } ], explanation: "D√πng t·ª´ng ph·∫ßn." },
             { id: 'd317_q15', type: 'group_tf', question: "V·ªÅ t√≠nh ch·∫•t nguy√™n h√†m:", subQuestions: [ { id: 'a', text: "M·ªçi h√†m li√™n t·ª•c tr√™n K ƒë·ªÅu c√≥ nguy√™n h√†m.", correct: true }, { id: 'b', text: "Hai nguy√™n h√†m sai kh√°c nhau h·∫±ng s·ªë C.", correct: true }, { id: 'c', text: "$F'(x) = f(x)$ th√¨ $F$ l√† nguy√™n h√†m c·ªßa $f$.", correct: true }, { id: 'd', text: "$\\int 0 dx = C$.", correct: true } ], explanation: "ƒê√∫ng." },
             { id: 'd317_q16', type: 'group_tf', question: "·ª®ng d·ª•ng t√≠ch ph√¢n:", subQuestions: [ { id: 'a', text: "T√≠nh di·ªán t√≠ch h√¨nh ph·∫≥ng.", correct: true }, { id: 'b', text: "T√≠nh th·ªÉ t√≠ch v·∫≠t th·ªÉ tr√≤n xoay.", correct: true }, { id: 'c', text: "T√≠nh qu√£ng ƒë∆∞·ªùng t·ª´ v·∫≠n t·ªëc.", correct: true }, { id: 'd', text: "T√≠nh v·∫≠n t·ªëc t·ª´ gia t·ªëc.", correct: true } ], explanation: "ƒê√∫ng." },

             // --- Ph·∫ßn 3: Tr·∫£ l·ªùi ng·∫Øn (M√£ 317) ---
             { id: 'd317_q17', type: 'text', question: "Th·ªÉ t√≠ch c·ªßa chi ti·∫øt m√°y (ƒë·ªÅ 317) b·∫±ng bao nhi√™u $cm^3$ (l√†m tr√≤n k·∫øt qu·∫£ ƒë·∫øn h√†ng ph·∫ßn m∆∞·ªùi)?", acceptable: ["34", "34.0"], image: <MachinePartImage />, explanation: "34" },
             { id: 'd317_q18', type: 'text', question: "T√≠nh $I = \\int_{0}^{1} 4x^3 dx$.", acceptable: ["1"], explanation: "1" },
             { id: 'd317_q19', type: 'text', question: "Di·ªán t√≠ch h√¨nh tr√≤n $R=2$ l√†: (nh·∫≠p d·∫°ng 4pi ho·∫∑c 12.56)", acceptable: ["12.56", "12,56", "4œÄ"], explanation: "$4\\pi$" },
             { id: 'd317_q20', type: 'text', question: "T√¨m $a$ bi·∫øt $\\int_{0}^{1} ax dx = 2$.", acceptable: ["4"], explanation: "4" },
             { id: 'd317_q21', type: 'text', question: "Cho $v(t)=4t$. Qu√£ng ƒë∆∞·ªùng ƒëi t·ª´ $t=0$ ƒë·∫øn $t=3$ l√†:", acceptable: ["18"], explanation: "18" },
             { id: 'd317_q22', type: 'text', question: "Gi√° tr·ªã trung b√¨nh c·ªßa $f(x)=2x$ tr√™n $[0, 2]$ l√†:", acceptable: ["2"], explanation: "2" }
        ];

        // --- C√ÅC H√ÄM LOGIC, COMPONENTS V√Ä APP MAIN GI·ªÆ NGUY√äN ---
        
        const PASSING_SCORE = 6.0;
        
        const generateRandomQuiz = () => {
             // Logic tr·ªôn ƒë·ªÅ: L·∫•y ƒë·ªß 22 c√¢u theo c·∫•u tr√∫c 12-4-6
             const mcqPool = QUESTION_BANK.filter(q => q.type === 'mcq');
             const tfPool = QUESTION_BANK.filter(q => q.type === 'group_tf');
             const textPool = QUESTION_BANK.filter(q => q.type === 'text');
             
             // Shuffle v√† slice
             const selectedMcq = [...mcqPool].sort(() => 0.5 - Math.random()).slice(0, 12);
             const selectedTf = [...tfPool].sort(() => 0.5 - Math.random()).slice(0, 4);
             const selectedText = [...textPool].sort(() => 0.5 - Math.random()).slice(0, 6);
             
             // N·∫øu ch∆∞a ƒë·ªß c√¢u (do d·ªØ li·ªáu demo √≠t), l·∫•y h·∫øt nh·ªØng g√¨ c√≥
             // Trong th·ª±c t·∫ø khi b·∫°n ƒëi·ªÅn ƒë·ªß, n√≥ s·∫Ω l·∫•y ƒë√∫ng 22 c√¢u
             return [...selectedMcq, ...selectedTf, ...selectedText];
        };

        const calculateScore = (currentQuestions, answers) => {
            let score = 0;
            let totalMaxScore = 0; 

            currentQuestions.forEach(q => {
                let questionMaxScore = 0;
                let questionScore = 0;

                if (q.type === 'mcq') {
                    questionMaxScore = 0.25;
                    if (answers[q.id] === q.correct) questionScore = 0.25;
                } else if (q.type === 'text') {
                    questionMaxScore = 0.5;
                    const userAns = (answers[q.id] || "").trim();
                    if (q.acceptable.includes(userAns)) questionScore = 0.5;
                } else if (q.type === 'group_tf') {
                    questionMaxScore = 1.0;
                    let correctCount = 0;
                    const userGroupAns = answers[q.id] || {};
                    q.subQuestions.forEach(sub => {
                        if (userGroupAns[sub.id] === sub.correct) correctCount++;
                    });
                    if (correctCount === 1) questionScore = 0.1;
                    else if (correctCount === 2) questionScore = 0.25;
                    else if (correctCount === 3) questionScore = 0.5;
                    else if (correctCount === 4) questionScore = 1.0;
                }
                
                score += questionScore;
                totalMaxScore += questionMaxScore;
            });
            
            // N·∫øu t·ªïng ƒëi·ªÉm t·ªëi ƒëa < 10, quy ƒë·ªïi v·ªÅ 10. N·∫øu >= 10, gi·ªØ nguy√™n.
            // Logic n√†y ƒë·∫£m b·∫£o n·∫øu b·∫°n ch·ªâ test 5 c√¢u th√¨ v·∫´n ƒë∆∞·ª£c 10 ƒëi·ªÉm n·∫øu ƒë√∫ng h·∫øt.
            if (totalMaxScore > 0) {
                 const scaledScore = (score / totalMaxScore) * 10;
                 return Math.round(scaledScore * 100) / 100;
            }
            return 0;
        };
        
        // ... (C√°c Component WelcomeScreen, StudentNameInput, QuizView, SolutionView, TeacherLogin, TeacherDashboard gi·ªØ nguy√™n nh∆∞ phi√™n b·∫£n tr∆∞·ªõc) ...
        
        const WelcomeScreen = ({ onSelectMode, isOnline }) => (
            <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-cyan-600 to-blue-800 p-4 text-white">
                <div className="bg-white/10 backdrop-blur-md p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border border-white/20">
                    <h1 className="text-4xl font-bold mb-2">TRANDAIEDU</h1>
                    <h2 className="text-xl mb-8 text-cyan-100 font-medium">CHUY√äN ƒê·ªÄ NGUY√äN H√ÄM T√çCH PH√ÇN</h2>
                    {!isOnline && (<div className="mb-6 bg-yellow-500/20 text-yellow-200 p-3 rounded-lg text-sm border border-yellow-500/50 flex items-center justify-center gap-2"><Icon name="alert" size={16}/> Ch·∫ø ƒë·ªô Offline: K·∫øt qu·∫£ s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u.</div>)}
                    <div className="space-y-4">
                        <button onClick={() => onSelectMode('student')} className="w-full py-4 bg-white text-blue-800 rounded-xl font-bold hover:bg-blue-50 transition-all shadow-lg flex items-center justify-center gap-2"><Icon name="user"/> H·ªçc Sinh V√†o Thi</button>
                        <button onClick={() => onSelectMode('teacher')} className="w-full py-4 bg-blue-900/50 text-white rounded-xl font-bold hover:bg-blue-900 transition-all border border-blue-400/30 flex items-center justify-center gap-2"><Icon name="lock"/> Gi√°o Vi√™n Xem ƒêi·ªÉm</button>
                    </div>
                </div>
            </div>
        );

        const StudentNameInput = ({ onStart }) => {
            const [name, setName] = useState('');
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50 p-4">
                    <form onSubmit={(e) => { e.preventDefault(); if(name.trim()) onStart(name); }} className="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2 text-center">Nh·∫≠p Th√¥ng Tin</h2>
                        <div className="mb-6">
                            <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500" placeholder="H·ªç v√† t√™n..." required />
                            <p className="text-xs text-green-600 mt-2 flex items-center gap-1"><Icon name="check" size={12}/> Ch·∫ø ƒë·ªô: H·ªçc sinh (Kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p)</p>
                        </div>
                        <button type="submit" className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors">B·∫Øt ƒê·∫ßu</button>
                    </form>
                </div>
            );
        };

        const QuizView = ({ studentName, questions, onSubmit, isConnected }) => {
            const [answers, setAnswers] = useState({});
            const [isSubmitting, setIsSubmitting] = useState(false);
            useEffect(() => { window.scrollTo(0, 0); }, []);
            const handleMcqChange = (qId, optIdx) => setAnswers(prev => ({ ...prev, [qId]: optIdx }));
            const handleTfChange = (qId, subId, val) => setAnswers(prev => ({ ...prev, [qId]: { ...(prev[qId] || {}), [subId]: val } })); // Fixed TF handler
            const handleTextChange = (qId, val) => setAnswers(prev => ({ ...prev, [qId]: val }));
            const handleConfirmSubmit = async () => {
                if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?")) {
                    setIsSubmitting(true);
                    try { await onSubmit(answers); } catch (error) { setIsSubmitting(false); }
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 pb-20 relative">
                    <div className="bg-white shadow-md p-4 sticky top-0 z-10 border-b border-gray-200">
                        <div className="max-w-3xl mx-auto flex justify-between items-center">
                            <div className="font-bold text-blue-700 flex items-center gap-2"><Icon name="user" size={18}/> {studentName}</div>
                            <div className="flex items-center gap-3">
                                {isConnected ? <span className="flex items-center gap-1 text-xs text-green-600 font-bold bg-green-50 px-2 py-1 rounded-full border border-green-200"><Icon name="wifi" size={14}/> Online</span> : <span className="flex items-center gap-1 text-xs text-red-600 font-bold bg-red-50 px-2 py-1 rounded-full border border-red-200 animate-pulse"><Icon name="wifioff" size={14}/> Offline</span>}
                            </div>
                        </div>
                    </div>
                    <div className="max-w-3xl mx-auto p-4 space-y-8 mt-4">
                        {questions.map((q, idx) => (
                            <div key={q.id} className="bg-white rounded-xl shadow-sm p-6">
                                <div className="mb-3">
                                    <span className={`inline-block text-xs font-bold px-2 py-1 rounded mb-2 ${q.type === 'mcq' ? 'bg-blue-100 text-blue-800' : q.type === 'group_tf' ? 'bg-purple-100 text-purple-800' : 'bg-orange-100 text-orange-800'}`}>
                                        {q.type === 'mcq' ? 'Ph·∫ßn 1: Tr·∫Øc nghi·ªám' : q.type === 'group_tf' ? 'Ph·∫ßn 2: ƒê√∫ng/Sai' : 'Ph·∫ßn 3: Tr·∫£ l·ªùi ng·∫Øn'}
                                    </span>
                                    <div className="font-medium text-gray-800 flex gap-2">
                                        <span className="font-bold text-blue-600 whitespace-nowrap">C√¢u {idx + 1}:</span>
                                        <MathText text={q.question} />
                                    </div>
                                    {q.image && <div className="mt-3 flex justify-center">{q.image}</div>}
                                </div>
                                {q.type === 'mcq' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        {q.options.map((opt, optIdx) => (
                                            <button key={optIdx} onClick={() => handleMcqChange(q.id, optIdx)} className={`p-3 text-left rounded-lg border text-sm transition-all ${answers[q.id] === optIdx ? 'bg-blue-100 border-blue-500 text-blue-800 font-medium ring-1 ring-blue-500' : 'hover:bg-gray-50 border-gray-200'}`}>
                                                <span className="font-bold mr-2">{String.fromCharCode(65 + optIdx)}.</span><MathText text={opt} />
                                            </button>
                                        ))}
                                    </div>
                                )}
                                {q.type === 'group_tf' && (
                                    <div className="border rounded-lg overflow-hidden">
                                        <table className="w-full text-sm">
                                            <thead className="bg-gray-100"><tr><th className="p-3 text-left">M·ªánh ƒë·ªÅ</th><th className="p-3 w-16 text-center">ƒê√∫ng</th><th className="p-3 w-16 text-center">Sai</th></tr></thead>
                                            <tbody className="divide-y">
                                                {q.subQuestions.map(sub => {
                                                    const currentVal = (answers[q.id] || {})[sub.id];
                                                    return (
                                                        <tr key={sub.id} className="hover:bg-gray-50">
                                                            <td className="p-3"><MathText text={sub.text} /></td>
                                                            <td className="p-3 text-center"><input type="radio" name={`${q.id}-${sub.id}`} checked={currentVal === true} onChange={() => handleTfChange(q.id, sub.id, true)} className="w-5 h-5 cursor-pointer accent-blue-600"/></td>
                                                            <td className="p-3 text-center"><input type="radio" name={`${q.id}-${sub.id}`} checked={currentVal === false} onChange={() => handleTfChange(q.id, sub.id, false)} className="w-5 h-5 cursor-pointer accent-red-600"/></td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                                {q.type === 'text' && (
                                    <input type="text" value={answers[q.id] || ''} onChange={(e) => handleTextChange(q.id, e.target.value)} className="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nh·∫≠p ƒë√°p √°n..." />
                                )}
                            </div>
                        ))}
                        <div className="flex justify-center pt-6">
                            <button onClick={handleConfirmSubmit} disabled={isSubmitting} className={`px-8 py-4 text-white text-lg font-bold rounded-xl shadow-lg flex items-center gap-2 transition-all ${isSubmitting ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 transform hover:scale-105'}`}>
                                {isSubmitting ? <><Icon name="loader"/> ƒêANG G·ª¨I...</> : <><Icon name="save"/> N·ªòP B√ÄI</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const SolutionView = ({ questions, answers, score, onRetry }) => {
            const [openExplain, setOpenExplain] = useState({});
            const toggleExplain = (id) => setOpenExplain(prev => ({ ...prev, [id]: !prev[id] }));
            const isPassed = score >= PASSING_SCORE;

            return (
                <div className={`min-h-screen pb-20 ${isPassed ? 'bg-green-50' : 'bg-red-50'}`}>
                    <div className={`shadow p-6 text-center mb-6 ${isPassed ? 'bg-white' : 'bg-white border-b-4 border-red-500'}`}>
                        <div className="flex justify-center mb-2">{isPassed ? <Icon name="trophy" size={56} className="text-yellow-500"/> : <Icon name="alert" size={56} className="text-red-500"/>}</div>
                        <h2 className={`text-2xl font-bold ${isPassed ? 'text-green-700' : 'text-red-700'}`}>{isPassed ? "Ch√∫c M·ª´ng! B·∫°n ƒê√£ V∆∞·ª£t Qua" : "Ch∆∞a ƒê·∫°t Y√™u C·∫ßu"}</h2>
                        <div className={`mt-4 inline-block px-6 py-3 rounded-xl border ${isPassed ? 'bg-green-100 border-green-200' : 'bg-red-100 border-red-200'}`}>
                            <span className="text-gray-600 uppercase text-xs font-bold block">T·ªïng ƒêi·ªÉm</span>
                            <span className={`text-4xl font-bold ${isPassed ? 'text-green-700' : 'text-red-700'}`}>{score.toFixed(2)}<span className="text-xl text-gray-500">/10</span></span>
                        </div>
                        <p className="text-gray-600 mt-3 text-sm max-w-md mx-auto">{isPassed ? "K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c l∆∞u. H√£y xem l·∫°i l·ªùi gi·∫£i chi ti·∫øt b√™n d∆∞·ªõi." : `B·∫°n c·∫ßn ƒë·∫°t t·ªëi thi·ªÉu ${PASSING_SCORE} ƒëi·ªÉm. K·∫øt qu·∫£ n√†y KH√îNG ƒë∆∞·ª£c l∆∞u. H√£y b·∫•m n√∫t "L√†m l·∫°i ƒë·ªÅ m·ªõi" ·ªü cu·ªëi trang.`}</p>
                    </div>

                    {isPassed ? (
                        <div className="max-w-3xl mx-auto p-4 space-y-6">
                            <h3 className="font-bold text-gray-700 flex items-center gap-2 mb-4"><Icon name="check" size={20}/> Chi Ti·∫øt B√†i L√†m & L·ªùi Gi·∫£i</h3>
                            {questions.map((q, idx) => {
                                const isOpen = openExplain[q.id];
                                return (
                                    <div key={q.id} className="bg-white rounded-lg shadow-sm border-l-4 border-blue-400 overflow-hidden">
                                        <div className="p-4 cursor-pointer" onClick={() => toggleExplain(q.id)}>
                                            <div className="flex justify-between items-start">
                                                <div className="font-medium text-gray-800 flex-1 flex gap-2"><span className="font-bold whitespace-nowrap">C√¢u {idx + 1}:</span> <MathText text={q.question} /></div>
                                            </div>
                                            <div className="text-right text-xs text-blue-500 mt-2">Xem chi ti·∫øt √Ω ƒë√∫ng/sai ‚ñº</div>
                                        </div>
                                        {isOpen && (
                                            <div className="bg-blue-50 p-4 text-sm text-blue-900 border-t border-blue-100">
                                                {q.image && <div className="mb-4 flex justify-center">{q.image}</div>}
                                                <span className="font-bold block mb-1">üí° L·ªùi gi·∫£i chi ti·∫øt:</span>
                                                <MathText text={q.explanation} />
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <div className="max-w-md mx-auto p-8 text-center text-gray-500">
                            <div className="flex justify-center mb-4"><Icon name="eyeoff" size={64} className="text-gray-300"/></div>
                            <p className="text-lg font-medium text-gray-600 mb-2">Ch·∫ø ƒë·ªô √¥n t·∫≠p</p>
                            <p className="text-sm">H·ªá th·ªëng ƒë√£ ·∫©n to√†n b·ªô c√¢u h·ªèi v√† l·ªùi gi·∫£i ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh kh√°ch quan khi b·∫°n l√†m l·∫°i ƒë·ªÅ.</p>
                        </div>
                    )}
                    <div className="flex justify-center pt-6 pb-10">
                        {isPassed ? <button onClick={() => window.location.reload()} className="px-8 py-3 bg-gray-600 text-white rounded-lg font-bold hover:bg-gray-700 shadow-lg flex items-center gap-2"><Icon name="logout"/> V·ªÅ trang ch·ªß</button> : <button onClick={onRetry} className="px-8 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 shadow-lg flex items-center gap-2 animate-bounce"><Icon name="retry"/> L√†m l·∫°i ƒë·ªÅ m·ªõi</button>}
                    </div>
                </div>
            );
        };

        const TeacherLogin = ({ onLogin, onBack }) => {
            const [pass, setPass] = useState('');
            const [error, setError] = useState('');
            const handleLogin = (e) => { e.preventDefault(); if (pass === '12345678T') { onLogin(); } else { setError('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!'); } };
            return ( <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4"> <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm"> <h2 className="text-xl font-bold mb-6 text-gray-800 text-center">Gi√°o Vi√™n ƒêƒÉng Nh·∫≠p</h2> <form onSubmit={handleLogin} className="space-y-4"> <input type="password" value={pass} onChange={(e) => setPass(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." autoFocus/> {error && <p className="text-red-500 text-sm text-center">{error}</p>} <button type="submit" className="w-full py-3 bg-blue-700 text-white rounded-lg font-bold hover:bg-blue-800">Truy c·∫≠p</button> <button type="button" onClick={onBack} className="w-full py-2 text-gray-500 hover:text-gray-800 text-sm">Quay l·∫°i</button> </form> </div> </div> );
        };

        const TeacherDashboard = ({ onLogout }) => {
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(true);
            useEffect(() => {
                if (!isFirebaseReady || !db) { setLoading(false); return; }
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results_conditional_prob');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => {
                        const d = doc.data();
                        let time = 0;
                        if (d.timestamp && d.timestamp.seconds) { time = d.timestamp.seconds; } else if (d.timestamp instanceof Date) { time = d.timestamp.getTime() / 1000; } else if (typeof d.timestamp === 'string') { time = new Date(d.timestamp).getTime() / 1000; }
                        return { id: doc.id, ...d, sortTime: time };
                    });
                    data.sort((a, b) => b.sortTime - a.sortTime);
                    setResults(data);
                    setLoading(false);
                }, (error) => { console.error("L·ªói t·∫£i d·ªØ li·ªáu:", error); setLoading(false); });
                return () => unsubscribe();
            }, []);

            if (!isFirebaseReady) { return ( <div className="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4"> <div className="bg-white p-8 rounded-xl shadow text-center"> <h2 className="text-xl font-bold mb-4">Khu v·ª±c Gi√°o vi√™n</h2> <p className="text-gray-600 mb-6">Ch·∫ø ƒë·ªô Offline kh√¥ng h·ªó tr·ª£ xem b·∫£ng ƒëi·ªÉm.</p> <button onClick={onLogout} className="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700">ƒêƒÉng xu·∫•t</button> </div> </div> ); }

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="bg-white shadow px-6 py-4 flex justify-between items-center sticky top-0 z-10">
                        <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2"><Icon name="list" className="text-blue-600"/> B·∫£ng ƒêi·ªÉm (Ch·ªâ hi·ªán b√†i ƒë·∫°t)</h1>
                        <button onClick={onLogout} className="text-red-600 hover:bg-red-50 px-4 py-2 rounded-lg flex items-center gap-2 font-medium"><Icon name="logout" size={18}/> ƒêƒÉng xu·∫•t</button>
                    </div>
                    <div className="max-w-6xl mx-auto p-6">
                        <div className="bg-white rounded-xl shadow overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-100 border-b"><tr><th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase">Th·ªùi gian</th><th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase">H·ªç v√† T√™n</th><th className="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase">ƒêi·ªÉm S·ªë (10)</th><th className="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase">X·∫øp lo·∫°i</th></tr></thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {loading ? ( <tr><td colSpan="4" className="p-8 text-center text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr> ) : results.length === 0 ? ( <tr><td colSpan="4" className="p-8 text-center text-gray-500">Ch∆∞a c√≥ b√†i thi n√†o ƒë∆∞·ª£c n·ªôp.</td></tr> ) : results.map((res) => (
                                            <tr key={res.id} className="hover:bg-gray-50">
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{res.timestamp ? new Date(res.sortTime * 1000).toLocaleString('vi-VN') : 'V·ª´a xong'}</td>
                                                <td className="px-6 py-4 whitespace-nowrap font-medium text-gray-900">{res.name}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-center"><span className="text-lg font-bold text-blue-700">{res.score?.toFixed(2)}</span></td>
                                                <td className="px-6 py-4 whitespace-nowrap text-center"><span className={`px-3 py-1 rounded-full text-xs font-bold ${res.score >= 8 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>{res.score >= 8 ? 'Gi·ªèi' : res.score >= 6.5 ? 'Kh√°' : 'Trung B√¨nh'}</span></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('welcome');
            const [user, setUser] = useState(null);
            const [studentName, setStudentName] = useState('');
            const [currentQuestions, setCurrentQuestions] = useState([]);
            const [finalScore, setFinalScore] = useState(0);
            const [userAnswers, setUserAnswers] = useState({});

            useEffect(() => {
                if (isFirebaseReady && auth) {
                    signInAnonymously(auth).catch(e => console.warn(e));
                    const unsubscribe = onAuthStateChanged(auth, (u) => { if (u) setUser(u); });
                    return () => unsubscribe();
                }
            }, []);

            const startNewQuiz = (name) => {
                setStudentName(name);
                const newQuestions = generateRandomQuiz();
                setCurrentQuestions(newQuestions);
                setView('quiz');
            };

            const handleRetry = () => {
                const newQuestions = generateRandomQuiz();
                setCurrentQuestions(newQuestions);
                setView('quiz');
            };

            const handleSubmitQuiz = async (answers) => {
                const score = calculateScore(currentQuestions, answers);
                setFinalScore(score);
                setUserAnswers(answers);
                if (score >= PASSING_SCORE && isFirebaseReady && user) {
                    try {
                        const sanitizedAnswers = JSON.parse(JSON.stringify(answers));
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results_conditional_prob'), {
                            name: studentName, score: score, questionIds: currentQuestions.map(q => q.id), answers: sanitizedAnswers, timestamp: new Date().toISOString()
                        });
                    } catch (error) { console.error("L·ªói Firestore:", error); }
                }
                setView('result'); 
            };

            return (
                <div>
                    {view === 'welcome' && <WelcomeScreen onSelectMode={(mode) => setView(mode === 'student' ? 'name' : 'login')} isOnline={isFirebaseReady} />}
                    {view === 'name' && <StudentNameInput onStart={startNewQuiz} />}
                    {view === 'quiz' && <QuizView studentName={studentName} questions={currentQuestions} onSubmit={handleSubmitQuiz} isConnected={isFirebaseReady} />}
                    {view === 'result' && <SolutionView questions={currentQuestions} answers={userAnswers} score={finalScore} onRetry={handleRetry} />}
                    {view === 'login' && <TeacherLogin onLogin={() => setView('teacher')} onBack={() => setView('welcome')} />}
                    {view === 'teacher' && <TeacherDashboard onLogout={() => setView('welcome')} />}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
