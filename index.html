<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool S·ªë H√≥a (Support Gemini 2.5)</title>
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #eef2f6; }
        .container { max-width: 1200px; margin: 0 auto; display: flex; gap: 20px; }
        .box { flex: 1; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { color: #2563eb; text-align: center; margin-bottom: 30px; }
        input, button, textarea { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        button { background: #2563eb; color: white; font-weight: bold; border: none; cursor: pointer; transition: 0.2s; }
        button:hover { background: #1d4ed8; }
        button:disabled { background: #94a3b8; }
        .log-box { margin-top: 15px; padding: 10px; background: #f8fafc; border-radius: 8px; font-size: 0.9em; max-height: 200px; overflow-y: auto; border: 1px dashed #cbd5e1; }
        .log-item { margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        .success { color: green; font-weight: bold; }
        .error { color: red; }
    </style>
</head>
<body>

<h1>‚ú® TOOL S·ªê H√ìA (H·ªñ TR·ª¢ GEMINI 2.5) ‚ú®</h1>

<div class="container">
    <div class="box">
        <h3>1. C·∫•u h√¨nh</h3>
        <input type="password" id="geminiKey" placeholder="D√°n Gemini API Key c·ªßa b·∫°n v√†o ƒë√¢y...">
        <input type="file" id="fileInput" accept="image/*, application/pdf">
        <button id="btnRun" onclick="startProcess()">üöÄ CH·∫†Y NGAY</button>
        
        <div id="statusLog" class="log-box">Tr·∫°ng th√°i s·∫Ω hi·ªán ·ªü ƒë√¢y...</div>
    </div>

    <div class="box">
        <h3>2. K·∫øt qu·∫£ JSON</h3>
        <textarea id="output" rows="15" placeholder="K·∫øt qu·∫£ JSON..."></textarea>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // C·∫¨P NH·∫¨T DANH S√ÅCH MODEL D·ª∞A TR√äN ·∫¢NH JSON C·ª¶A B·∫†N
    const MODEL_LIST = [
        "gemini-2.5-flash",      // ∆Øu ti√™n 1: B·∫£n m·ªõi nh·∫•t trong t√†i kho·∫£n b·∫°n
        "gemini-2.5-pro",        // ∆Øu ti√™n 2: B·∫£n Pro m·ªõi
        "gemini-2.0-flash-exp",  // ∆Øu ti√™n 3: B·∫£n th·ª≠ nghi·ªám
        "gemini-1.5-flash",      // D·ª± ph√≤ng
        "gemini-pro"             // C≈© nh·∫•t
    ];

    async function fileToBase64(file) {
        return new Promise((r) => {
            const reader = new FileReader();
            reader.onloadend = () => r(reader.result.split(',')[1]);
            reader.readAsDataURL(file);
        });
    }

    window.startProcess = async () => {
        // --- 1. L·∫§Y KEY (∆Øu ti√™n l·∫•y t·ª´ √¥ nh·∫≠p, n·∫øu tr·ªëng th√¨ d√πng key c·ª©ng ƒë·ªÉ test) ---
        let key = document.getElementById('geminiKey').value.trim();
        
        // M·∫∏O: B·∫°n c√≥ th·ªÉ d√°n c·ª©ng Key v√†o d√≤ng d∆∞·ªõi ƒë·ªÉ ƒë·ª° ph·∫£i nh·∫≠p l·∫°i nhi·ªÅu l·∫ßn
        // if (!key) key = "AIzaSy_KEY_CUA_BAN"; 

        const fileInput = document.getElementById('fileInput');
        const log = document.getElementById('statusLog');
        const out = document.getElementById('output');
        const btn = document.getElementById('btnRun');
        
        if (!key || !fileInput.files.length) { alert("Thi·∫øu Key ho·∫∑c File!"); return; }

        log.innerHTML = "‚è≥ ƒêang kh·ªüi ƒë·ªông...";
        out.value = "";
        btn.disabled = true;

        try {
            const file = fileInput.files[0];
            const fileData = await fileToBase64(file);
            const genAI = new GoogleGenerativeAI(key);
            
            let success = false;

            // --- 2. V√íNG L·∫∂P TH√îNG MINH ---
            for (const modelName of MODEL_LIST) {
                log.innerHTML = `<div class='log-item' style='color:blue'>üîÑ ƒêang th·ª≠ k·∫øt n·ªëi model: <b>${modelName}</b>...</div>` + log.innerHTML;
                
                try {
                    const model = genAI.getGenerativeModel({ model: modelName });
                    const result = await model.generateContent([
                        "H√£y tr√≠ch xu·∫•t n·ªôi dung file n√†y th√†nh JSON c√¢u h·ªèi tr·∫Øc nghi·ªám. D√πng LaTeX cho to√°n ($...$). N·∫øu c√≥ h√¨nh v·∫Ω, h√£y m√¥ t·∫£ ho·∫∑c v·∫Ω SVG. Tr·∫£ v·ªÅ JSON thu·∫ßn.", 
                        { inlineData: { data: fileData, mimeType: file.type } }
                    ]);
                    
                    const text = result.response.text();
                    // L√†m s·∫°ch JSON
                    out.value = text.replace(/```json/g, "").replace(/```/g, "").trim();
                    
                    log.innerHTML = `<div class='log-item success'>‚úÖ TH√ÄNH C√îNG V·ªöI ${modelName}!</div>` + log.innerHTML;
                    success = true;
                    break; // D·ª´ng l·∫°i ngay khi t√¨m ƒë∆∞·ª£c model ƒë√∫ng

                } catch (e) {
                    console.error(e);
                    let errMsg = e.message;
                    if (errMsg.includes("404")) errMsg = "Kh√¥ng t√¨m th·∫•y (Do t√†i kho·∫£n ch∆∞a h·ªó tr·ª£ version n√†y)";
                    log.innerHTML = `<div class='log-item error'>‚ùå ${modelName} th·∫•t b·∫°i: ${errMsg}</div>` + log.innerHTML;
                }
            }

            if (!success) {
                log.innerHTML = `<div class='log-item error'>üò≠ Th·∫•t b·∫°i to√†n t·∫≠p. Key ƒë√∫ng nh∆∞ng kh√¥ng model n√†o nh·∫≠n.</div>` + log.innerHTML;
            }

        } catch (e) {
            alert("L·ªói h·ªá th·ªëng: " + e.message);
        } finally {
            btn.disabled = false;
        }
    };
</script>
</body>
</html>
