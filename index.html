<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRANDAIEDU - ƒê·ªÅ Thi Th·ª≠ T·ªët Nghi·ªáp THPT 2025 - M√¥n To√°n</title>
    
    <!-- React & ReactDOM (UMD) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase (Compat version for HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .katex { font-size: 1.1em; }
        /* Animation utilities */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // ==================================================================================
        // C·∫§U H√åNH FIREBASE C·ª¶A B·∫†N
        // ==================================================================================
        
        const USER_CONFIG = {
            apiKey: "AIzaSyCEgOrAaEHjZbhYTSkVHGRkGa8WfjjnWvg",
            authDomain: "trandaiedu-39df1.firebaseapp.com",
            projectId: "trandaiedu-39df1",
            storageBucket: "trandaiedu-39df1.firebasestorage.app",
            messagingSenderId: "286264195114",
            appId: "1:286264195114:web:c6ca2fe8e1b3e7e25ceb53",
            measurementId: "G-JB82DY2KHT"
        };

        // --- H·ªÜ TH·ªêNG FIREBASE & UTILS ---
        
        let db = null;
        let auth = null;
        let isUsingCustomConfig = false;
        let appId = 'default-app-id';

        // H√†m kh·ªüi t·∫°o Firebase an to√†n
        const initializeFirebase = () => {
            try {
                if (!window.firebase) {
                    console.error("Th∆∞ vi·ªán Firebase ch∆∞a t·∫£i xong.");
                    return false;
                }

                if (firebase.apps.length > 0) {
                    if (!auth) auth = firebase.auth();
                    if (!db) db = firebase.firestore();
                    return true;
                }

                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    const config = typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : __firebase_config;
                    firebase.initializeApp(config);
                    if (typeof __app_id !== 'undefined') appId = __app_id;
                    console.log("Firebase: ƒê√£ k·∫øt n·ªëi qua Environment (Canvas).");
                } 
                else if (USER_CONFIG.apiKey && USER_CONFIG.apiKey.length > 0) {
                    firebase.initializeApp(USER_CONFIG);
                    isUsingCustomConfig = true;
                    console.log("Firebase: ƒê√£ k·∫øt n·ªëi qua USER_CONFIG.");
                } else {
                    console.warn("Firebase: Ch∆∞a c√≥ c·∫•u h√¨nh. Vui l√≤ng ƒëi·ªÅn USER_CONFIG trong code.");
                    return false;
                }

                auth = firebase.auth();
                db = firebase.firestore();
                return true;

            } catch (e) {
                console.error("L·ªói kh·ªüi t·∫°o Firebase:", e);
                return false;
            }
        };

        initializeFirebase();

        const COLLECTION_NAME = "quiz_results_math12_2025_mock";

        // --- ICONS ---
        const Icon = ({ name, size=24, className="" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                   const iconElement = window.lucide.icons[name];
                   if(iconElement) {
                       iconRef.current.innerHTML = iconElement.toSvg({ class: className, width: size, height: size });
                   }
                }
            }, [name, size, className]);
            return <span ref={iconRef} className={className} style={{display: 'inline-flex', alignItems: 'center'}}></span>;
        };

        // --- MATH RENDERER ---
        const MathText = ({ text, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && text && window.renderMathInElement) {
                    renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "$", right: "$", display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, [text]);
            return <span ref={containerRef} className={className} dangerouslySetInnerHTML={{__html: text}} />;
        };

        // --- SVG IMAGES (NEW EXAM) ---
        
        const ArrowDefs = () => (
            <defs>
                <marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="black" />
                </marker>
                <marker id="arrow2" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="black" />
                </marker>
            </defs>
        );

        const GraphP1Q1 = () => (
            <div className="flex justify-center my-4">
                <svg width="200" height="150" viewBox="-50 -50 200 150" className="border border-gray-200 bg-white rounded shadow-sm">
                    <ArrowDefs />
                    <line x1="-40" y1="0" x2="140" y2="0" stroke="black" strokeWidth="1.5" markerEnd="url(#arrow)" />
                    <line x1="0" y1="-40" x2="0" y2="90" stroke="black" strokeWidth="1.5" markerEnd="url(#arrow)" />
                    <text x="130" y="-5" fontSize="12">x</text>
                    <text x="5" y="85" fontSize="12">y</text>
                    <text x="-10" y="10" fontSize="12">O</text>
                    <path d="M -20 80 Q 0 -10 20 20 T 60 20 T 100 80" stroke="blue" strokeWidth="2" fill="none"/>
                    <circle cx="20" cy="20" r="2" fill="red"/>
                    <line x1="20" y1="20" x2="20" y2="0" stroke="gray" strokeDasharray="4"/>
                    <text x="18" y="-5" fontSize="10">1</text>
                    <line x1="20" y1="20" x2="0" y2="20" stroke="gray" strokeDasharray="4"/>
                    <text x="-15" y="25" fontSize="10">2</text>
                </svg>
            </div>
        );

        const GraphP1Q2 = () => (
            <div className="flex justify-center my-4">
                <svg width="150" height="120" className="border border-gray-200 bg-white rounded shadow-sm">
                    <polygon points="40,90 110,90 130,60 60,60" fill="none" stroke="black" strokeWidth="1"/>
                    <polygon points="40,40 110,40 130,10 60,10" fill="none" stroke="black" strokeWidth="1"/>
                    <line x1="40" y1="90" x2="40" y2="40" stroke="black" strokeWidth="1"/>
                    <line x1="110" y1="90" x2="110" y2="40" stroke="black" strokeWidth="1"/>
                    <line x1="130" y1="60" x2="130" y2="10" stroke="black" strokeWidth="1"/>
                    <line x1="60" y1="60" x2="60" y2="10" stroke="black" strokeWidth="1" strokeDasharray="4"/>
                    <line x1="60" y1="60" x2="40" y2="90" stroke="black" strokeWidth="1" strokeDasharray="4"/>
                    <line x1="60" y1="60" x2="130" y2="60" stroke="black" strokeWidth="1" strokeDasharray="4"/>
                    <text x="35" y="100" fontSize="10">A</text> <text x="110" y="100" fontSize="10">B</text>
                    <text x="135" y="65" fontSize="10">C</text> <text x="50" y="65" fontSize="10">D</text>
                    <text x="35" y="38" fontSize="10">A'</text> <text x="110" y="38" fontSize="10">B'</text>
                    <text x="135" y="10" fontSize="10">C'</text> <text x="50" y="10" fontSize="10">D'</text>
                </svg>
            </div>
        );

        const GraphP1Q10 = () => (
            <div className="flex justify-center my-4">
                <svg width="150" height="150" className="border border-gray-200 bg-white rounded shadow-sm">
                    <polygon points="40,110 110,110 130,80 60,80" fill="none" stroke="black" strokeWidth="1"/>
                    <line x1="85" y1="20" x2="40" y2="110" stroke="black" strokeWidth="1"/>
                    <line x1="85" y1="20" x2="110" y2="110" stroke="black" strokeWidth="1"/>
                    <line x1="85" y1="20" x2="130" y2="80" stroke="black" strokeWidth="1"/>
                    <line x1="85" y1="20" x2="60" y2="80" stroke="black" strokeWidth="1" strokeDasharray="4"/>
                    <line x1="85" y1="20" x2="85" y2="95" stroke="black" strokeWidth="1" strokeDasharray="4"/> 
                    <line x1="40" y1="110" x2="130" y2="80" stroke="black" strokeWidth="1" strokeDasharray="4"/> 
                    <text x="85" y="15" fontSize="12">S</text>
                    <text x="30" y="115" fontSize="12">D</text>
                    <text x="115" y="115" fontSize="12">C</text>
                    <text x="135" y="80" fontSize="12">B</text>
                    <text x="50" y="80" fontSize="12">A</text>
                    <text x="85" y="105" fontSize="10">O</text>
                </svg>
            </div>
        );

        const GraphP2Q1 = () => (
            <div className="flex justify-center my-4">
                <svg width="150" height="150" className="border border-gray-200 bg-white rounded shadow-sm">
                    <ArrowDefs />
                    <line x1="0" y1="75" x2="150" y2="75" stroke="black" strokeWidth="1" markerEnd="url(#arrow2)"/>
                    <line x1="75" y1="150" x2="75" y2="0" stroke="black" strokeWidth="1" markerEnd="url(#arrow2)"/>
                    <line x1="55" y1="150" x2="55" y2="0" stroke="red" strokeDasharray="4"/>
                    <line x1="0" y1="35" x2="150" y2="35" stroke="red" strokeDasharray="4"/>
                    <path d="M 0 50 Q 40 55 50 150" stroke="blue" fill="none"/>
                    <path d="M 60 0 Q 70 25 150 25" stroke="blue" fill="none"/>
                    <text x="140" y="70" fontSize="10">x</text> <text x="80" y="10" fontSize="10">y</text>
                    <text x="50" y="85" fontSize="10">-1</text>
                    <text x="80" y="35" fontSize="10">2</text>
                </svg>
            </div>
        );

        const GraphP2Q2 = () => (
            <div className="flex justify-center my-4">
                <svg width="150" height="150" className="border border-gray-200 bg-white rounded shadow-sm">
                    <line x1="75" y1="100" x2="130" y2="100" stroke="black" strokeWidth="1"/> 
                    <line x1="75" y1="100" x2="40" y2="130" stroke="black" strokeWidth="1"/> 
                    <line x1="75" y1="100" x2="75" y2="20" stroke="black" strokeWidth="1"/> 
                    <text x="135" y="100" fontSize="10">y</text>
                    <text x="35" y="135" fontSize="10">x</text>
                    <text x="70" y="15" fontSize="10">z</text>
                    <text x="80" y="95" fontSize="10">O</text>
                    <line x1="75" y1="20" x2="110" y2="115" stroke="blue" strokeWidth="1"/>
                    <line x1="75" y1="20" x2="40" y2="85" stroke="blue" strokeWidth="1"/>
                    <text x="75" y="18" fontSize="10">S</text>
                    <text x="112" y="120" fontSize="10">A</text>
                </svg>
            </div>
        );

        const GraphP3Q1 = () => (
            <div className="flex justify-center my-4">
                <svg width="150" height="150" className="border border-gray-200 bg-white rounded shadow-sm">
                    <rect x="25" y="25" width="100" height="100" fill="#ddd" stroke="black"/>
                    <rect x="25" y="25" width="20" height="20" fill="white" stroke="black" strokeDasharray="2"/>
                    <rect x="105" y="25" width="20" height="20" fill="white" stroke="black" strokeDasharray="2"/>
                    <rect x="25" y="105" width="20" height="20" fill="white" stroke="black" strokeDasharray="2"/>
                    <rect x="105" y="105" width="20" height="20" fill="white" stroke="black" strokeDasharray="2"/>
                    <text x="30" y="40" fontSize="10">x</text>
                    <text x="30" y="115" fontSize="10">x</text>
                </svg>
            </div>
        );

        const GraphP3Q2 = () => (
            <div className="flex justify-center my-4">
                <svg width="150" height="150" className="border border-gray-200 bg-white rounded shadow-sm">
                    <ArrowDefs />
                    <line x1="75" y1="75" x2="115" y2="75" stroke="red" strokeWidth="2" markerEnd="url(#arrow2)"/>
                    <text x="120" y="80" fontSize="10">F1</text>
                    <line x1="75" y1="75" x2="75" y2="35" stroke="red" strokeWidth="2" markerEnd="url(#arrow2)"/>
                    <text x="80" y="30" fontSize="10">F2</text>
                    <line x1="75" y1="75" x2="45" y2="105" stroke="blue" strokeWidth="2" markerEnd="url(#arrow2)"/>
                    <text x="30" y="115" fontSize="10">F3</text>
                    <circle cx="75" cy="75" r="3" fill="black"/>
                    <text x="65" y="85" fontSize="10">O</text>
                </svg>
            </div>
        );

        const GraphP3Q3 = () => (
            <div className="flex justify-center my-4">
                <svg width="150" height="150" className="border border-gray-200 bg-white rounded shadow-sm">
                    <line x1="20" y1="130" x2="130" y2="130" stroke="black"/> 
                    <line x1="20" y1="130" x2="20" y2="20" stroke="black"/> 
                    <line x1="20" y1="30" x2="120" y2="130" stroke="green" strokeWidth="1"/> 
                    <line x1="20" y1="90" x2="100" y2="130" stroke="orange" strokeWidth="1"/> 
                    <text x="100" y="60" fontSize="10">Mi·ªÅn nghi·ªám</text>
                </svg>
            </div>
        );

        const GraphP3Q4 = () => (
            <div className="flex justify-center my-4">
                <svg width="120" height="120" className="border border-gray-200 bg-white rounded shadow-sm">
                    <rect x="30" y="40" width="50" height="50" fill="none" stroke="black"/>
                    <polyline points="30,40 50,20 100,20 100,70 80,90" fill="none" stroke="black"/>
                    <line x1="100" y1="20" x2="50" y2="20" stroke="black"/>
                    <line x1="80" y1="40" x2="80" y2="90" stroke="black"/> 
                    <line x1="30" y1="90" x2="100" y2="20" stroke="red" strokeDasharray="2"/>
                    <text x="20" y="95" fontSize="10">A</text>
                    <text x="105" y="15" fontSize="10">C'</text>
                </svg>
            </div>
        );

        const GraphP3Q6 = () => (
            <div className="flex justify-center my-4">
                <svg width="150" height="100" className="border border-gray-200 bg-white rounded shadow-sm">
                    <path d="M 25 90 Q 75 -10 125 90" stroke="black" fill="none" strokeWidth="2"/>
                    <rect x="55" y="50" width="40" height="40" stroke="blue" fill="none"/>
                    <line x1="10" y1="90" x2="140" y2="90" stroke="black"/>
                    <text x="50" y="50" fontSize="10">A</text> <text x="95" y="50" fontSize="10">B</text>
                    <text x="50" y="90" fontSize="10">D</text> <text x="95" y="90" fontSize="10">C</text>
                </svg>
            </div>
        );

        // --- QUESTION BANK (NEW CONTENT) ---
        const QUESTION_BANK = [
            // --- PH·∫¶N I: TR·∫ÆC NGHI·ªÜM (12 C√¢u) ---
            { 
                id: 'p1_q1', type: 'mcq', 
                question: "Cho h√†m s·ªë $y=f(x)$ c√≥ ƒë·ªì th·ªã l√† ƒë∆∞·ªùng cong nh∆∞ h√¨nh v·∫Ω b√™n d∆∞·ªõi. ƒêi·ªÉm c·ª±c ƒë·∫°i c·ªßa ƒë·ªì th·ªã h√†m s·ªë ƒë√£ cho c√≥ t·ªça ƒë·ªô l√†:", 
                image: <GraphP1Q1 />,
                options: ["$(1; 0)$", "$(0; 2)$", "$(1; 2)$", "$(2; 1)$"], 
                correct: 2, 
                explanation: "Quan s√°t ƒë·ªì th·ªã h√†m b·∫≠c 3, ta th·∫•y ƒëi·ªÉm c·ª±c ƒë·∫°i l√† ƒëi·ªÉm 'ƒë·ªânh n√∫i'. D√≥ng xu·ªëng tr·ª•c ho√†nh ƒë∆∞·ª£c $x=1$, d√≥ng sang tr·ª•c tung ƒë∆∞·ª£c $y=2$. V·∫≠y t·ªça ƒë·ªô l√† $(1; 2)$." 
            },
            { 
                id: 'p1_q2', type: 'mcq', 
                question: "Cho h√¨nh h·ªôp $ABCD.A'B'C'D'$ (xem h√¨nh v·∫Ω). Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y l√† ƒë√∫ng?", 
                image: <GraphP1Q2 />,
                options: ["$\\overrightarrow{AB} + \\overrightarrow{AD} + \\overrightarrow{AA'} = \\overrightarrow{AC}$", "$\\overrightarrow{AB} + \\overrightarrow{AD} + \\overrightarrow{AA'} = \\overrightarrow{AC'}$", "$\\overrightarrow{AB} + \\overrightarrow{AC} + \\overrightarrow{AA'} = \\overrightarrow{AC'}$", "$\\overrightarrow{AB} + \\overrightarrow{AD} = \\overrightarrow{AC'}$"], 
                correct: 1, 
                explanation: "Theo quy t·∫Øc h√¨nh h·ªôp, ta c√≥ $\\overrightarrow{AC'} = \\overrightarrow{AB} + \\overrightarrow{AD} + \\overrightarrow{AA'}$. ƒê√¢y l√† quy t·∫Øc ƒë∆∞·ªùng ch√©o h√¨nh h·ªôp." 
            },
            { 
                id: 'p1_q3', type: 'mcq', 
                question: "M·∫´u s·ªë li·ªáu gh√©p nh√≥m v·ªÅ th·ªùi gian (ph√∫t) ƒëi t·ª´ nh√† ƒë·∫øn tr∆∞·ªùng c·ªßa m·ªôt nh√≥m h·ªçc sinh nh∆∞ sau:<br/>| Th·ªùi gian | [0; 10) | [10; 20) | [20; 30) | [30; 40) |<br/>| S·ªë HS | 5 | 12 | 8 | 5 |<br/>Nh√≥m ch·ª©a trung v·ªã c·ªßa m·∫´u s·ªë li·ªáu tr√™n l√†:", 
                options: ["$[0; 10)$", "$[10; 20)$", "$[20; 30)$", "$[30; 40)$"], 
                correct: 1, 
                explanation: "T·ªïng s·ªë h·ªçc sinh $N = 30$. Trung v·ªã ·ªü v·ªã tr√≠ th·ª© 15 v√† 16. T·∫ßn s·ªë t√≠ch l≈©y: Nh√≥m 1 (5), Nh√≥m 2 (17). V·ªã tr√≠ 15, 16 n·∫±m trong nh√≥m th·ª© 2: $[10; 20)$." 
            },
            { 
                id: 'p1_q4', type: 'mcq', 
                question: "Trong kh√¥ng gian $Oxyz$, cho m·∫∑t ph·∫≥ng $(P): 2x - y + 3z - 1 = 0$. Vect∆° n√†o d∆∞·ªõi ƒë√¢y l√† m·ªôt vect∆° ph√°p tuy·∫øn c·ªßa $(P)$?", 
                options: ["$\\vec{n} = (2; -1; 3)$", "$\\vec{n} = (2; 1; 3)$", "$\\vec{n} = (2; -1; -1)$", "$\\vec{n} = (-2; 1; 3)$"], 
                correct: 0, 
                explanation: "Ph∆∞∆°ng tr√¨nh m·∫∑t ph·∫≥ng $(P): 2x - 1y + 3z - 1 = 0$ c√≥ vect∆° ph√°p tuy·∫øn l√† h·ªá s·ªë c·ªßa $x, y, z$, t·ª©c l√† $\\vec{n} = (2; -1; 3)$." 
            },
            { 
                id: 'p1_q5', type: 'mcq', 
                question: "T·∫≠p nghi·ªám c·ªßa b·∫•t ph∆∞∆°ng tr√¨nh $\\log_2(x-1) < 3$ l√†:", 
                options: ["$(-\\infty; 9)$", "$(1; 9)$", "$(1; 7)$", "$(-\\infty; 7)$"], 
                correct: 1, 
                explanation: "ƒêK: $x > 1$. BPT $\\Leftrightarrow x-1 < 2^3 \\Leftrightarrow x < 9$. K·∫øt h·ª£p ƒêK: $1 < x < 9$." 
            },
            { 
                id: 'p1_q6', type: 'mcq', 
                question: "Cho c·∫•p s·ªë nh√¢n $(u_n)$ c√≥ $u_1 = 3$ v√† c√¥ng b·ªôi $q = 2$. Gi√° tr·ªã c·ªßa $u_4$ b·∫±ng:", 
                options: ["24", "48", "12", "6"], 
                correct: 0, 
                explanation: "$u_4 = u_1 \\cdot q^{4-1} = 3 \\cdot 2^3 = 24$." 
            },
            { 
                id: 'p1_q7', type: 'mcq', 
                question: "Nghi·ªám c·ªßa ph∆∞∆°ng tr√¨nh $\\cos x = \\frac{1}{2}$ l√†:", 
                options: ["$x = \\pm \\frac{\\pi}{3} + k2\\pi$", "$x = \\pm \\frac{\\pi}{6} + k2\\pi$", "$x = \\pm \\frac{\\pi}{3} + k\\pi$", "$x = \\frac{\\pi}{3} + k2\\pi$"], 
                correct: 0, 
                explanation: "$\\cos x = \\frac{1}{2} = \\cos \\frac{\\pi}{3} \\Rightarrow x = \\pm \\frac{\\pi}{3} + k2\\pi$." 
            },
            { 
                id: 'p1_q8', type: 'mcq', 
                question: "Bi·∫øt $\\int_0^1 f(x) dx = 2$ v√† $\\int_0^1 g(x) dx = 5$. Khi ƒë√≥ $\\int_0^1 [f(x) - 2g(x)] dx$ b·∫±ng:", 
                options: ["-8", "-3", "12", "7"], 
                correct: 0, 
                explanation: "$\\int_0^1 [f(x) - 2g(x)] dx = 2 - 2(5) = -8$." 
            },
            { 
                id: 'p1_q9', type: 'mcq', 
                question: "Cho h√†m s·ªë $f(x) = x^4 - 2x^2$. H√†m s·ªë ƒë√£ cho ngh·ªãch bi·∫øn tr√™n kho·∫£ng n√†o d∆∞·ªõi ƒë√¢y?", 
                options: ["$(-\\infty; -1)$", "$(-1; 0)$", "$(0; 1)$", "$(1; +\\infty)$"], 
                correct: 0, 
                explanation: "$f'(x) = 4x^3 - 4x$. $f'(x) < 0$ tr√™n $(-\\infty; -1)$ v√† $(0; 1)$. ƒê√°p √°n A ƒë√∫ng." 
            },
            { 
                id: 'p1_q10', type: 'mcq', 
                question: "Cho h√¨nh ch√≥p t·ª© gi√°c ƒë·ªÅu $S.ABCD$ (xem h√¨nh v·∫Ω). G√≥c gi·ªØa ƒë∆∞·ªùng th·∫≥ng $SA$ v√† m·∫∑t ph·∫≥ng $(ABCD)$ l√† g√≥c n√†o sau ƒë√¢y?", 
                image: <GraphP1Q10 />,
                options: ["$\\widehat{SAB}$", "$\\widehat{SAD}$", "$\\widehat{SAO}$", "$\\widehat{SDA}$"], 
                correct: 2, 
                explanation: "H√¨nh chi·∫øu c·ªßa $S$ l√™n $(ABCD)$ l√† $O$. H√¨nh chi·∫øu c·ªßa $SA$ l√† $AO$. G√≥c c·∫ßn t√¨m l√† $\\widehat{SAO}$." 
            },
            { 
                id: 'p1_q11', type: 'mcq', 
                question: "X√©t ph√©p th·ª≠ gieo m·ªôt con x√∫c x·∫Øc c√¢n ƒë·ªëi v√† ƒë·ªìng ch·∫•t. X√°c su·∫•t ƒë·ªÉ xu·∫•t hi·ªán m·∫∑t c√≥ s·ªë ch·∫•m l√† s·ªë ch·∫µn b·∫±ng:", 
                options: ["1/2", "1/3", "1/6", "2/3"], 
                correct: 0, 
                explanation: "Bi·∫øn c·ªë A (s·ªë ch·∫µn) = $\\{2, 4, 6\\}$. $P(A) = 3/6 = 1/2$." 
            },
            { 
                id: 'p1_q12', type: 'mcq', 
                question: "Trong kh√¥ng gian $Oxyz$, ƒë∆∞·ªùng th·∫≥ng $d: \\frac{x-1}{2} = \\frac{y+2}{-1} = \\frac{z}{3}$ ƒëi qua ƒëi·ªÉm n√†o sau ƒë√¢y?", 
                options: ["$M(1; -2; 0)$", "$N(2; -1; 3)$", "$P(-1; 2; 0)$", "$Q(1; 2; 3)$"], 
                correct: 0, 
                explanation: "Thay t·ªça ƒë·ªô $M(1; -2; 0)$ v√†o ph∆∞∆°ng tr√¨nh ƒë∆∞·ªùng th·∫≥ng th·∫•y th·ªèa m√£n." 
            },

            // --- PH·∫¶N II: ƒê√öNG/SAI (4 C√¢u) ---
            {
                id: 'p2_q1', type: 'group_tf',
                question: "Cho h√†m s·ªë $y = \\frac{2x-1}{x+1}$ c√≥ ƒë·ªì th·ªã $(C)$ nh∆∞ h√¨nh v·∫Ω.",
                image: <GraphP2Q1 />,
                subQuestions: [
                    { id: 'a', text: "Ti·ªám c·∫≠n ƒë·ª©ng c·ªßa ƒë·ªì th·ªã h√†m s·ªë l√† ƒë∆∞·ªùng th·∫≥ng $x = 1$.", correct: false },
                    { id: 'b', text: "H√†m s·ªë ƒë·ªìng bi·∫øn tr√™n c√°c kho·∫£ng $(-\\infty; -1)$ v√† $(-1; +\\infty)$.", correct: true },
                    { id: 'c', text: "Giao ƒëi·ªÉm c·ªßa ƒë·ªì th·ªã v·ªõi tr·ª•c tung l√† ƒëi·ªÉm $M(0; -1)$.", correct: true },
                    { id: 'd', text: "T√¢m ƒë·ªëi x·ª©ng c·ªßa ƒë·ªì th·ªã l√† ƒëi·ªÉm $I(-1; 2)$.", correct: true }
                ],
                explanation: "a) Sai. TCƒê $x = -1$. b) ƒê√∫ng. ƒê·ªì th·ªã ƒëi l√™n t·ª´ tr√°i sang ph·∫£i. c) ƒê√∫ng. $x=0 \\Rightarrow y=-1$. d) ƒê√∫ng. Giao ƒëi·ªÉm 2 ti·ªám c·∫≠n."
            },
            {
                id: 'p2_q2', type: 'group_tf',
                question: "Trong kh√¥ng gian v·ªõi h·ªá t·ªça ƒë·ªô $Oxyz$, m·ªôt ng·ªçn h·∫£i ƒëƒÉng h√¨nh ch√≥p $S.ABCD$ c√≥ ƒë√°y h√¨nh vu√¥ng tr√™n $(Oxy)$, t√¢m $O$. $S(0; 0; 20)$, $A(5; 5; 0)$.",
                image: <GraphP2Q2 />,
                subQuestions: [
                    { id: 'a', text: "Chi·ªÅu cao c·ªßa ng·ªçn h·∫£i ƒëƒÉng l√† 20 m√©t.", correct: true },
                    { id: 'b', text: "Vect∆° $\\overrightarrow{SA} = (5; 5; 20)$.", correct: false },
                    { id: 'c', text: "ƒê·ªô d√†i ƒëo·∫°n th·∫≥ng $SA$ b·∫±ng $5\\sqrt{18}$ m√©t.", correct: true },
                    { id: 'd', text: "M·∫∑t ph·∫≥ng ch·ª©a m·∫∑t b√™n $(SAB)$ c√≥ ph∆∞∆°ng tr√¨nh l√† $4x - 20z + 100 = 0$.", correct: false }
                ],
                explanation: "b) Sai. $\\overrightarrow{SA} = (5; 5; -20)$. d) Sai. Ph∆∞∆°ng tr√¨nh ƒë√∫ng l√† $4y + z - 20 = 0$."
            },
            {
                id: 'p2_q3', type: 'group_tf',
                question: "Nhi·ªát ƒë·ªô $T(t) = T_a + (T_0 - T_a)e^{-kt}$. C·ªëc n∆∞·ªõc s√¥i $100^\\circ C$ ƒë·∫∑t trong ph√≤ng $20^\\circ C$. Sau 10 ph√∫t c√≤n $60^\\circ C$.",
                subQuestions: [
                    { id: 'a', text: "Nhi·ªát ƒë·ªô ban ƒë·∫ßu $T_0 = 100$.", correct: true },
                    { id: 'b', text: "T·∫°i th·ªùi ƒëi·ªÉm $t=0$, t·ªëc ƒë·ªô thay ƒë·ªïi nhi·ªát ƒë·ªô l√† l·ªõn nh·∫•t.", correct: true },
                    { id: 'c', text: "Gi√° tr·ªã c·ªßa h·∫±ng s·ªë $k$ l√† $\\frac{\\ln 2}{10}$.", correct: true },
                    { id: 'd', text: "Sau 20 ph√∫t, nhi·ªát ƒë·ªô c·ªßa c·ªëc n∆∞·ªõc l√† $40^\\circ C$.", correct: true }
                ],
                explanation: "T·∫•t c·∫£ c√°c √Ω ƒë·ªÅu ƒë√∫ng d·ª±a tr√™n t√≠nh to√°n t·ª´ c√¥ng th·ª©c Newton."
            },
            {
                id: 'p2_q4', type: 'group_tf',
                question: "H·ªôp 1: 3 ƒë·ªè, 2 xanh. H·ªôp 2: 4 ƒë·ªè, 6 xanh. Ch·ªçn ng·∫´u nhi√™n 1 h·ªôp, l·∫•y 1 bi.",
                subQuestions: [
                    { id: 'a', text: "X√°c su·∫•t ch·ªçn ƒë∆∞·ª£c H·ªôp 1 l√† 0,5.", correct: true },
                    { id: 'b', text: "N·∫øu ch·ªçn ƒë∆∞·ª£c H·ªôp 1, x√°c su·∫•t l·∫•y ƒë∆∞·ª£c bi ƒë·ªè l√† 3/5.", correct: true },
                    { id: 'c', text: "X√°c su·∫•t ƒë·ªÉ l·∫•y ƒë∆∞·ª£c vi√™n bi m√†u ƒë·ªè l√† 9/20.", correct: false },
                    { id: 'd', text: "Bi·∫øt r·∫±ng vi√™n bi l·∫•y ra l√† m√†u ƒë·ªè, x√°c su·∫•t ƒë·ªÉ vi√™n bi ƒë√≥ thu·ªôc H·ªôp 1 l·ªõn h∆°n 0,6.", correct: false }
                ],
                explanation: "c) Sai. $P(D) = 0.5(0.6) + 0.5(0.4) = 0.5$. d) Sai. $P(H1|D) = 0.6$, kh√¥ng l·ªõn h∆°n 0.6."
            },

            // --- PH·∫¶N III: TR·∫¢ L·ªúI NG·∫ÆN (6 C√¢u) ---
            { 
                id: 'p3_q1', type: 'text', 
                question: "Ng∆∞·ªùi ta mu·ªën l√†m m·ªôt c√°i h·ªôp h√¨nh h·ªôp ch·ªØ nh·∫≠t kh√¥ng n·∫Øp t·ª´ m·ªôt t·∫•m t√¥n h√¨nh vu√¥ng c·∫°nh 12 cm b·∫±ng c√°ch c·∫Øt b·ªën g√≥c b·ªën h√¨nh vu√¥ng b·∫±ng nhau c√≥ c·∫°nh $x$ (cm) r·ªìi g·∫≠p l√™n. Gi√° tr·ªã c·ªßa $x$ b·∫±ng bao nhi√™u ƒë·ªÉ th·ªÉ t√≠ch c√°i h·ªôp l√† l·ªõn nh·∫•t?", 
                image: <GraphP3Q1 />,
                acceptable: ["2"], 
                explanation: "Th·ªÉ t√≠ch $V(x) = x(12-2x)^2$. ƒê·∫°o h√†m t√¨m c·ª±c tr·ªã, ta ƒë∆∞·ª£c $x=2$." 
            },
            { 
                id: 'p3_q2', type: 'text', 
                question: "Ba l·ª±c $\\vec{F_1}, \\vec{F_2}, \\vec{F_3}$ c√πng t√°c ƒë·ªông v√†o v·∫≠t t·∫°i $O$ v√† v·∫≠t ƒë·ª©ng y√™n. $\\vec{F_1} \\perp \\vec{F_2}$, ƒë·ªô l·ªõn l·∫ßn l∆∞·ª£t 30N v√† 40N. ƒê·ªô l·ªõn l·ª±c $\\vec{F_3}$ b·∫±ng bao nhi√™u Newton?", 
                image: <GraphP3Q2 />,
                acceptable: ["50"], 
                explanation: "$|\\vec{F_3}| = |\\vec{F_1} + \\vec{F_2}| = \\sqrt{30^2 + 40^2} = 50$." 
            },
            { 
                id: 'p3_q3', type: 'text', 
                question: "X∆∞·ªüng s·∫£n xu·∫•t: 1 t·∫•n A c·∫ßn 2h m√°y, 1h c√¥ng (l√£i 3 tri·ªáu). 1 t·∫•n B c·∫ßn 1h m√°y, 2h c√¥ng (l√£i 4 tri·ªáu). T·ªëi ƒëa 10h m√°y, 8h c√¥ng. L·ª£i nhu·∫≠n l·ªõn nh·∫•t l√† bao nhi√™u tri·ªáu ƒë·ªìng?", 
                image: <GraphP3Q3 />,
                acceptable: ["20"], 
                explanation: "Gi·∫£i b√†i to√°n quy ho·∫°ch tuy·∫øn t√≠nh, c·ª±c ƒë·∫°i t·∫°i giao ƒëi·ªÉm $(4; 2)$. L·ª£i nhu·∫≠n $3(4) + 4(2) = 20$." 
            },
            { 
                id: 'p3_q4', type: 'text', 
                question: "Cho h√¨nh l·∫≠p ph∆∞∆°ng $ABCD.A'B'C'D'$ c·∫°nh 1. Kho·∫£ng c√°ch gi·ªØa ƒë∆∞·ªùng ch√©o $AC'$ v√† c·∫°nh $A'B'$ b·∫±ng bao nhi√™u? (L√†m tr√≤n k·∫øt qu·∫£ ƒë·∫øn h√†ng ph·∫ßn trƒÉm).", 
                image: <GraphP3Q4 />,
                acceptable: ["0.71", "0,71"], 
                explanation: "Kho·∫£ng c√°ch $d = \\frac{1}{\\sqrt{2}} \\approx 0.707$. L√†m tr√≤n 0.71." 
            },
            { 
                id: 'p3_q5', type: 'text', 
                question: "C√≥ bao nhi√™u s·ªë t·ª± nhi√™n c√≥ 3 ch·ªØ s·ªë ƒë√¥i m·ªôt kh√°c nhau ƒë∆∞·ª£c l·∫≠p t·ª´ c√°c ch·ªØ s·ªë $\\{0, 1, 2, 3, 4, 5\\}$?", 
                acceptable: ["100"], 
                explanation: "$5 \\times 5 \\times 4 = 100$ s·ªë." 
            },
            { 
                id: 'p3_q6', type: 'text', 
                question: "M·ªôt c·ªïng ch√†o parabol $y = -\\frac{1}{2}x^2$. Bi·ªÉn qu·∫£ng c√°o h√¨nh ch·ªØ nh·∫≠t $ABCD$ n·ªôi ti·∫øp b√™n d∆∞·ªõi, chi·ªÅu cao bi·ªÉn l√† 2m. Di·ªán t√≠ch bi·ªÉn qu·∫£ng c√°o l√† bao nhi√™u m√©t vu√¥ng?", 
                image: <GraphP3Q6 />,
                acceptable: ["8"], 
                explanation: "T·∫°i ƒë·ªô cao c√°ch ƒë·ªânh 2m (ho·∫∑c tung ƒë·ªô -2), $x = \\pm 2$. Chi·ªÅu r·ªông 4m. Di·ªán t√≠ch $4 \\times 2 = 8$." 
            }
        ];
        
        // --- LOGIC H√ÄM (GI·ªÆ NGUY√äN) ---
        const PASSING_SCORE = 5.0; 
        
        const generateRandomQuiz = () => {
             const mcqPool = QUESTION_BANK.filter(q => q.type === 'mcq');
             const tfPool = QUESTION_BANK.filter(q => q.type === 'group_tf');
             const textPool = QUESTION_BANK.filter(q => q.type === 'text');
             
             return [...mcqPool, ...tfPool, ...textPool];
        };

        const calculateScore = (currentQuestions, answers) => {
            let score = 0;
            let totalMaxScore = 0; 

            currentQuestions.forEach(q => {
                let questionMaxScore = 0;
                let questionScore = 0;

                if (q.type === 'mcq') {
                    questionMaxScore = 0.25; 
                    if (answers[q.id] === q.correct) questionScore = 0.25;
                } else if (q.type === 'text') {
                    questionMaxScore = 0.5; 
                    const userAns = (answers[q.id] || "").trim().replace(',', '.');
                    if (q.acceptable.includes(userAns) || q.acceptable.includes(answers[q.id])) questionScore = 0.5;
                } else if (q.type === 'group_tf') {
                    questionMaxScore = 1.0; 
                    let correctCount = 0;
                    const userGroupAns = answers[q.id] || {};
                    q.subQuestions.forEach(sub => {
                        if (userGroupAns[sub.id] === sub.correct) correctCount++;
                    });
                    if (correctCount === 1) questionScore = 0.1;
                    else if (correctCount === 2) questionScore = 0.25;
                    else if (correctCount === 3) questionScore = 0.5;
                    else if (correctCount === 4) questionScore = 1.0;
                }
                
                score += questionScore;
                totalMaxScore += questionMaxScore;
            });
            
            if (totalMaxScore > 0) {
                 const scaledScore = (score / totalMaxScore) * 10;
                 return Math.round(scaledScore * 100) / 100;
            }
            return 0;
        };
        
        const WelcomeScreen = ({ onSelectMode }) => (
            <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-cyan-600 to-blue-800 p-4 text-white animate-fade-in">
                <div className="bg-white/10 backdrop-blur-md p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border border-white/20">
                    <h1 className="text-4xl font-bold mb-2">TRANDAIEDU</h1>
                    <h2 className="text-xl mb-8 text-cyan-100 font-medium">ƒê·ªÄ THI TH·ª¨ T·ªêT NGHI·ªÜP THPT 2025</h2>
                    {isUsingCustomConfig === false && !window.__firebase_config && (
                        <div className="mb-4 bg-red-500/20 text-red-100 p-2 rounded text-sm border border-red-500/50">
                            C·∫£nh b√°o: Ch∆∞a c·∫•u h√¨nh Firebase. ƒêi·ªÉm s·∫Ω KH√îNG ƒë∆∞·ª£c l∆∞u.
                        </div>
                    )}
                    <div className="space-y-4">
                        <button onClick={() => onSelectMode('student')} className="w-full py-4 bg-white text-blue-800 rounded-xl font-bold hover:bg-blue-50 transition-all shadow-lg flex items-center justify-center gap-2"><Icon name="user"/> H·ªçc Sinh V√†o Thi</button>
                        <button onClick={() => onSelectMode('teacher')} className="w-full py-4 bg-blue-900/50 text-white rounded-xl font-bold hover:bg-blue-900 transition-all border border-blue-400/30 flex items-center justify-center gap-2"><Icon name="lock"/> Gi√°o Vi√™n Xem ƒêi·ªÉm</button>
                    </div>
                </div>
            </div>
        );

        const StudentNameInput = ({ onStart }) => {
            const [name, setName] = useState('');
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50 p-4 animate-fade-in">
                    <form onSubmit={(e) => { e.preventDefault(); if(name.trim()) onStart(name); }} className="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2 text-center">Nh·∫≠p Th√¥ng Tin</h2>
                        <div className="mb-6">
                            <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500" placeholder="H·ªç v√† t√™n..." required />
                            <p className="text-xs text-green-600 mt-2 flex items-center gap-1"><Icon name="check" size={12}/> Ch·∫ø ƒë·ªô: H·ªçc sinh (Kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p)</p>
                        </div>
                        <button type="submit" className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors">B·∫Øt ƒê·∫ßu</button>
                    </form>
                </div>
            );
        };

        const QuizView = ({ studentName, questions, onSubmit }) => {
            const [answers, setAnswers] = useState({});
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [showConfirmModal, setShowConfirmModal] = useState(false);

            useEffect(() => { window.scrollTo(0, 0); }, []);
            
            const handleMcqChange = (qId, optIdx) => setAnswers(prev => ({ ...prev, [qId]: optIdx }));
            const handleTfChange = (qId, subId, val) => setAnswers(prev => ({ ...prev, [qId]: { ...(prev[qId] || {}), [subId]: val } }));
            const handleTextChange = (qId, val) => setAnswers(prev => ({ ...prev, [qId]: val }));
            
            const handleTriggerSubmit = () => {
                setShowConfirmModal(true);
            };

            const handleConfirmSubmit = async () => {
                setShowConfirmModal(false);
                setIsSubmitting(true);
                onSubmit(answers);
            };

            return (
                <div className="min-h-screen bg-gray-100 pb-20 relative">
                    <div className="bg-white shadow-md p-4 sticky top-0 z-10 border-b border-gray-200">
                        <div className="max-w-3xl mx-auto flex justify-between items-center">
                            <div className="font-bold text-blue-700 flex items-center gap-2"><Icon name="user" size={18}/> {studentName}</div>
                        </div>
                    </div>

                    <div className="max-w-3xl mx-auto p-4 space-y-8 mt-4 animate-fade-in">
                        {questions.map((q, idx) => (
                            <div key={q.id} className="bg-white rounded-xl shadow-sm p-6 transition-all hover:shadow-md">
                                <div className="mb-3">
                                    <span className={`inline-block text-xs font-bold px-2 py-1 rounded mb-2 ${q.type === 'mcq' ? 'bg-blue-100 text-blue-800' : q.type === 'group_tf' ? 'bg-purple-100 text-purple-800' : 'bg-orange-100 text-orange-800'}`}>
                                        {q.type === 'mcq' ? 'Ph·∫ßn 1: Tr·∫Øc nghi·ªám' : q.type === 'group_tf' ? 'Ph·∫ßn 2: ƒê√∫ng/Sai' : 'Ph·∫ßn 3: Tr·∫£ l·ªùi ng·∫Øn'}
                                    </span>
                                    <div className="font-medium text-gray-800 flex gap-2">
                                        <span className="font-bold text-blue-600 whitespace-nowrap">C√¢u {idx + 1}:</span>
                                        <MathText text={q.question} />
                                    </div>
                                    {q.image && <div className="mt-3 flex justify-center">{q.image}</div>}
                                </div>
                                {q.type === 'mcq' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        {q.options.map((opt, optIdx) => (
                                            <button key={optIdx} onClick={() => handleMcqChange(q.id, optIdx)} className={`p-3 text-left rounded-lg border text-sm transition-all ${answers[q.id] === optIdx ? 'bg-blue-100 border-blue-500 text-blue-800 font-medium ring-1 ring-blue-500' : 'hover:bg-gray-50 border-gray-200'}`}>
                                                <span className="font-bold mr-2">{String.fromCharCode(65 + optIdx)}.</span><MathText text={opt} />
                                            </button>
                                        ))}
                                    </div>
                                )}
                                {q.type === 'group_tf' && (
                                    <div className="border rounded-lg overflow-hidden">
                                        <table className="w-full text-sm">
                                            <thead className="bg-gray-100"><tr><th className="p-3 text-left">M·ªánh ƒë·ªÅ</th><th className="p-3 w-16 text-center">ƒê√∫ng</th><th className="p-3 w-16 text-center">Sai</th></tr></thead>
                                            <tbody className="divide-y">
                                                {q.subQuestions.map(sub => {
                                                    const currentVal = (answers[q.id] || {})[sub.id];
                                                    return (
                                                        <tr key={sub.id} className="hover:bg-gray-50">
                                                            <td className="p-3"><MathText text={sub.text} /></td>
                                                            <td className="p-3 text-center"><input type="radio" name={`${q.id}-${sub.id}`} checked={currentVal === true} onChange={() => handleTfChange(q.id, sub.id, true)} className="w-5 h-5 cursor-pointer accent-blue-600"/></td>
                                                            <td className="p-3 text-center"><input type="radio" name={`${q.id}-${sub.id}`} checked={currentVal === false} onChange={() => handleTfChange(q.id, sub.id, false)} className="w-5 h-5 cursor-pointer accent-red-600"/></td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                                {q.type === 'text' && (
                                    <input type="text" value={answers[q.id] || ''} onChange={(e) => handleTextChange(q.id, e.target.value)} className="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nh·∫≠p ƒë√°p √°n..." />
                                )}
                            </div>
                        ))}
                        <div className="flex justify-center pt-6">
                            <button onClick={handleTriggerSubmit} disabled={isSubmitting} className={`px-8 py-4 text-white text-lg font-bold rounded-xl shadow-lg flex items-center gap-2 transition-all ${isSubmitting ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 transform hover:scale-105'}`}>
                                {isSubmitting ? <><Icon name="loader" className="animate-spin"/> ƒêANG G·ª¨I...</> : <><Icon name="save"/> N·ªòP B√ÄI</>}
                            </button>
                        </div>
                    </div>

                    {showConfirmModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                            <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center animate-fade-in">
                                <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                                    <Icon name="help-circle" size={24} className="text-blue-600"/>
                                </div>
                                <h3 className="text-lg font-bold text-gray-900 mb-2">X√°c nh·∫≠n n·ªôp b√†i</h3>
                                <p className="text-sm text-gray-500 mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i thi? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
                                <div className="flex gap-3 justify-center">
                                    <button onClick={() => setShowConfirmModal(false)} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition-colors">H·ªßy b·ªè</button>
                                    <button onClick={handleConfirmSubmit} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-lg">ƒê·ªìng √Ω n·ªôp</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const SolutionView = ({ questions, answers, score, onRetry }) => {
            const [openExplain, setOpenExplain] = useState({});
            const toggleExplain = (id) => setOpenExplain(prev => ({ ...prev, [id]: !prev[id] }));
            const isPassed = score >= PASSING_SCORE;

            return (
                <div className={`min-h-screen pb-20 animate-fade-in ${isPassed ? 'bg-green-50' : 'bg-red-50'}`}>
                    <div className={`shadow p-6 text-center mb-6 ${isPassed ? 'bg-white' : 'bg-white border-b-4 border-red-500'}`}>
                        <div className="flex justify-center mb-2">{isPassed ? <Icon name="trophy" size={56} className="text-yellow-500"/> : <Icon name="alert-circle" size={56} className="text-red-500"/>}</div>
                        <h2 className={`text-2xl font-bold ${isPassed ? 'text-green-700' : 'text-red-700'}`}>{isPassed ? "Ch√∫c M·ª´ng! B·∫°n ƒê√£ Ho√†n Th√†nh" : "Ch∆∞a ƒê·∫°t Y√™u C·∫ßu"}</h2>
                        <div className={`mt-4 inline-block px-6 py-3 rounded-xl border ${isPassed ? 'bg-green-100 border-green-200' : 'bg-red-100 border-red-200'}`}>
                            <span className="text-gray-600 uppercase text-xs font-bold block">T·ªïng ƒêi·ªÉm</span>
                            <span className={`text-4xl font-bold ${isPassed ? 'text-green-700' : 'text-red-700'}`}>{score.toFixed(2)}<span className="text-xl text-gray-500">/10</span></span>
                        </div>
                        <p className="text-gray-600 mt-3 text-sm max-w-md mx-auto">
                            {isPassed 
                                ? "K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c l∆∞u. H√£y xem l·∫°i l·ªùi gi·∫£i chi ti·∫øt b√™n d∆∞·ªõi." 
                                : `B·∫°n c·∫ßn ƒë·∫°t t·ªëi thi·ªÉu ${PASSING_SCORE} ƒëi·ªÉm. K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o h·ªá th·ªëng nh∆∞ng b·∫°n c·∫ßn l√†m l·∫°i ƒë·ªÉ xem ƒë√°p √°n chi ti·∫øt.`}
                        </p>
                    </div>

                    {isPassed ? (
                        <div className="max-w-3xl mx-auto p-4 space-y-6">
                            <h3 className="font-bold text-gray-700 flex items-center gap-2 mb-4"><Icon name="check-circle" size={20}/> Chi Ti·∫øt B√†i L√†m & L·ªùi Gi·∫£i</h3>
                            {questions.map((q, idx) => {
                                const isOpen = openExplain[q.id];
                                return (
                                    <div key={q.id} className="bg-white rounded-lg shadow-sm border-l-4 border-blue-400 overflow-hidden">
                                        <div className="p-4 cursor-pointer hover:bg-gray-50 transition-colors" onClick={() => toggleExplain(q.id)}>
                                            <div className="flex justify-between items-start">
                                                <div className="font-medium text-gray-800 flex-1 flex gap-2"><span className="font-bold whitespace-nowrap">C√¢u {idx + 1}:</span> <MathText text={q.question} /></div>
                                            </div>
                                            <div className="text-right text-xs text-blue-500 mt-2 font-medium flex items-center justify-end gap-1">{isOpen ? 'Thu g·ªçn' : 'Xem chi ti·∫øt'} <Icon name={isOpen ? "chevron-up" : "chevron-down"} size={14}/></div>
                                        </div>
                                        {isOpen && (
                                            <div className="bg-blue-50 p-4 text-sm text-blue-900 border-t border-blue-100">
                                                {q.image && <div className="mb-4 flex justify-center">{q.image}</div>}
                                                <span className="font-bold block mb-1">üí° L·ªùi gi·∫£i chi ti·∫øt:</span>
                                                <MathText text={q.explanation} />
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <div className="max-w-md mx-auto p-8 text-center text-gray-500">
                            <div className="flex justify-center mb-4"><Icon name="eye-off" size={64} className="text-gray-300"/></div>
                            <p className="text-lg font-medium text-gray-600 mb-2">Ch∆∞a ƒë·∫°t y√™u c·∫ßu</p>
                            <p className="text-sm">H·ªá th·ªëng ƒë√£ ·∫©n to√†n b·ªô c√¢u h·ªèi v√† l·ªùi gi·∫£i ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh kh√°ch quan khi b·∫°n l√†m l·∫°i ƒë·ªÅ.</p>
                        </div>
                    )}
                    <div className="flex justify-center pt-6 pb-10">
                        {isPassed ? <button onClick={() => window.location.reload()} className="px-8 py-3 bg-gray-600 text-white rounded-lg font-bold hover:bg-gray-700 shadow-lg flex items-center gap-2"><Icon name="log-out"/> V·ªÅ trang ch·ªß</button> : <button onClick={onRetry} className="px-8 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 shadow-lg flex items-center gap-2 animate-bounce"><Icon name="refresh-ccw"/> L√†m l·∫°i ƒë·ªÅ m·ªõi</button>}
                    </div>
                </div>
            );
        };

        const TeacherLogin = ({ onLogin, onBack }) => {
            const [pass, setPass] = useState('');
            const [error, setError] = useState('');
            const handleLogin = (e) => { e.preventDefault(); if (pass === '12345678T') { onLogin(); } else { setError('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!'); } };
            return ( <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4 animate-fade-in"> <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm"> <h2 className="text-xl font-bold mb-6 text-gray-800 text-center">Gi√°o Vi√™n ƒêƒÉng Nh·∫≠p</h2> <form onSubmit={handleLogin} className="space-y-4"> <input type="password" value={pass} onChange={(e) => setPass(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." autoFocus/> {error && <p className="text-red-500 text-sm text-center">{error}</p>} <button type="submit" className="w-full py-3 bg-blue-700 text-white rounded-lg font-bold hover:bg-blue-800">Truy c·∫≠p</button> <button type="button" onClick={onBack} className="w-full py-2 text-gray-500 hover:text-gray-800 text-sm">Quay l·∫°i</button> </form> </div> </div> );
        };

        const TeacherDashboard = ({ onLogout }) => {
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db) initializeFirebase();

                if (!db) {
                    setResults([
                        { id: 1, timestamp: { seconds: Date.now()/1000 }, name: "Nguy·ªÖn VƒÉn Demo", score: 8.5 },
                        { id: 2, timestamp: { seconds: Date.now()/1000 - 3600 }, name: "Tr·∫ßn Th·ªã Test", score: 6.0 },
                        { id: 3, timestamp: { seconds: Date.now()/1000 - 7200 }, name: "L√™ VƒÉn M·∫´u", score: 9.25 },
                    ]);
                    setLoading(false);
                    return;
                }

                let q;
                if (isUsingCustomConfig) {
                    q = db.collection(COLLECTION_NAME);
                } else {
                    q = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(COLLECTION_NAME);
                }
                
                const unsubscribe = q.onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => {
                        const d = doc.data();
                        let time = 0;
                        if (d.timestamp && d.timestamp.seconds) { time = d.timestamp.seconds; } 
                        else if (typeof d.timestamp === 'string') { time = new Date(d.timestamp).getTime() / 1000; }
                        return { id: doc.id, ...d, sortTime: time };
                    });
                    data.sort((a, b) => b.sortTime - a.sortTime);
                    setResults(data);
                    setLoading(false);
                }, (error) => { console.error("L·ªói t·∫£i d·ªØ li·ªáu:", error); setLoading(false); });
                return () => unsubscribe();
            }, []);

            return (
                <div className="min-h-screen bg-gray-50 animate-fade-in">
                    <div className="bg-white shadow px-6 py-4 flex justify-between items-center sticky top-0 z-10">
                        <div className="flex items-center gap-3">
                            <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2"><Icon name="list" className="text-blue-600"/> B·∫£ng ƒêi·ªÉm</h1>
                        </div>
                        <button onClick={onLogout} className="text-red-600 hover:bg-red-50 px-4 py-2 rounded-lg flex items-center gap-2 font-medium"><Icon name="log-out" size={18}/> ƒêƒÉng xu·∫•t</button>
                    </div>
                    <div className="max-w-6xl mx-auto p-6">
                        <div className="bg-white rounded-xl shadow overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-100 border-b"><tr><th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase">Th·ªùi gian</th><th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase">H·ªç v√† T√™n</th><th className="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase">ƒêi·ªÉm S·ªë (10)</th><th className="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase">X·∫øp lo·∫°i</th></tr></thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {loading ? ( <tr><td colSpan="4" className="p-8 text-center text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr> ) : results.length === 0 ? ( <tr><td colSpan="4" className="p-8 text-center text-gray-500">Ch∆∞a c√≥ b√†i thi n√†o ƒë∆∞·ª£c n·ªôp.</td></tr> ) : results.map((res) => (
                                            <tr key={res.id} className="hover:bg-gray-50">
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{res.timestamp ? new Date((res.sortTime || res.timestamp.seconds) * 1000).toLocaleString('vi-VN') : 'V·ª´a xong'}</td>
                                                <td className="px-6 py-4 whitespace-nowrap font-medium text-gray-900">{res.name}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-center"><span className="text-lg font-bold text-blue-700">{res.score?.toFixed(2)}</span></td>
                                                <td className="px-6 py-4 whitespace-nowrap text-center"><span className={`px-3 py-1 rounded-full text-xs font-bold ${res.score >= 8 ? 'bg-green-100 text-green-800' : res.score >= 5 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}`}>{res.score >= 8 ? 'Gi·ªèi' : res.score >= 6.5 ? 'Kh√°' : res.score >= 5 ? 'Trung B√¨nh' : 'Y·∫øu'}</span></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('welcome');
            const [user, setUser] = useState(null);
            const [studentName, setStudentName] = useState('');
            const [currentQuestions, setCurrentQuestions] = useState([]);
            const [finalScore, setFinalScore] = useState(0);
            const [userAnswers, setUserAnswers] = useState({});

            useEffect(() => {
                initializeFirebase();
                if (auth) {
                    const initAuth = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await auth.signInWithCustomToken(__initial_auth_token);
                            } else {
                                await auth.signInAnonymously();
                            }
                        } catch (err) {
                            console.error("Auth failed:", err);
                        }
                    };
                    initAuth();
                    const unsubscribe = auth.onAuthStateChanged((u) => { if (u) setUser(u); });
                    return () => unsubscribe();
                }
            }, []);

            const startNewQuiz = (name) => {
                setStudentName(name);
                const newQuestions = generateRandomQuiz();
                setCurrentQuestions(newQuestions);
                setView('quiz');
            };

            const handleRetry = () => {
                const newQuestions = generateRandomQuiz();
                setCurrentQuestions(newQuestions);
                setView('quiz');
            };

            const handleSubmitQuiz = async (answers) => {
                const score = calculateScore(currentQuestions, answers);
                setFinalScore(score);
                setUserAnswers(answers);
                
                const savePromise = (async () => {
                    if (!db || !auth) {
                        initializeFirebase();
                    }

                    if (db && auth) {
                        try {
                            let currentUser = auth.currentUser;
                            if (!currentUser) {
                                try {
                                    const cred = await auth.signInAnonymously();
                                    currentUser = cred.user;
                                } catch(e) {
                                    console.error("L·ªói ƒëƒÉng nh·∫≠p ·∫©n danh:", e);
                                    return;
                                }
                            }

                            if (currentUser) {
                                const sanitizedAnswers = JSON.parse(JSON.stringify(answers));
                                
                                let collectionRef;
                                if (isUsingCustomConfig) {
                                    collectionRef = db.collection(COLLECTION_NAME);
                                } else {
                                    collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(COLLECTION_NAME);
                                }

                                await collectionRef.add({
                                    name: studentName, 
                                    score: score, 
                                    questionIds: currentQuestions.map(q => q.id), 
                                    answers: sanitizedAnswers, 
                                    timestamp: new Date().toISOString(),
                                    uid: currentUser.uid
                                });
                            }
                        } catch (error) { 
                            console.error("L·ªói khi l∆∞u ƒëi·ªÉm:", error);
                        }
                    }
                })();

                const timeoutPromise = new Promise(resolve => setTimeout(resolve, 3000));
                
                await Promise.race([savePromise, timeoutPromise]);
                
                setView('result'); 
            };

            return (
                <div>
                    {view === 'welcome' && <WelcomeScreen onSelectMode={(mode) => setView(mode === 'student' ? 'name' : 'login')} />}
                    {view === 'name' && <StudentNameInput onStart={startNewQuiz} />}
                    {view === 'quiz' && <QuizView studentName={studentName} questions={currentQuestions} onSubmit={handleSubmitQuiz} />}
                    {view === 'result' && <SolutionView questions={currentQuestions} answers={userAnswers} score={finalScore} onRetry={handleRetry} />}
                    {view === 'login' && <TeacherLogin onLogin={() => setView('teacher')} onBack={() => setView('welcome')} />}
                    {view === 'teacher' && <TeacherDashboard onLogout={() => setView('welcome')} />}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
