import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot } from 'firebase/firestore';
import { 
  BookOpen, User, Lock, CheckCircle, XCircle, Trophy, Save, 
  LogOut, ClipboardList, CheckSquare, List, Type, ChevronDown, ChevronUp, Wifi, WifiOff, AlertTriangle, Loader2, RotateCcw, AlertOctagon, EyeOff
} from 'lucide-react';

// --- C·∫§U H√åNH FIREBASE ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- C·∫§U H√åNH GAME ---
const PASSING_SCORE = 6.0;

// ==================================================================================
// --- UTILS: MATH RENDERER (S·ª≠ d·ª•ng KaTeX) ---
// ==================================================================================

const MathText = ({ text, className = "" }) => {
  const containerRef = useRef(null);
  const [katexLoaded, setKatexLoaded] = useState(false);

  useEffect(() => {
    if (!window.katex) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css';
      document.head.appendChild(link);

      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js';
      script.onload = () => setKatexLoaded(true);
      document.head.appendChild(script);
    } else {
      setKatexLoaded(true);
    }
  }, []);

  useEffect(() => {
    if (katexLoaded && containerRef.current && text) {
      renderMathInElement(containerRef.current, text);
    }
  }, [text, katexLoaded]);

  const renderMathInElement = (element, content) => {
    if (!window.katex) {
      element.innerText = content;
      return;
    }
    element.innerHTML = ''; 
    const parts = content.split('$');
    parts.forEach((part, index) => {
      if (index % 2 === 1) { 
        const span = document.createElement('span');
        try {
          window.katex.render(part, span, { throwOnError: false, displayMode: false });
        } catch (e) {
          span.innerText = part;
        }
        element.appendChild(span);
      } else {
        element.appendChild(document.createTextNode(part));
      }
    });
  };

  return <span ref={containerRef} className={className}></span>;
};

// ==================================================================================
// --- H√åNH ·∫¢NH MINH H·ªåA (SVG COMPONENTS) ---
// ==================================================================================

const ParabolImage = () => (
  <div className="flex justify-center my-4">
    <svg width="200" height="150" viewBox="-50 -10 100 80" className="border border-gray-200 bg-white rounded shadow-sm">
      <path d="M -40 70 Q 0 -10 40 70" fill="none" stroke="#2563eb" strokeWidth="2" />
      <line x1="-40" y1="70" x2="40" y2="70" stroke="black" strokeWidth="1" />
      <line x1="0" y1="0" x2="0" y2="70" stroke="black" strokeWidth="1" strokeDasharray="4" />
      <text x="-5" y="75" fontSize="8" textAnchor="middle">0</text>
      <text x="0" y="-2" fontSize="8" textAnchor="middle">h = 2.25m</text>
      <text x="0" y="85" fontSize="8" textAnchor="middle">w = 3m</text>
    </svg>
  </div>
);

const FlowerPatternImage = () => (
  <div className="flex justify-center my-4">
    <svg width="150" height="150" viewBox="0 0 100 100" className="border border-gray-200 bg-white rounded shadow-sm">
      <rect x="10" y="10" width="80" height="80" fill="none" stroke="black" />
      <path d="M 10 10 Q 50 50 90 10" fill="none" stroke="#2563eb" />
      <path d="M 10 90 Q 50 50 90 90" fill="none" stroke="#2563eb" />
      <path d="M 10 10 Q 50 50 10 90" fill="none" stroke="#2563eb" />
      <path d="M 90 10 Q 50 50 90 90" fill="none" stroke="#2563eb" />
      <text x="50" y="55" fontSize="8" textAnchor="middle" fill="#666">Ph·∫ßn t√¥ ƒëen</text>
    </svg>
  </div>
);

const MachinePartImage = () => (
  <div className="flex justify-center my-4">
    <svg width="200" height="100" viewBox="0 0 200 100" className="border border-gray-200 bg-white rounded shadow-sm">
      <ellipse cx="30" cy="50" rx="10" ry="30" fill="none" stroke="black" />
      <ellipse cx="170" cy="50" rx="10" ry="30" fill="none" stroke="black" />
      <line x1="30" y1="20" x2="170" y2="20" stroke="black" strokeWidth="2" />
      <line x1="30" y1="80" x2="170" y2="80" stroke="black" strokeWidth="2" />
      <path d="M 30 20 Q 100 50 170 20" fill="none" stroke="#2563eb" strokeDasharray="4" />
      <text x="100" y="95" fontSize="10" textAnchor="middle">Chi ti·∫øt m√°y quay quanh tr·ª•c</text>
    </svg>
  </div>
);
const ThuanhImage = () => (
<svg width="600" height="400" viewBox="0 0 500 350" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="black" />
    </marker>
    <marker id="arrowhead-blue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#0000AA" />
    </marker>
    <marker id="arrow-start" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
      <polygon points="10 0, 0 3.5, 10 7" fill="#444" />
    </marker>
    <marker id="arrow-end" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#444" />
    </marker>
  </defs>

  <rect width="100%" height="100%" fill="white" />

  <path d="M 50 160 
           C 150 160, 250 220, 350 220 
           L 350 250 
           C 250 250, 150 190, 50 190 
           Z" 
        fill="#87CEFA" stroke="none" />

  <rect x="50" y="160" width="300" height="90" fill="none" stroke="#4682B4" strokeWidth="2" />

  <line x1="50" y1="250" x2="400" y2="250" stroke="black" strokeWidth="2" markerEnd="url(#arrowhead)" />
  <line x1="50" y1="250" x2="50" y2="100" stroke="black" strokeWidth="2" markerEnd="url(#arrowhead)" />

  <path d="M 50 160 C 150 160, 250 220, 350 220" fill="none" stroke="black" strokeWidth="1.5" />
  
  <path d="M 50 190 C 150 190, 250 250, 350 250" fill="none" stroke="black" strokeWidth="1.5" />

  <line x1="50" y1="160" x2="350" y2="220" stroke="black" strokeWidth="1" />
  <line x1="50" y1="190" x2="350" y2="250" stroke="black" strokeWidth="1" />

  <circle cx="50" cy="160" r="3" fill="blue" /> <circle cx="50" cy="190" r="3" fill="blue" /> <circle cx="350" cy="220" r="3" fill="blue" /> <circle cx="350" cy="250" r="3" fill="blue" /> <line x1="30" y1="250" x2="30" y2="160" stroke="#666" strokeWidth="1" markerStart="url(#arrow-start)" markerEnd="url(#arrow-end)" />
  <text x="25" y="205" fontFamily="serif" fontSize="14" fill="#666" textAnchor="end">6m</text>
  
  <line x1="370" y1="250" x2="370" y2="220" stroke="#666" strokeWidth="1" markerStart="url(#arrow-start)" markerEnd="url(#arrow-end)" />
  <text x="375" y="240" fontFamily="serif" fontSize="14" fill="#666" textAnchor="start">2m</text>

  <line x1="50" y1="270" x2="350" y2="270" stroke="#666" strokeWidth="1" markerStart="url(#arrow-start)" markerEnd="url(#arrow-end)" />
  <text x="200" y="285" fontFamily="serif" fontSize="14" fill="#666" textAnchor="middle">20m</text>

  <text x="40" y="265" fontFamily="serif" fontSize="18" fontWeight="bold" fontStyle="italic">O</text>
  <text x="410" y="265" fontFamily="serif" fontSize="18" fontStyle="italic">x</text>
  <text x="40" y="90" fontFamily="serif" fontSize="18" fontStyle="italic">y</text>

  <text x="35" y="160" fontFamily="serif" fontSize="16" fill="#4682B4" fontStyle="italic" textAnchor="end">D</text>
  <text x="35" y="190" fontFamily="serif" fontSize="16" fill="#4682B4" fontStyle="italic" textAnchor="end">A</text>
  <text x="360" y="220" fontFamily="serif" fontSize="16" fill="#4682B4" fontStyle="italic">C</text>
  <text x="360" y="250" fontFamily="serif" fontSize="16" fill="#4682B4" fontStyle="italic">B</text>

  <text x="250" y="145" fontFamily="serif" fontSize="18" fontWeight="bold">y = f(x) + 2</text>
  <text x="180" y="215" fontFamily="serif" fontSize="18" fontWeight="bold">y = f(x)</text>

</svg>
);

// ==================================================================================
// --- NG√ÇN H√ÄNG C√ÇU H·ªéI (C√ì H√åNH ·∫¢NH) ---
// ==================================================================================

const QUESTION_BANK = [
  // ============================================================
  // M√É ƒê·ªÄ 145
  // ============================================================
  
  // --- Ph·∫ßn 1: Tr·∫Øc nghi·ªám (12 c√¢u) ---
  {
    id: 'd145_q1', type: 'mcq',
    question: "H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=3x^2+\\sin 2x$ l√†:",
    options: [
      "$x^3+\\cos 2x+C$",
      "$6x+2\\cos 2x+C$",
      "$x^3-\\frac{1}{2}\\cos 2x+C$",
      "$6x+\\frac{1}{2}\\cos 2x+C$"
    ],
    correct: 2, explanation: "Ta c√≥ $\\int (3x^2+\\sin 2x)dx = x^3 - \\frac{1}{2}\\cos 2x + C$."
  },
  {
    id: 'd145_q2', type: 'mcq',
    question: "M·ªánh ƒë·ªÅ n√†o sau ƒë√¢y SAI?",
    options: [
      "$\\int [f_1(x)+f_2(x)]dx = \\int f_1(x)dx + \\int f_2(x)dx$",
      "$\\int kf(x)dx = k\\int f(x)dx$ ($k \\ne 0$)",
      "$\\int f'(x)dx = f(x) + C$",
      "$\\int [f_1(x).f_2(x)]dx = \\int f_1(x)dx . \\int f_2(x)dx$"
    ],
    correct: 3, explanation: "Nguy√™n h√†m c·ªßa m·ªôt t√≠ch KH√îNG b·∫±ng t√≠ch c√°c nguy√™n h√†m."
  },
  { id: 'd145_q3', type: 'mcq', 
  question: "[M√£ 145 - C√¢u 3] N·ªôi dung c√¢u h·ªèi...", 
  image: <ThuanhImage />, // S·ª≠ d·ª•ng SVG component thay v√¨ base64
  options: ["A", "B", "C", "D"], 
  correct: 0, explanation: "..." },
  { id: 'd145_q4', type: 'mcq', question: "[M√£ 145 - C√¢u 4] N·ªôi dung c√¢u h·ªèi...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd145_q5', type: 'mcq', question: "[M√£ 145 - C√¢u 5] N·ªôi dung c√¢u h·ªèi...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd145_q6', type: 'mcq', question: "[M√£ 145 - C√¢u 6] N·ªôi dung c√¢u h·ªèi...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd145_q7', type: 'mcq', question: "[M√£ 145 - C√¢u 7] N·ªôi dung c√¢u h·ªèi...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd145_q8', type: 'mcq', question: "[M√£ 145 - C√¢u 8] N·ªôi dung c√¢u h·ªèi...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd145_q9', type: 'mcq', question: "[M√£ 145 - C√¢u 9] N·ªôi dung c√¢u h·ªèi...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd145_q10', type: 'mcq', question: "[M√£ 145 - C√¢u 10] N·ªôi dung c√¢u h·ªèi...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd145_q11', type: 'mcq', question: "[M√£ 145 - C√¢u 11] N·ªôi dung c√¢u h·ªèi...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd145_q12', type: 'mcq', question: "[M√£ 145 - C√¢u 12] N·ªôi dung c√¢u h·ªèi...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },

  // --- Ph·∫ßn 2: ƒê√∫ng/Sai (M√£ 145 - 4 c√¢u) ---
  {
    id: 'd145_q13', type: 'group_tf',
    question: "[M√£ 145 - C√¢u 13 ƒê√∫ng/Sai] N·ªôi dung c√¢u h·ªèi...",
    subQuestions: [
      { id: 'a', text: "√ù a", correct: true },
      { id: 'b', text: "√ù b", correct: true },
      { id: 'c', text: "√ù c", correct: true },
      { id: 'd', text: "√ù d", correct: true }
    ],
    explanation: "..."
  },
  { id: 'd145_q14', type: 'group_tf', question: "[M√£ 145 - C√¢u 14]...", subQuestions: [{id:'a', text:'...', correct:true}], explanation: "..." },
  { id: 'd145_q15', type: 'group_tf', question: "[M√£ 145 - C√¢u 15]...", subQuestions: [{id:'a', text:'...', correct:true}], explanation: "..." },
  { id: 'd145_q16', type: 'group_tf', question: "[M√£ 145 - C√¢u 16]...", subQuestions: [{id:'a', text:'...', correct:true}], explanation: "..." },

  // --- Ph·∫ßn 3: Tr·∫£ l·ªùi ng·∫Øn (M√£ 145 - 6 c√¢u) ---
  { 
    id: 'd145_q17', type: 'text', 
    question: "Di·ªán t√≠ch ph·∫ßn ƒë∆∞·ª£c ngh·ªá sƒ© t√¥ m√†u ƒëen c√≥ di·ªán t√≠ch b·∫±ng bao nhi√™u centimet vu√¥ng? (l√†m tr√≤n k·∫øt qu·∫£ ƒë·∫øn h√†ng ƒë∆°n v·ªã)", 
    acceptable: ["2016"], 
    image: <ThuanhImage />, // S·ª≠ d·ª•ng SVG component thay v√¨ base64
    explanation: "Theo ƒë√°p √°n tr√≠ch xu·∫•t t·ª´ ƒë·ªÅ 145, k·∫øt qu·∫£ l√† 2016." 
  },
  { id: 'd145_q18', type: 'text', question: "[M√£ 145 - C√¢u 18]...", acceptable: ["0"], explanation: "..." },
  { id: 'd145_q19', type: 'text', question: "[M√£ 145 - C√¢u 19]...", acceptable: ["0"], explanation: "..." },
  { id: 'd145_q20', type: 'text', question: "[M√£ 145 - C√¢u 20]...", acceptable: ["0"], explanation: "..." },
  { id: 'd145_q21', type: 'text', question: "[M√£ 145 - C√¢u 21]...", acceptable: ["0"], explanation: "..." },
  { id: 'd145_q22', type: 'text', question: "[M√£ 145 - C√¢u 22]...", acceptable: ["0"], explanation: "..." },


  // ============================================================
  // M√É ƒê·ªÄ 215
  // ============================================================
  
  // --- Ph·∫ßn 1: Tr·∫Øc nghi·ªám ---
  {
    id: 'd215_q1', type: 'mcq',
    question: "H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)=\\frac{x^2}{2}+2x-5$ l√†:",
    options: [
      "$\\frac{2x^3}{3}+x^2-5x+C$",
      "$\\frac{x^3}{3}+x^2-5x+C$",
      "$\\frac{x^3}{6}+x^2-5x+C$",
      "$\\frac{x^3}{6}+x^2-5x$"
    ],
    correct: 2, explanation: "$\\int (\\frac{x^2}{2}+2x-5)dx = \\frac{1}{2}\\frac{x^3}{3} + x^2 - 5x + C = \\frac{x^3}{6} + x^2 - 5x + C$."
  },
  { id: 'd215_q2', type: 'mcq', question: "[M√£ 215 - C√¢u 2]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd215_q3', type: 'mcq', question: "[M√£ 215 - C√¢u 3]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd215_q4', type: 'mcq', question: "[M√£ 215 - C√¢u 4]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd215_q5', type: 'mcq', question: "[M√£ 215 - C√¢u 5]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd215_q6', type: 'mcq', question: "[M√£ 215 - C√¢u 6]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd215_q7', type: 'mcq', question: "[M√£ 215 - C√¢u 7]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd215_q8', type: 'mcq', question: "[M√£ 215 - C√¢u 8]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd215_q9', type: 'mcq', question: "[M√£ 215 - C√¢u 9]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd215_q10', type: 'mcq', question: "[M√£ 215 - C√¢u 10]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd215_q11', type: 'mcq', question: "[M√£ 215 - C√¢u 11]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd215_q12', type: 'mcq', question: "[M√£ 215 - C√¢u 12]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },

  // --- Ph·∫ßn 2: ƒê√∫ng/Sai (M√£ 215) ---
  { id: 'd215_q13', type: 'group_tf', question: "[M√£ 215 - C√¢u 13]...", subQuestions: [{id:'a', text:'...', correct:true}], explanation: "..." },
  { id: 'd215_q14', type: 'group_tf', question: "[M√£ 215 - C√¢u 14]...", subQuestions: [{id:'a', text:'...', correct:true}], explanation: "..." },
  { id: 'd215_q15', type: 'group_tf', question: "[M√£ 215 - C√¢u 15]...", subQuestions: [{id:'a', text:'...', correct:true}], explanation: "..." },
  { id: 'd215_q16', type: 'group_tf', question: "[M√£ 215 - C√¢u 16]...", subQuestions: [{id:'a', text:'...', correct:true}], explanation: "..." },

  // --- Ph·∫ßn 3: Tr·∫£ l·ªùi ng·∫Øn (M√£ 215) ---
  { 
    id: 'd215_q17', type: 'text', 
    question: "T√≠nh th·ªÉ t√≠ch n∆∞·ªõc trong c·ªëc bi·∫øt $V=\\int_{-4}^{4}\\frac{3}{2}(16-x^2)dx$. (K·∫øt qu·∫£ l√† s·ªë nguy√™n)", 
    acceptable: ["128"], 
    explanation: "$V = 128$." 
  },
  { 
    id: 'd215_q18', type: 'text', 
    question: "Tr∆∞·ªùng mu·ªën l√†m c·ª≠a Parabol cao 2,25m, r·ªông 3m. Gi√° 1.500.000ƒë/m2. T√≠nh s·ªë ti·ªÅn ph·∫£i tr·∫£ (ƒë∆°n v·ªã ngh√¨n ƒë·ªìng).", 
    acceptable: ["6750"], 
    image: <ParabolImage />, // S·ª≠ d·ª•ng SVG component
    explanation: "Di·ªán t√≠ch $S = \\frac{2}{3} \\times 3 \\times 2.25 = 4.5 m^2$. Ti·ªÅn = $4.5 \\times 1.500 = 6.750$ (ngh√¨n ƒë·ªìng)." 
  },
  { id: 'd215_q19', type: 'text', question: "[M√£ 215 - C√¢u 19]...", acceptable: ["0"], explanation: "..." },
  { id: 'd215_q20', type: 'text', question: "[M√£ 215 - C√¢u 20]...", acceptable: ["0"], explanation: "..." },
  { id: 'd215_q21', type: 'text', question: "[M√£ 215 - C√¢u 21]...", acceptable: ["0"], explanation: "..." },
  { id: 'd215_q22', type: 'text', question: "[M√£ 215 - C√¢u 22]...", acceptable: ["0"], explanation: "..." },


  // ============================================================
  // M√É ƒê·ªÄ 317
  // ============================================================
  
  // --- Ph·∫ßn 1: Tr·∫Øc nghi·ªám ---
  {
    id: 'd317_q1', type: 'mcq',
    question: "Tr√™n kho·∫£ng $(-\\infty;+\\infty)$, h√†m s·ªë $F(x)=\\frac{1}{2}\\sin 2x$ l√† m·ªôt nguy√™n h√†m c·ªßa h√†m s·ªë n√†o?",
    options: [
      "$f(x)=-\\cos 2x$",
      "$f(x)=\\sin 2x$",
      "$f(x)=\\cos 2x$",
      "$f(x)=-\\frac{1}{2}\\cos 2x$"
    ],
    correct: 2, explanation: "$F'(x) = (\\frac{1}{2}\\sin 2x)' = \\frac{1}{2} . 2\\cos 2x = \\cos 2x$."
  },
  {
    id: 'd317_q2', type: 'mcq',
    question: "Tr√™n kho·∫£ng $(-\\infty;+\\infty)$, h√†m s·ªë $F(x)$ (trong ƒë·ªÅ g·ªëc b·ªã c·∫Øt) l√† nguy√™n h√†m c·ªßa...?",
    options: ["A", "B", "C", "D"],
    correct: 3, explanation: "(D·ª±a tr√™n snippet: Ch·ªçn D)"
  },
  { id: 'd317_q3', type: 'mcq', question: "[M√£ 317 - C√¢u 3]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd317_q4', type: 'mcq', question: "[M√£ 317 - C√¢u 4]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd317_q5', type: 'mcq', question: "[M√£ 317 - C√¢u 5]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd317_q6', type: 'mcq', question: "[M√£ 317 - C√¢u 6]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd317_q7', type: 'mcq', question: "[M√£ 317 - C√¢u 7]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd317_q8', type: 'mcq', question: "[M√£ 317 - C√¢u 8]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd317_q9', type: 'mcq', question: "[M√£ 317 - C√¢u 9]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd317_q10', type: 'mcq', question: "[M√£ 317 - C√¢u 10]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd317_q11', type: 'mcq', question: "[M√£ 317 - C√¢u 11]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },
  { id: 'd317_q12', type: 'mcq', question: "[M√£ 317 - C√¢u 12]...", options: ["A", "B", "C", "D"], correct: 0, explanation: "..." },

  // --- Ph·∫ßn 2: ƒê√∫ng/Sai (M√£ 317) ---
  { id: 'd317_q13', type: 'group_tf', question: "[M√£ 317 - C√¢u 13]...", subQuestions: [{id:'a', text:'...', correct:true}], explanation: "..." },
  { id: 'd317_q14', type: 'group_tf', question: "[M√£ 317 - C√¢u 14]...", subQuestions: [{id:'a', text:'...', correct:true}], explanation: "..." },
  { id: 'd317_q15', type: 'group_tf', question: "[M√£ 317 - C√¢u 15]...", subQuestions: [{id:'a', text:'...', correct:true}], explanation: "..." },
  { id: 'd317_q16', type: 'group_tf', question: "[M√£ 317 - C√¢u 16]...", subQuestions: [{id:'a', text:'...', correct:true}], explanation: "..." },

  // --- Ph·∫ßn 3: Tr·∫£ l·ªùi ng·∫Øn (M√£ 317) ---
  { 
    id: 'd317_q17', type: 'text', 
    question: "Th·ªÉ t√≠ch c·ªßa chi ti·∫øt m√°y (ƒë·ªÅ 317) b·∫±ng bao nhi√™u $cm^3$ (l√†m tr√≤n k·∫øt qu·∫£ ƒë·∫øn h√†ng ph·∫ßn m∆∞·ªùi)?", 
    acceptable: ["34", "34.0"], 
    image: <MachinePartImage />, // S·ª≠ d·ª•ng SVG component
    explanation: "D·ª±a tr√™n ƒë√°p √°n tr√≠ch xu·∫•t t·ª´ t√†i li·ªáu: 34." 
  },
  { id: 'd317_q18', type: 'text', question: "[M√£ 317 - C√¢u 18]...", acceptable: ["0"], explanation: "..." },
  { id: 'd317_q19', type: 'text', question: "[M√£ 317 - C√¢u 19]...", acceptable: ["0"], explanation: "..." },
  { id: 'd317_q20', type: 'text', question: "[M√£ 317 - C√¢u 20]...", acceptable: ["0"], explanation: "..." },
  { id: 'd317_q21', type: 'text', question: "[M√£ 317 - C√¢u 21]...", acceptable: ["0"], explanation: "..." },
  { id: 'd317_q22', type: 'text', question: "[M√£ 317 - C√¢u 22]...", acceptable: ["0"], explanation: "..." }
];

// --- H√ÄM T·∫†O ƒê·ªÄ ---
const generateRandomQuiz = () => {
  const mcqPool = QUESTION_BANK.filter(q => q.type === 'mcq');
  const tfPool = QUESTION_BANK.filter(q => q.type === 'group_tf');
  const textPool = QUESTION_BANK.filter(q => q.type === 'text');

  // L·∫•y ng·∫´u nhi√™n s·ªë l∆∞·ª£ng c√¢u h·ªèi c·∫ßn thi·∫øt cho m·ªói ph·∫ßn
  // N·∫øu ng√¢n h√†ng ch∆∞a ƒë·ªß c√¢u, n√≥ s·∫Ω l·∫•y t·∫•t c·∫£ nh·ªØng g√¨ ƒëang c√≥
  const selectedMcq = [...mcqPool].sort(() => 0.5 - Math.random()).slice(0, 12);
  const selectedTf = [...tfPool].sort(() => 0.5 - Math.random()).slice(0, 4);
  const selectedText = [...textPool].sort(() => 0.5 - Math.random()).slice(0, 6);

  return [...selectedMcq, ...selectedTf, ...selectedText];
};

// --- LOGIC T√çNH ƒêI·ªÇM ---
const calculateScore = (currentQuestions, answers) => {
  let score = 0;
  currentQuestions.forEach(q => {
    if (q.type === 'mcq') {
      if (answers[q.id] === q.correct) score += 0.25;
    } else if (q.type === 'text') {
      const userAns = (answers[q.id] || "").trim();
      if (q.acceptable.includes(userAns)) score += 0.5;
    } else if (q.type === 'group_tf') {
      let correctCount = 0;
      const userGroupAns = answers[q.id] || {};
      q.subQuestions.forEach(sub => {
        if (userGroupAns[sub.id] === sub.correct) correctCount++;
      });
      if (correctCount === 1) score += 0.1;
      else if (correctCount === 2) score += 0.25;
      else if (correctCount === 3) score += 0.5;
      else if (correctCount === 4) score += 1.0;
    }
  });
  return Math.round(score * 100) / 100;
};

// --- COMPONENTS ---

const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
        <h3 className="text-xl font-bold text-gray-800 mb-2">{title}</h3>
        <p className="text-gray-600 mb-6">{message}</p>
        <div className="flex gap-3 justify-end">
          <button onClick={onCancel} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">H·ªßy b·ªè</button>
          <button onClick={onConfirm} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ƒê·ªìng √Ω</button>
        </div>
      </div>
    </div>
  );
};

const WelcomeScreen = ({ onSelectMode }) => (
  <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-cyan-600 to-blue-800 p-4 text-white">
    <div className="bg-white/10 backdrop-blur-md p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border border-white/20">
      <div className="mb-6 flex justify-center"><BookOpen size={64} className="text-yellow-300 drop-shadow-lg" /></div>
      <h1 className="text-3xl font-bold mb-2">TRANDAIEDU</h1>
      <h2 className="text-lg mb-8 text-cyan-100 font-medium">CHUY√äN ƒê·ªÄ NGUY√äN H√ÄM T√çCH PH√ÇN</h2>
      <div className="space-y-4">
        <button onClick={() => onSelectMode('student')} className="w-full py-4 bg-white text-blue-800 rounded-xl font-bold hover:bg-blue-50 transition-all flex items-center justify-center gap-2"><User /> H·ªçc Sinh L√†m B√†i</button>
        <button onClick={() => onSelectMode('teacher')} className="w-full py-4 bg-blue-900/50 text-white rounded-xl font-bold hover:bg-blue-900 transition-all flex items-center justify-center gap-2 border border-blue-400/30"><Lock size={20} /> Gi√°o Vi√™n Xem ƒêi·ªÉm</button>
      </div>
    </div>
  </div>
);

const StudentNameInput = ({ onStart }) => {
  const [name, setName] = useState('');
  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50 p-4">
      <form onSubmit={(e) => { e.preventDefault(); if(name.trim()) onStart(name); }} className="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full">
        <h2 className="text-2xl font-bold text-gray-800 mb-2 text-center">Nh·∫≠p Th√¥ng Tin</h2>
        <div className="mb-6">
          <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500" placeholder="H·ªç v√† t√™n..." required />
          <p className="text-xs text-green-600 mt-2 flex items-center gap-1"><CheckCircle size={12}/> Ch·∫ø ƒë·ªô: H·ªçc sinh (Kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p)</p>
        </div>
        <button type="submit" className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors">B·∫Øt ƒê·∫ßu</button>
      </form>
    </div>
  );
};

const QuizView = ({ studentName, questions, onSubmit, isConnected }) => {
  const [answers, setAnswers] = useState({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showConfirm, setShowConfirm] = useState(false); 

  useEffect(() => { window.scrollTo(0, 0); }, []);

  const handleMcqChange = (qId, optIdx) => setAnswers(prev => ({ ...prev, [qId]: optIdx }));
  const handleTfChange = (qId, subId, val) => setAnswers(prev => ({ ...prev, [qId]: { ...(prev[qId] || {}), [subId]: val } }));
  const handleTextChange = (qId, val) => setAnswers(prev => ({ ...prev, [qId]: val }));

  const handleConfirmSubmit = async () => {
    setShowConfirm(false);
    setIsSubmitting(true);
    try { await onSubmit(answers); } catch (error) { setIsSubmitting(false); }
  };

  return (
    <div className="min-h-screen bg-gray-100 pb-20 relative">
      <ConfirmModal isOpen={showConfirm} title="N·ªôp b√†i" message="B·∫°n ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?" onConfirm={handleConfirmSubmit} onCancel={() => setShowConfirm(false)} />
      <div className="bg-white shadow-md p-4 sticky top-0 z-10 border-b border-gray-200">
        <div className="max-w-3xl mx-auto flex justify-between items-center">
          <div className="font-bold text-blue-700 flex items-center gap-2"><User size={18}/> {studentName}</div>
          <div className="flex items-center gap-3">
             <div className="text-sm font-semibold text-gray-500 hidden sm:block">ƒê·ªÅ thi: {questions.length} c√¢u</div>
             {isConnected ? <span className="flex items-center gap-1 text-xs text-green-600 font-bold bg-green-50 px-2 py-1 rounded-full border border-green-200"><Wifi size={14}/> Online</span> : <span className="flex items-center gap-1 text-xs text-red-600 font-bold bg-red-50 px-2 py-1 rounded-full border border-red-200 animate-pulse"><WifiOff size={14}/> Offline</span>}
          </div>
        </div>
      </div>

      <div className="max-w-3xl mx-auto p-4 space-y-8 mt-4">
        {questions.map((q, idx) => (
          <div key={q.id} className="bg-white rounded-xl shadow-sm p-6">
            <div className="mb-3">
              <span className={`inline-block text-xs font-bold px-2 py-1 rounded mb-2 ${q.type === 'mcq' ? 'bg-blue-100 text-blue-800' : q.type === 'group_tf' ? 'bg-purple-100 text-purple-800' : 'bg-orange-100 text-orange-800'}`}>
                {q.type === 'mcq' ? 'Ph·∫ßn 1: Tr·∫Øc nghi·ªám' : q.type === 'group_tf' ? 'Ph·∫ßn 2: ƒê√∫ng/Sai' : 'Ph·∫ßn 3: Tr·∫£ l·ªùi ng·∫Øn'}
              </span>
              <div className="font-medium text-gray-800 flex gap-2">
                <span className="font-bold text-blue-600 whitespace-nowrap">C√¢u {idx + 1}:</span>
                <MathText text={q.question} />
              </div>
              {/* Hi·ªÉn th·ªã h√¨nh ·∫£nh n·∫øu c√≥ */}
              {q.image && <div className="mt-3 flex justify-center">{q.image}</div>}
            </div>
            
            {q.type === 'mcq' && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                {q.options.map((opt, optIdx) => (
                  <button key={optIdx} onClick={() => handleMcqChange(q.id, optIdx)} className={`p-3 text-left rounded-lg border text-sm transition-all ${answers[q.id] === optIdx ? 'bg-blue-100 border-blue-500 text-blue-800 font-medium ring-1 ring-blue-500' : 'hover:bg-gray-50 border-gray-200'}`}>
                    <span className="font-bold mr-2">{String.fromCharCode(65 + optIdx)}.</span>
                    <MathText text={opt} />
                  </button>
                ))}
              </div>
            )}

            {q.type === 'group_tf' && (
              <div className="border rounded-lg overflow-hidden">
                <table className="w-full text-sm">
                  <thead className="bg-gray-100">
                    <tr><th className="p-3 text-left">M·ªánh ƒë·ªÅ</th><th className="p-3 w-16 text-center">ƒê√∫ng</th><th className="p-3 w-16 text-center">Sai</th></tr>
                  </thead>
                  <tbody className="divide-y">
                    {q.subQuestions.map(sub => {
                      const currentVal = (answers[q.id] || {})[sub.id];
                      return (
                        <tr key={sub.id} className="hover:bg-gray-50">
                          <td className="p-3"><MathText text={sub.text} /></td>
                          <td className="p-3 text-center"><input type="radio" name={`${q.id}-${sub.id}`} checked={currentVal === true} onChange={() => handleTfChange(q.id, sub.id, true)} className="w-5 h-5 cursor-pointer accent-blue-600"/></td>
                          <td className="p-3 text-center"><input type="radio" name={`${q.id}-${sub.id}`} checked={currentVal === false} onChange={() => handleTfChange(q.id, sub.id, false)} className="w-5 h-5 cursor-pointer accent-red-600"/></td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            )}

            {q.type === 'text' && (
              <input type="text" value={answers[q.id] || ''} onChange={(e) => handleTextChange(q.id, e.target.value)} className="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nh·∫≠p ƒë√°p √°n..." />
            )}
          </div>
        ))}

        <div className="flex justify-center pt-6">
          <button onClick={() => setShowConfirm(true)} disabled={isSubmitting} className={`px-8 py-4 text-white text-lg font-bold rounded-xl shadow-lg flex items-center gap-2 transition-all ${isSubmitting ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 transform hover:scale-105'}`}>
            {isSubmitting ? <><Loader2 className="animate-spin"/> ƒêANG G·ª¨I...</> : <><Save /> N·ªòP B√ÄI</>}
          </button>
        </div>
      </div>
    </div>
  );
};

const SolutionView = ({ questions, answers, score, onRetry }) => {
  const [openExplain, setOpenExplain] = useState({});
  const toggleExplain = (id) => setOpenExplain(prev => ({ ...prev, [id]: !prev[id] }));
  const renderStatus = (isCorrect) => (isCorrect ? <span className="text-green-600 font-bold flex items-center gap-1"><CheckCircle size={16}/> ƒê√∫ng</span> : <span className="text-red-500 font-bold flex items-center gap-1"><XCircle size={16}/> Sai</span>);
  const isPassed = score >= PASSING_SCORE;

  return (
    <div className={`min-h-screen pb-20 ${isPassed ? 'bg-green-50' : 'bg-red-50'}`}>
       <div className={`shadow p-6 text-center mb-6 ${isPassed ? 'bg-white' : 'bg-white border-b-4 border-red-500'}`}>
         {isPassed ? <Trophy size={56} className="text-yellow-500 mx-auto mb-2 animate-bounce"/> : <AlertOctagon size={56} className="text-red-500 mx-auto mb-2"/>}
         <h2 className={`text-2xl font-bold ${isPassed ? 'text-green-700' : 'text-red-700'}`}>{isPassed ? "Ch√∫c M·ª´ng! B·∫°n ƒê√£ V∆∞·ª£t Qua" : "Ch∆∞a ƒê·∫°t Y√™u C·∫ßu"}</h2>
         <div className={`mt-4 inline-block px-6 py-3 rounded-xl border ${isPassed ? 'bg-green-100 border-green-200' : 'bg-red-100 border-red-200'}`}>
            <span className="text-gray-600 uppercase text-xs font-bold block">T·ªïng ƒêi·ªÉm</span>
            <span className={`text-4xl font-bold ${isPassed ? 'text-green-700' : 'text-red-700'}`}>{score.toFixed(2)}<span className="text-xl text-gray-500">/10</span></span>
         </div>
         <p className="text-gray-600 mt-3 text-sm max-w-md mx-auto">{isPassed ? "K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c l∆∞u. H√£y xem l·∫°i l·ªùi gi·∫£i chi ti·∫øt b√™n d∆∞·ªõi." : `B·∫°n c·∫ßn ƒë·∫°t t·ªëi thi·ªÉu ${PASSING_SCORE} ƒëi·ªÉm. K·∫øt qu·∫£ n√†y KH√îNG ƒë∆∞·ª£c l∆∞u. H√£y b·∫•m n√∫t "L√†m l·∫°i ƒë·ªÅ m·ªõi" ·ªü cu·ªëi trang.`}</p>
       </div>

       {isPassed ? (
         <div className="max-w-3xl mx-auto p-4 space-y-6">
           <h3 className="font-bold text-gray-700 flex items-center gap-2 mb-4"><CheckSquare size={20}/> Chi Ti·∫øt B√†i L√†m & L·ªùi Gi·∫£i</h3>
           {questions.map((q, idx) => {
              let isCorrect = false;
              let userAnswerDisplay = 'Ch∆∞a l√†m';
              let correctAnswerDisplay = '';

              if (q.type === 'mcq') {
                isCorrect = answers[q.id] === q.correct;
                userAnswerDisplay = answers[q.id] !== undefined ? String.fromCharCode(65 + answers[q.id]) : '...';
                correctAnswerDisplay = String.fromCharCode(65 + q.correct);
              } else if (q.type === 'text') {
                const u = (answers[q.id] || "").trim();
                isCorrect = q.acceptable.includes(u);
                userAnswerDisplay = u || '...';
                correctAnswerDisplay = q.acceptable.join(" ho·∫∑c ");
              } else {
                userAnswerDisplay = 'Xem chi ti·∫øt';
              }

              const isOpen = openExplain[q.id];
              return (
                <div key={q.id} className={`bg-white rounded-lg shadow-sm border-l-4 ${q.type === 'group_tf' ? 'border-blue-400' : (isCorrect ? 'border-green-500' : 'border-red-500')} overflow-hidden`}>
                  <div className="p-4 cursor-pointer" onClick={() => toggleExplain(q.id)}>
                    <div className="flex justify-between items-start">
                       <div className="font-medium text-gray-800 flex-1 flex gap-2"><span className="font-bold whitespace-nowrap">C√¢u {idx + 1}:</span> <MathText text={q.question} /></div>
                       {q.type !== 'group_tf' && <div className="ml-2 shrink-0">{renderStatus(isCorrect)}</div>}
                    </div>
                    {q.type !== 'group_tf' && (
                      <div className="mt-2 text-sm text-gray-600 flex justify-between items-center">
                         <span>B·∫°n ch·ªçn: <b>{userAnswerDisplay}</b> | ƒê√°p √°n: <b className="text-green-600">{correctAnswerDisplay}</b></span>
                         {isOpen ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}
                      </div>
                    )}
                    {q.type === 'group_tf' && <div className="text-right text-xs text-blue-500 mt-2">Xem chi ti·∫øt √Ω ƒë√∫ng/sai ‚ñº</div>}
                  </div>
                  {isOpen && (
                    <div className="bg-blue-50 p-4 text-sm text-blue-900 border-t border-blue-100">
                      {q.image && <div className="mb-4 flex justify-center">{q.image}</div>}
                      {q.type === 'group_tf' && (
                        <div className="mb-3 bg-white rounded border p-2">
                          {q.subQuestions.map(sub => {
                             const uVal = (answers[q.id] || {})[sub.id];
                             return (
                               <div key={sub.id} className="flex justify-between py-1 border-b last:border-0">
                                 <span><MathText text={sub.text} /></span>
                                 <span className={uVal === sub.correct ? 'text-green-600 font-bold' : 'text-red-500 font-bold'}>{uVal === true ? 'ƒê' : uVal === false ? 'S' : '-'} (ƒê√∫ng: {sub.correct ? 'ƒê' : 'S'})</span>
                               </div>
                             )
                          })}
                        </div>
                      )}
                      <span className="font-bold block mb-1">üí° L·ªùi gi·∫£i chi ti·∫øt:</span>
                      <MathText text={q.explanation} />
                    </div>
                  )}
                </div>
              );
           })}
         </div>
       ) : (
         <div className="max-w-md mx-auto p-8 text-center text-gray-500">
            <EyeOff size={64} className="mx-auto mb-4 text-gray-300"/>
            <p className="text-lg font-medium text-gray-600 mb-2">Ch·∫ø ƒë·ªô √¥n t·∫≠p</p>
            <p className="text-sm">H·ªá th·ªëng ƒë√£ ·∫©n to√†n b·ªô c√¢u h·ªèi v√† l·ªùi gi·∫£i ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh kh√°ch quan khi b·∫°n l√†m l·∫°i ƒë·ªÅ.</p>
         </div>
       )}
       <div className="flex justify-center pt-6 pb-10">
          {isPassed ? 
            <button onClick={() => window.location.reload()} className="px-8 py-3 bg-gray-600 text-white rounded-lg font-bold hover:bg-gray-700 shadow-lg flex items-center gap-2"><LogOut size={20}/> V·ªÅ trang ch·ªß</button> :
            <button onClick={onRetry} className="px-8 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 shadow-lg flex items-center gap-2 animate-bounce"><RotateCcw size={20}/> L√†m l·∫°i ƒë·ªÅ m·ªõi</button>
          }
       </div>
    </div>
  );
};

const TeacherLogin = ({ onLogin, onBack }) => {
  const [pass, setPass] = useState('');
  const [error, setError] = useState('');
  return ( 
    <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4"> 
      <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm"> 
        <h2 className="text-xl font-bold mb-6 text-gray-800 text-center">Gi√°o Vi√™n ƒêƒÉng Nh·∫≠p</h2> 
        <form onSubmit={(e) => { e.preventDefault(); pass === '12345678T' ? onLogin() : setError('Sai m·∫≠t kh·∫©u!'); }} className="space-y-4"> 
          <input type="password" value={pass} onChange={(e) => setPass(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="M·∫≠t kh·∫©u..." autoFocus/> 
          {error && <p className="text-red-500 text-sm text-center">{error}</p>} 
          <button type="submit" className="w-full py-3 bg-blue-700 text-white rounded-lg font-bold hover:bg-blue-800">Truy c·∫≠p</button> 
          <button type="button" onClick={onBack} className="w-full py-2 text-gray-500 hover:text-gray-800 text-sm">Quay l·∫°i</button> 
        </form> 
      </div> 
    </div> 
  );
};

const TeacherDashboard = ({ onLogout }) => {
  const [results, setResults] = useState([]);
  useEffect(() => {
    const q = collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results_conditional_prob');
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => {
         const d = doc.data();
         let time = 0;
         if (d.timestamp && d.timestamp.seconds) { time = d.timestamp.seconds; } else if (d.timestamp instanceof Date) { time = d.timestamp.getTime() / 1000; } else if (typeof d.timestamp === 'string') { time = new Date(d.timestamp).getTime() / 1000; }
         return { id: doc.id, ...d, sortTime: time };
      });
      data.sort((a, b) => b.sortTime - a.sortTime);
      setResults(data);
    }, (error) => { console.error("L·ªói t·∫£i d·ªØ li·ªáu:", error); });
    return () => unsubscribe();
  }, []);

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="bg-white shadow px-6 py-4 flex justify-between items-center sticky top-0 z-10">
        <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2"><ClipboardList className="text-blue-600"/> B·∫£ng ƒêi·ªÉm (Ch·ªâ hi·ªán b√†i ƒë·∫°t)</h1>
        <button onClick={onLogout} className="text-red-600 hover:bg-red-50 px-4 py-2 rounded-lg flex items-center gap-2 font-medium"><LogOut size={18}/> ƒêƒÉng xu·∫•t</button>
      </div>
      <div className="max-w-6xl mx-auto p-6">
        <div className="bg-white rounded-xl shadow overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-100 border-b">
                <tr><th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase">Th·ªùi gian</th><th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase">H·ªç v√† T√™n</th><th className="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase">ƒêi·ªÉm S·ªë (10)</th><th className="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase">X·∫øp lo·∫°i</th></tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {results.length === 0 ? ( <tr><td colSpan="4" className="p-8 text-center text-gray-500">Ch∆∞a c√≥ b√†i thi n√†o ƒë∆∞·ª£c n·ªôp.</td></tr> ) : results.map((res) => (
                  <tr key={res.id} className="hover:bg-gray-50">
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{res.timestamp ? new Date(res.sortTime * 1000).toLocaleString('vi-VN') : 'V·ª´a xong'}</td>
                    <td className="px-6 py-4 whitespace-nowrap font-medium text-gray-900">{res.name}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-center"><span className="text-lg font-bold text-blue-700">{res.score?.toFixed(2)}</span></td>
                    <td className="px-6 py-4 whitespace-nowrap text-center"><span className={`px-3 py-1 rounded-full text-xs font-bold ${res.score >= 8 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>{res.score >= 8 ? 'Gi·ªèi' : res.score >= 6.5 ? 'Kh√°' : 'Trung B√¨nh'}</span></td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
};

// --- APP CH√çNH ---
export default function App() {
  const [user, setUser] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [view, setView] = useState('welcome'); 
  const [studentName, setStudentName] = useState('');
  const [finalScore, setFinalScore] = useState(0);
  const [currentQuestions, setCurrentQuestions] = useState([]); 
  const [userAnswers, setUserAnswers] = useState({});

  useEffect(() => {
    let authTimeout;
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } 
        else { await signInAnonymously(auth); }
      } catch (e) { console.error("L·ªói x√°c th·ª±c:", e); }
    };
    initAuth();
    authTimeout = setTimeout(() => setIsAuthReady(true), 3000);
    const unsubscribe = onAuthStateChanged(auth, (u) => { setUser(u); setIsAuthReady(true); clearTimeout(authTimeout); });
    return () => { unsubscribe(); clearTimeout(authTimeout); };
  }, []);

  const startNewQuiz = (name) => {
    setStudentName(name);
    const newQuestions = generateRandomQuiz();
    setCurrentQuestions(newQuestions);
    setView('quiz');
  };

  const handleRetry = () => {
    const newQuestions = generateRandomQuiz();
    setCurrentQuestions(newQuestions);
    setView('quiz');
  };

  const handleSubmitQuiz = async (answers) => {
    const score = calculateScore(currentQuestions, answers);
    setFinalScore(score);
    setUserAnswers(answers);
    
    if (score >= PASSING_SCORE) {
        if (!user) { console.warn("Kh√¥ng th·ªÉ l∆∞u ƒëi·ªÉm do m·∫•t k·∫øt n·ªëi/ch·∫ø ƒë·ªô kh√°ch"); } 
        else {
          const sanitizedAnswers = JSON.parse(JSON.stringify(answers));
          try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results_conditional_prob'), {
              name: studentName, score: score, questionIds: currentQuestions.map(q => q.id), answers: sanitizedAnswers, timestamp: new Date().toISOString()
            });
          } catch (error) { console.error("L·ªói Firestore:", error); }
        }
    }
    setView('result'); 
  };

  if (!isAuthReady) return <div className="h-screen flex items-center justify-center text-blue-600 font-medium"><Loader2 className="animate-spin mr-2"/> ƒêang t·∫£i d·ªØ li·ªáu...</div>;

  if (view === 'welcome') return <WelcomeScreen onSelectMode={(m) => setView(m === 'student' ? 'name' : 'teacher-login')} />;
  if (view === 'name') return <StudentNameInput onStart={startNewQuiz} />;
  if (view === 'quiz') return <QuizView studentName={studentName} questions={currentQuestions} onSubmit={handleSubmitQuiz} isConnected={!!user} />;
  if (view === 'result') return <SolutionView questions={currentQuestions} answers={userAnswers} score={finalScore} onRetry={handleRetry} />;
  if (view === 'teacher-login') return <TeacherLogin onLogin={() => setView('teacher-dashboard')} onBack={() => setView('welcome')} />;
  if (view === 'teacher-dashboard') return <TeacherDashboard onLogout={() => setView('welcome')} />;

  return null;
}
