<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·ªÅ Thi Th·ª≠ T·ªët Nghi·ªáp THPT 2025 - M√¥n To√°n - ƒê·ªÅ S·ªë 02</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX for Math -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .katex { font-size: 1.1em; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .overflow-x-auto::-webkit-scrollbar { height: 8px; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
        }
        .animate-pulse-red { animation: pulse-red 2s infinite; }

        @keyframes blink-text {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-blink { animation: blink-text 1s infinite; }
        
        /* ƒê·∫£m b·∫£o modal lu√¥n n·∫±m tr√™n c√πng */
        .z-modal { z-index: 9999 !important; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;

        // --- C·∫§U H√åNH FIREBASE ---
        const USER_CONFIG = {
            apiKey: "AIzaSyCEgOrAaEHjZbhYTSkVHGRkGa8WfjjnWvg",
            authDomain: "trandaiedu-39df1.firebaseapp.com",
            projectId: "trandaiedu-39df1",
            storageBucket: "trandaiedu-39df1.firebasestorage.app",
            messagingSenderId: "286264195114",
            appId: "1:286264195114:web:c6ca2fe8e1b3e7e25ceb53"
        };

        let db = null;
        let auth = null;
        const COLLECTION_NAME = "quiz_results_math12_thpt2025_de01_full";
        const SETTINGS_COLLECTION = "quiz_config_math12"; // Collection ri√™ng cho c√†i ƒë·∫∑t
        const SETTINGS_DOC_ID = "exam_01_settings";

        // C√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh
        const DEFAULT_SETTINGS = {
            antiCheat: true,
            maxViolations: 3, 
            timerEnabled: true,
            timerMode: 'countdown', // 'countdown' | 'realtime' | 'countup'
            timerDuration: 90, // ph√∫t
            requirePassToViewSolution: true,
            passScore: 7.0
        };

        const initializeFirebase = () => {
            try {
                if (!window.firebase) return false;
                if (firebase.apps.length === 0) firebase.initializeApp(USER_CONFIG);
                auth = firebase.auth();
                db = firebase.firestore();
                return true;
            } catch (e) { console.error(e); return false; }
        };
        initializeFirebase();

        // --- COMPONENTS H·ªñ TR·ª¢ ---
        const Icon = ({ name, size=24, className="" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                   const iconElement = window.lucide.icons[name];
                   if(iconElement) iconRef.current.innerHTML = iconElement.toSvg({ class: className, width: size, height: size });
                }
            }, [name, size, className]);
            return <span ref={iconRef} className={className} style={{display: 'inline-flex', alignItems: 'center'}}></span>;
        };

        const Toggle = ({ label, checked, onChange }) => (
            <div className="flex items-center justify-between mb-4">
                <span className="text-gray-700 font-medium">{label}</span>
                <div className="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id={label} className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300" 
                        style={{ right: checked ? '0' : 'auto', left: checked ? 'auto' : '0', borderColor: checked ? '#48bb78' : '#e2e8f0' }}
                        checked={checked} onChange={(e) => onChange(e.target.checked)}
                    />
                    <label htmlFor={label} className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer transition-colors duration-300 ${checked ? 'bg-green-400' : 'bg-gray-300'}`}></label>
                </div>
            </div>
        );

        const MathText = ({ text, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && text && window.renderMathInElement) {
                    renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "$", right: "$", display: false},
                            {left: "\\(", right: "\\)", display: false},
                            {left: "\\[", right: "\\]", display: true}
                        ],
                        throwOnError: false
                    });
                }
            }, [text]);
            return <span ref={containerRef} className={className} dangerouslySetInnerHTML={{__html: text}} />;
        };

        // --- H√åNH ·∫¢NH & B·∫¢NG BI·ªÇU (GI·ªÆ NGUY√äN) ---
        const TablePart1Q1 = () => ( <div className="flex justify-center my-4 overflow-x-auto"> <svg width="400" height="150" viewBox="0 0 400 150" className="bg-white rounded shadow-sm border border-gray-200 min-w-[400px]"> <defs> <marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth"> <path d="M0,0 L0,6 L9,3 z" fill="#000" /> </marker> </defs> <line x1="50" y1="0" x2="50" y2="150" stroke="#000" strokeWidth="1"/> <line x1="0" y1="40" x2="400" y2="40" stroke="#000" strokeWidth="1"/> <line x1="0" y1="80" x2="400" y2="80" stroke="#000" strokeWidth="1"/> <text x="25" y="25" fontFamily="Arial" fontSize="14">x</text> <text x="80" y="25" fontFamily="Arial" fontSize="14">-‚àû</text> <text x="180" y="25" fontFamily="Arial" fontSize="14">-1</text> <text x="280" y="25" fontFamily="Arial" fontSize="14">1</text> <text x="370" y="25" fontFamily="Arial" fontSize="14">+‚àû</text> <text x="10" y="65" fontFamily="Arial" fontSize="14">y'</text> <text x="130" y="65" fontFamily="Arial" fontSize="14">+</text> <text x="180" y="65" fontFamily="Arial" fontSize="14">0</text> <text x="230" y="65" fontFamily="Arial" fontSize="14">-</text> <text x="280" y="65" fontFamily="Arial" fontSize="14">0</text> <text x="330" y="65" fontFamily="Arial" fontSize="14">+</text> <text x="10" y="115" fontFamily="Arial" fontSize="14">y</text> <path d="M70,130 L170,95" stroke="#000" fill="none" markerEnd="url(#arrow)"/> <path d="M190,95 L270,130" stroke="#000" fill="none" markerEnd="url(#arrow)"/> <path d="M290,130 L380,95" stroke="#000" fill="none" markerEnd="url(#arrow)"/> <text x="60" y="135" fontFamily="Arial" fontSize="12">-‚àû</text> <text x="175" y="90" fontFamily="Arial" fontSize="12">2</text> <text x="275" y="140" fontFamily="Arial" fontSize="12">-2</text> <text x="380" y="90" fontFamily="Arial" fontSize="12">+‚àû</text> </svg> </div> );
        const TablePart1Q3 = () => ( <div className="my-4 overflow-x-auto"> <table className="min-w-full border border-collapse border-gray-300 text-sm text-center"> <thead> <tr className="bg-gray-100"> <th className="border border-gray-300 p-2 font-bold">Th·ªùi gian</th> <th className="border border-gray-300 p-2">[0; 20)</th> <th className="border border-gray-300 p-2">[20; 40)</th> <th className="border border-gray-300 p-2">[40; 60)</th> <th className="border border-gray-300 p-2">[60; 80)</th> </tr> </thead> <tbody> <tr> <th className="border border-gray-300 p-2 bg-gray-50 font-bold">S·ªë HS</th> <td className="border border-gray-300 p-2">5</td> <td className="border border-gray-300 p-2">12</td> <td className="border border-gray-300 p-2">18</td> <td className="border border-gray-300 p-2">5</td> </tr> </tbody> </table> </div> );
        const ParabolPart3Q2 = () => ( <div className="flex justify-center my-4"> <svg width="200" height="200" viewBox="-3 -5 6 6" className="bg-white rounded shadow-sm border border-gray-200"> <path d="M -2 0 Q 0 8 2 0" fill="none" stroke="black" strokeWidth="0.1" /> <line x1="-3" y1="0" x2="3" y2="0" stroke="black" strokeWidth="0.05" /> <line x1="0" y1="0" x2="0" y2="4" stroke="black" strokeWidth="0.05" strokeDasharray="0.1, 0.1" /> <circle cx="0" cy="3.75" r="0.1" fill="yellow" stroke="orange" strokeWidth="0.05" /> <text x="0.2" y="2" fontSize="0.5" fill="black">h=4m</text> <text x="-1" y="-0.5" fontSize="0.5" fill="black">w=4m</text> </svg> </div> );

        // --- NG√ÇN H√ÄNG C√ÇU H·ªéI (GI·ªÆ NGUY√äN) ---
        const QUESTION_BANK = [
            // --- PH·∫¶N I ---
            { id: 'p1_q1', type: 'mcq', question: "Cho h√†m s·ªë $y = f(x)$ c√≥ b·∫£ng bi·∫øn thi√™n nh∆∞ sau. H√†m s·ªë ƒë√£ cho ƒë·ªìng bi·∫øn tr√™n kho·∫£ng n√†o d∆∞·ªõi ƒë√¢y?", image: <TablePart1Q1 />, options: ["$(-1; 1)$", "$(1; +\\infty)$", "$(-\\infty; 1)$", "$(-1; 2)$"], correct: 1, explanation: "Nh√¨n v√†o b·∫£ng bi·∫øn thi√™n, d·∫•u c·ªßa $y'$ d∆∞∆°ng (+) tr√™n kho·∫£ng $(1; +\\infty)$ v√† $(-\\infty; -1)$." },
            { id: 'p1_q2', type: 'mcq', question: "Trong kh√¥ng gian $Oxyz$, cho vect∆° $\\vec{a} = 2\\vec{i} - 3\\vec{j} + \\vec{k}$. T·ªça ƒë·ªô c·ªßa vect∆° $\\vec{a}$ l√†", options: ["$(2; -3; 1)$", "$(2; 3; 1)$", "$(2; -3; 0)$", "$(1; -3; 2)$"], correct: 0, explanation: "Vect∆° $\\vec{a} = x\\vec{i} + y\\vec{j} + z\\vec{k}$ c√≥ t·ªça ƒë·ªô l√† $(x; y; z)$." },
            { id: 'p1_q3', type: 'mcq', question: "Cho m·∫´u s·ªë li·ªáu gh√©p nh√≥m v·ªÅ th·ªùi gian t·∫≠p th·ªÉ d·ª•c m·ªói ng√†y (ph√∫t) c·ªßa m·ªôt nh√≥m h·ªçc sinh. Nh√≥m ch·ª©a m·ªët c·ªßa m·∫´u s·ªë li·ªáu tr√™n l√†", image: <TablePart1Q3 />, options: ["$[0; 20)$", "$[20; 40)$", "$[40; 60)$", "$[60; 80)$"], correct: 2, explanation: "Nh√≥m ch·ª©a m·ªët l√† nh√≥m c√≥ t·∫ßn s·ªë l·ªõn nh·∫•t (18)." },
            { id: 'p1_q4', type: 'mcq', question: "Cho c·∫•p s·ªë nh√¢n $(u_n)$ v·ªõi $u_1 = 3$ v√† c√¥ng b·ªôi $q = 2$. Gi√° tr·ªã c·ªßa $u_3$ b·∫±ng", options: ["6", "8", "12", "24"], correct: 2, explanation: "$u_3 = 3 \\cdot 2^2 = 12$." },
            { id: 'p1_q5', type: 'mcq', question: "T·∫≠p nghi·ªám c·ªßa b·∫•t ph∆∞∆°ng tr√¨nh $\\log_2(x - 1) < 3$ l√†", options: ["$(-\\infty; 9)$", "$(1; 9)$", "$(1; 7)$", "$(-\\infty; 7)$"], correct: 1, explanation: "$x - 1 < 8 \\Rightarrow x < 9$. ƒêK: $x > 1$." },
            { id: 'p1_q6', type: 'mcq', question: "Trong kh√¥ng gian $Oxyz$, ph∆∞∆°ng tr√¨nh m·∫∑t ph·∫≥ng qua $M(1; -2; 3)$ v√† VTPT $\\vec{n} = (2; 1; -1)$ l√†", options: ["$2x + y - z + 3 = 0$", "$x - 2y + 3z + 3 = 0$", "$2x + y - z - 3 = 0$", "$2x + y - z + 5 = 0$"], correct: 0, explanation: "$2(x-1) + 1(y+2) - 1(z-3) = 0 \\Rightarrow 2x+y-z+3=0$." },
            { id: 'p1_q7', type: 'mcq', question: "Cho $P(A) = 0,3$, $P(B) = 0,4$, A v√† B ƒë·ªôc l·∫≠p. T√≠nh $P(A \\cup B)$.", options: ["0,12", "0,7", "0,58", "0,82"], correct: 2, explanation: "$P(A \\cup B) = 0,3 + 0,4 - 0,3 \\cdot 0,4 = 0,58$." },
            { id: 'p1_q8', type: 'mcq', question: "$F(x) = x^2 + \\sin x$ l√† nguy√™n h√†m c·ªßa h√†m s·ªë n√†o?", options: ["$2x + \\cos x$", "$2x - \\cos x$", "$x^3/3 - \\cos x$", "$x^2 + \\cos x$"], correct: 0, explanation: "$F'(x) = 2x + \\cos x$." },
            { id: 'p1_q9', type: 'mcq', question: "Ti·ªám c·∫≠n ƒë·ª©ng c·ªßa $y = \\frac{2x - 1}{x + 1}$ l√†", options: ["$x = 2$", "$y = 2$", "$x = -1$", "$y = -1$"], correct: 2, explanation: "M·∫´u b·∫±ng 0 t·∫°i $x = -1$." },
            { id: 'p1_q10', type: 'mcq', question: "H√¨nh ch√≥p S.ABCD, ƒë√°y vu√¥ng c·∫°nh a, $SA \\perp$ ƒë√°y, $SA=a\\sqrt{2}$. G√≥c gi·ªØa SC v√† ƒë√°y?", options: ["$30^\\circ$", "$45^\\circ$", "$60^\\circ$", "$90^\\circ$"], correct: 1, explanation: "Tan g√≥c = SA/AC = $a\\sqrt{2} / a\\sqrt{2} = 1 \\Rightarrow 45^\\circ$." },
            { id: 'p1_q11', type: 'mcq', question: "Ti·ªám c·∫≠n xi√™n c·ªßa $y = 2x + 1 + \\frac{3}{x-1}$ l√†", options: ["$y = 2x$", "$y = 2x + 1$", "$y = x - 1$", "$x = 1$"], correct: 1, explanation: "Ph·∫ßn b·∫≠c nh·∫•t l√† $2x + 1$." },
            { id: 'p1_q12', type: 'mcq', question: "$\\int_0^2 f = 5, \\int_2^5 f = 3$. T√≠nh $\\int_0^5 f$.", options: ["8", "2", "15", "-2"], correct: 0, explanation: "$5 + 3 = 8$." },
            // --- PH·∫¶N II ---
            { id: 'p2_q1', type: 'group_tf', question: "Cho h√†m s·ªë $y = \\frac{x^2 - 3x + 3}{x - 1}$.", subQuestions: [ { id: 'a', text: "TXƒê: $D = \\mathbb{R} \\setminus \\{1\\}$.", correct: true }, { id: 'b', text: "TCX: $y = x - 2$.", correct: true }, { id: 'c', text: "C·ª±c ƒë·∫°i t·∫°i $x = 2$.", correct: false }, { id: 'd', text: "ƒê∆∞·ªùng th·∫≥ng $y = -2x + m$ lu√¥n c·∫Øt ƒë·ªì th·ªã t·∫°i 2 ƒëi·ªÉm.", correct: false } ], explanation: "a, b ƒê√∫ng. c Sai (x=2 l√† c·ª±c ti·ªÉu). d Sai (c√≥ th·ªÉ v√¥ nghi·ªám)." },
            { id: 'p2_q2', type: 'group_tf', question: "Cho $A(1;0;0), B(0;2;0), C(0;0;3), D(1;2;3)$.", subQuestions: [ { id: 'a', text: "$\\vec{AB} = (-1; 2; 0)$.", correct: true }, { id: 'b', text: "Mp(ABC): $\\frac{x}{1} + \\frac{y}{2} + \\frac{z}{3} = 1$.", correct: true }, { id: 'c', text: "$D \\in (ABC)$.", correct: false }, { id: 'd', text: "$V_{OBCD} = 2$.", correct: false } ], explanation: "c Sai (D kh√¥ng thu·ªôc). d Sai ($V=1$)." },
            { id: 'p2_q3', type: 'group_tf', question: "L·ª£i nhu·∫≠n $P(t) = -t^3 + 12t^2 - 36t + 50$ ($0 \\le t \\le 8$).", subQuestions: [ { id: 'a', text: "Gi·∫£m t·ª´ th√°ng 2 ƒë·∫øn 6.", correct: false }, { id: 'b', text: "Min t·∫°i $t=6$.", correct: false }, { id: 'c', text: "TƒÉng tr∆∞·ªüng nhanh nh·∫•t t·∫°i $t=4$.", correct: true }, { id: 'd', text: "Max l√† 50.", correct: true } ], explanation: "a Sai (TƒÉng). b Sai (Max)." },
            { id: 'p2_q4', type: 'group_tf', question: "ƒêi·ªÉm thi l·ªõp 12A ($S_A^2=1.25, \\bar{x}=8$) v√† 12B ($S_B^2=1.8, \\bar{x}=7.5$).", subQuestions: [ { id: 'a', text: "TB l·ªõp A cao h∆°n.", correct: true }, { id: 'b', text: "ƒê·ªô l·ªách chu·∫©n l·ªõp A $\\approx 1.12$.", correct: true }, { id: 'c', text: "L·ªõp B ƒë·ªìng ƒë·ªÅu h∆°n.", correct: false }, { id: 'd', text: "TB chung l√† 7.75.", correct: true } ], explanation: "c Sai (L·ªõp A ƒë·ªìng ƒë·ªÅu h∆°n do ph∆∞∆°ng sai nh·ªè h∆°n)." },
            // --- PH·∫¶N III ---
            { id: 'p3_q1', type: 'text', question: "$s(t) = t^3 - 3t^2 + 4t + 1$. V·∫≠n t·ªëc khi gia t·ªëc b·∫±ng 0?", acceptable: ["1"], explanation: "$a=0 \\Rightarrow t=1 \\Rightarrow v(1)=1$." },
            { id: 'p3_q2', type: 'text', question: "C·ªïng parabol r·ªông 4m, cao 4m. Ti√™u ƒëi·ªÉm c√°ch ƒë·ªânh bao nhi√™u?", acceptable: ["0.25"], explanation: "$p = 1/4a = 0.25$." },
            { id: 'p3_q3', type: 'text', question: "G·ª≠i 100tr, l√£i 6%/nƒÉm. Sau bao l√¢u > 150tr?", acceptable: ["7"], explanation: "Logarit ra 6.96 nƒÉm -> 7 nƒÉm." },
            { id: 'p3_q4', type: 'text', question: "H√¨nh h·ªôp $A(000), B(300), D(040), A'(005)$. Kho·∫£ng c√°ch $A'$ ƒë·∫øn $(AB'D')$?", acceptable: ["2.2"], explanation: "D√πng c√¥ng th·ª©c kho·∫£ng c√°ch -> 2.16 -> 2.2." },
            { id: 'p3_q5', type: 'text', question: "$N(t) = 500e^{0.2t}$. T·ªëc ƒë·ªô tƒÉng t·∫°i $t=10$?", acceptable: ["739"], explanation: "ƒê·∫°o h√†m t·∫°i 10 -> 738.9." },
            { id: 'p3_q6', type: 'text', question: "H·ªôp 5 ƒë·ªè, 4 xanh. L·∫•y 3 qu·∫£. P(√≠t nh·∫•t 1 ƒë·ªè)?", acceptable: ["0.95"], explanation: "1 - P(to√†n xanh) = 1 - 4/84 = 0.95." }
        ];
        
        // --- LOGIC T√çNH ƒêI·ªÇM ---
        const calculateScore = (currentQuestions, answers) => {
            let score = 0;
            let totalMaxScore = 0; 
            currentQuestions.forEach(q => {
                let questionMaxScore = 0, questionScore = 0;
                if (q.type === 'mcq') {
                    questionMaxScore = 0.25; if (answers[q.id] === q.correct) questionScore = 0.25;
                } else if (q.type === 'text') {
                    questionMaxScore = 0.5; if (q.acceptable.includes((answers[q.id] || "").trim())) questionScore = 0.5;
                } else if (q.type === 'group_tf') {
                    questionMaxScore = 1.0; 
                    let correctCount = 0;
                    const userGroupAns = answers[q.id] || {};
                    q.subQuestions.forEach(sub => { if (userGroupAns[sub.id] === sub.correct) correctCount++; });
                    if (correctCount === 1) questionScore = 0.1;
                    else if (correctCount === 2) questionScore = 0.25;
                    else if (correctCount === 3) questionScore = 0.5;
                    else if (correctCount === 4) questionScore = 1.0;
                }
                score += questionScore;
                totalMaxScore += questionMaxScore;
            });
            if (totalMaxScore > 0) return Math.round((score / totalMaxScore) * 10 * 100) / 100;
            return 0;
        };
        
        // --- M√ÄN H√åNH CH√ÄO ---
        const WelcomeScreen = ({ onSelectMode }) => (
            <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-cyan-600 to-blue-800 p-4 text-white animate-fade-in">
                <div className="bg-white/10 backdrop-blur-md p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border border-white/20">
                    <h1 className="text-4xl font-bold mb-2">TRANDAIEDU</h1>
                    <h2 className="text-xl mb-8 text-cyan-100 font-medium">ƒê·ªÄ THI TH·ª¨ T·ªêT NGHI·ªÜP THPT 2025</h2>
                    <h3 className="text-lg mb-4 text-white font-bold bg-blue-600/50 py-1 rounded">M√îN TO√ÅN - ƒê·ªÄ S·ªê 02</h3>
                    <div className="space-y-4">
                        <button onClick={() => onSelectMode('student')} className="w-full py-4 bg-white text-blue-800 rounded-xl font-bold hover:bg-blue-50 transition-all shadow-lg flex items-center justify-center gap-2"><Icon name="user"/> H·ªçc Sinh V√†o Thi</button>
                        <button onClick={() => onSelectMode('teacher')} className="w-full py-4 bg-blue-900/50 text-white rounded-xl font-bold hover:bg-blue-900 transition-all border border-blue-400/30 flex items-center justify-center gap-2"><Icon name="lock"/> Gi√°o Vi√™n Xem ƒêi·ªÉm</button>
                    </div>
                </div>
            </div>
        );

        // --- NH·∫¨P T√äN ---
        const StudentNameInput = ({ onStart }) => {
            const [name, setName] = useState('');
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50 p-4 animate-fade-in">
                    <form onSubmit={(e) => { e.preventDefault(); if(name.trim()) onStart(name); }} className="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2 text-center">Nh·∫≠p Th√¥ng Tin</h2>
                        <div className="mb-6">
                            <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500" placeholder="H·ªç v√† t√™n..." required />
                        </div>
                        <button type="submit" className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors">B·∫Øt ƒê·∫ßu</button>
                    </form>
                </div>
            );
        };

        // --- HELPER: FORMAT TIME ---
        const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        const formatRealTime = (date) => {
            return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        };

        // --- L√ÄM B√ÄI THI ---
        const QuizView = ({ studentName, questions, onSubmit, settings }) => {
            const [answers, setAnswers] = useState({});
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            
            // State
            const [violationCount, setViolationCount] = useState(0);
            const [showWarning, setShowWarning] = useState(false);
            const maxV = settings.maxViolations || 3;
            
            // Timers
            const [timeLeft, setTimeLeft] = useState((settings.timerDuration || 90) * 60);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [currentTime, setCurrentTime] = useState(new Date());

            const answersRef = useRef(answers); 
            useEffect(() => { window.scrollTo(0, 0); }, []);
            useEffect(() => { answersRef.current = answers; }, [answers]);

            // Logic ƒê·ªìng h·ªì
            useEffect(() => {
                if (!settings.timerEnabled) return;

                const timer = setInterval(() => {
                    if (settings.timerMode === 'realtime') {
                        setCurrentTime(new Date());
                    } else if (settings.timerMode === 'countup') {
                        setElapsedTime(prev => prev + 1);
                    } else {
                        // Countdown
                        setTimeLeft(prev => {
                            if (prev <= 1) {
                                clearInterval(timer);
                                alert("H·∫æT GI·ªú L√ÄM B√ÄI! H·ªÜ TH·ªêNG S·∫º T·ª∞ ƒê·ªòNG N·ªòP B√ÄI.");
                                setIsSubmitting(true);
                                onSubmit(answersRef.current);
                                return 0;
                            }
                            return prev - 1;
                        });
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, [onSubmit, settings.timerEnabled, settings.timerMode]);

            // Ch·ªëng gian l·∫≠n
            useEffect(() => {
                if (!settings.antiCheat) return;
                const handleVisibilityChange = () => {
                    if (document.hidden) {
                        setViolationCount(prev => {
                            const newCount = prev + 1;
                            if (newCount >= maxV) {
                                alert(`B·∫†N ƒê√É VI PH·∫†M QUY CH·∫æ THI (R·ªúI M√ÄN H√åNH) QU√Å ${maxV} L·∫¶N. B√ÄI THI S·∫º T·ª∞ ƒê·ªòNG N·ªòP.`);
                                setIsSubmitting(true);
                                onSubmit(answersRef.current); 
                            }
                            return newCount;
                        });
                    } else {
                        setViolationCount(prev => { if (prev < maxV && prev > 0) setShowWarning(true); return prev; });
                    }
                };
                document.addEventListener("visibilitychange", handleVisibilityChange);
                return () => document.removeEventListener("visibilitychange", handleVisibilityChange);
            }, [onSubmit, settings.antiCheat, maxV]);

            const handleMcqChange = (qId, optIdx) => setAnswers(prev => ({ ...prev, [qId]: optIdx }));
            const handleTfChange = (qId, subId, val) => setAnswers(prev => ({ ...prev, [qId]: { ...(prev[qId] || {}), [subId]: val } }));
            const handleTextChange = (qId, val) => setAnswers(prev => ({ ...prev, [qId]: val }));
            
            const handleConfirmSubmit = async () => {
                setShowConfirmModal(false);
                setIsSubmitting(true);
                onSubmit(answers);
            };

            const isLowTime = timeLeft < 300; 

            return (
                <div className="min-h-screen bg-gray-100 pb-20 relative">
                    <div className="bg-white shadow-md p-4 sticky top-0 z-10 border-b border-gray-200">
                        <div className="max-w-4xl mx-auto flex flex-col md:flex-row justify-between items-center gap-3">
                            <div className="font-bold text-blue-700 flex items-center gap-2 w-full md:w-auto">
                                <Icon name="user" size={18}/> <span className="truncate">{studentName}</span>
                            </div>
                            
                            {settings.timerEnabled && (
                                <div className={`flex items-center gap-2 font-mono text-xl font-bold px-4 py-1 rounded-lg border ${settings.timerMode === 'countdown' && isLowTime ? 'bg-red-50 text-red-600 border-red-200 animate-blink' : 'bg-gray-50 text-gray-700 border-gray-200'}`}>
                                    <Icon name="clock" size={20} />
                                    {settings.timerMode === 'realtime' ? formatRealTime(currentTime) : 
                                     settings.timerMode === 'countup' ? formatTime(elapsedTime) :
                                     formatTime(timeLeft)}
                                </div>
                            )}

                            {settings.antiCheat && (
                                <div className="text-xs font-bold px-3 py-1 bg-red-100 text-red-600 rounded-full border border-red-200 w-full md:w-auto text-center">
                                    Vi ph·∫°m: {violationCount}/{maxV}
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="max-w-3xl mx-auto p-4 space-y-8 mt-4 animate-fade-in">
                        {questions.map((q, idx) => (
                            <div key={q.id} className="bg-white rounded-xl shadow-sm p-6 transition-all hover:shadow-md">
                                <div className="mb-3">
                                    <span className={`inline-block text-xs font-bold px-2 py-1 rounded mb-2 ${q.type === 'mcq' ? 'bg-blue-100 text-blue-800' : q.type === 'group_tf' ? 'bg-purple-100 text-purple-800' : 'bg-orange-100 text-orange-800'}`}>
                                        {q.type === 'mcq' ? 'Ph·∫ßn 1: Tr·∫Øc nghi·ªám' : q.type === 'group_tf' ? 'Ph·∫ßn 2: ƒê√∫ng/Sai' : 'Ph·∫ßn 3: Tr·∫£ l·ªùi ng·∫Øn'}
                                    </span>
                                    <div className="font-medium text-gray-800 flex gap-2">
                                        <span className="font-bold text-blue-600 whitespace-nowrap">C√¢u {idx + 1}:</span>
                                        <MathText text={q.question} />
                                    </div>
                                    {q.image && <div className="mt-3 flex justify-center">{q.image}</div>}
                                </div>
                                {q.type === 'mcq' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        {q.options.map((opt, optIdx) => (
                                            <button key={optIdx} onClick={() => handleMcqChange(q.id, optIdx)} className={`p-3 text-left rounded-lg border text-sm transition-all ${answers[q.id] === optIdx ? 'bg-blue-100 border-blue-500 text-blue-800 font-medium ring-1 ring-blue-500' : 'hover:bg-gray-50 border-gray-200'}`}>
                                                <span className="font-bold mr-2">{String.fromCharCode(65 + optIdx)}.</span><MathText text={opt} />
                                            </button>
                                        ))}
                                    </div>
                                )}
                                {q.type === 'group_tf' && (
                                    <div className="border rounded-lg overflow-hidden">
                                        <table className="w-full text-sm">
                                            <thead className="bg-gray-100"><tr><th className="p-3 text-left">M·ªánh ƒë·ªÅ</th><th className="p-3 w-16 text-center">ƒê√∫ng</th><th className="p-3 w-16 text-center">Sai</th></tr></thead>
                                            <tbody className="divide-y">
                                                {q.subQuestions.map(sub => {
                                                    const currentVal = (answers[q.id] || {})[sub.id];
                                                    return (
                                                        <tr key={sub.id} className="hover:bg-gray-50">
                                                            <td className="p-3"><MathText text={sub.text} /></td>
                                                            <td className="p-3 text-center"><input type="radio" name={`${q.id}-${sub.id}`} checked={currentVal === true} onChange={() => handleTfChange(q.id, sub.id, true)} className="w-5 h-5 cursor-pointer accent-blue-600"/></td>
                                                            <td className="p-3 text-center"><input type="radio" name={`${q.id}-${sub.id}`} checked={currentVal === false} onChange={() => handleTfChange(q.id, sub.id, false)} className="w-5 h-5 cursor-pointer accent-red-600"/></td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                                {q.type === 'text' && (
                                    <input type="text" value={answers[q.id] || ''} onChange={(e) => handleTextChange(q.id, e.target.value)} className="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nh·∫≠p ƒë√°p √°n (s·ªë th·∫≠p ph√¢n)..." />
                                )}
                            </div>
                        ))}
                        <div className="flex justify-center pt-6">
                            <button onClick={() => setShowConfirmModal(true)} disabled={isSubmitting} className={`px-8 py-4 text-white text-lg font-bold rounded-xl shadow-lg flex items-center gap-2 transition-all ${isSubmitting ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 transform hover:scale-105'}`}>
                                {isSubmitting ? <><Icon name="loader" className="animate-spin"/> ƒêANG G·ª¨I...</> : <><Icon name="save"/> N·ªòP B√ÄI</>}
                            </button>
                        </div>
                    </div>

                    {showConfirmModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 z-modal">
                            <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center animate-fade-in">
                                <h3 className="text-lg font-bold text-gray-900 mb-2">X√°c nh·∫≠n n·ªôp b√†i</h3>
                                <p className="text-sm text-gray-500 mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i thi?</p>
                                <div className="flex gap-3 justify-center">
                                    <button onClick={() => setShowConfirmModal(false)} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition-colors">H·ªßy b·ªè</button>
                                    <button onClick={handleConfirmSubmit} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-lg">ƒê·ªìng √Ω n·ªôp</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showWarning && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-red-900/80 p-4 backdrop-blur-sm z-modal">
                            <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 text-center animate-pulse-red border-4 border-red-600">
                                <div className="flex justify-center mb-4 text-red-600">
                                    <Icon name="alert-triangle" size={64} />
                                </div>
                                <h3 className="text-2xl font-bold text-red-700 mb-2 uppercase">C·∫£nh b√°o gian l·∫≠n!</h3>
                                <p className="text-gray-700 mb-4 font-medium">H·ªá th·ªëng ph√°t hi·ªán b·∫°n ƒë√£ r·ªùi kh·ªèi m√†n h√¨nh l√†m b√†i.</p>
                                <div className="bg-red-50 p-4 rounded-lg border border-red-200 mb-6">
                                    <p className="text-red-800 font-bold text-lg">S·ªë l·∫ßn vi ph·∫°m: {violationCount}/{maxV}</p>
                                    <p className="text-xs text-red-600 mt-1">N·∫øu vi ph·∫°m {maxV} l·∫ßn, b√†i thi s·∫Ω t·ª± ƒë·ªông b·ªã thu.</p>
                                </div>
                                <button onClick={() => setShowWarning(false)} className="w-full px-4 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition-colors shadow-lg">T√¥i ƒë√£ hi·ªÉu v√† ti·∫øp t·ª•c l√†m b√†i</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- K·∫æT QU·∫¢ & L·ªúI GI·∫¢I (GI·ªÆ NGUY√äN) ---
        const SolutionView = ({ questions, answers, score, onRetry, settings }) => {
            const [openExplain, setOpenExplain] = useState({});
            const toggleExplain = (id) => setOpenExplain(prev => ({ ...prev, [id]: !prev[id] }));
            const isPass = !settings.requirePassToViewSolution || (score >= settings.passScore);

            return (
                <div className="min-h-screen pb-20 animate-fade-in bg-gray-50">
                    <div className="bg-white shadow p-6 text-center mb-6">
                        <div className="flex justify-center mb-2">
                            {score >= settings.passScore ? <Icon name="trophy" size={56} className="text-yellow-500"/> : <Icon name="frown" size={56} className="text-gray-400"/>}
                        </div>
                        <h2 className="text-2xl font-bold text-gray-800">K·∫øt Qu·∫£ B√†i Thi</h2>
                        <div className={`mt-4 inline-block px-6 py-3 rounded-xl border ${score >= settings.passScore ? 'bg-blue-50 border-blue-200' : 'bg-red-50 border-red-200'}`}>
                            <span className="text-gray-600 uppercase text-xs font-bold block">T·ªïng ƒêi·ªÉm</span>
                            <span className={`text-4xl font-bold ${score >= settings.passScore ? 'text-blue-700' : 'text-red-600'}`}>{score.toFixed(2)}<span className="text-xl text-gray-500">/10</span></span>
                        </div>
                        {score >= settings.passScore ? ( <p className="mt-4 text-green-600 font-bold">Ch√∫c m·ª´ng! B·∫°n ƒë√£ ƒë·∫°t y√™u c·∫ßu.</p> ) : ( <p className="mt-4 text-red-600 font-bold">B·∫°n ch∆∞a ƒë·∫°t y√™u c·∫ßu ({settings.passScore} ƒëi·ªÉm).</p> )}
                    </div>

                    {!isPass && (
                        <div className="max-w-2xl mx-auto p-6 mb-8 bg-red-50 border border-red-200 rounded-xl text-center shadow-sm">
                            <div className="flex justify-center mb-3 text-red-500"><Icon name="lock" size={40}/></div>
                            <h3 className="text-xl font-bold text-red-700 mb-2">Ch∆∞a ƒê·∫°t Y√™u C·∫ßu Xem L·ªùi Gi·∫£i</h3>
                            <p className="text-gray-700">B·∫°n c·∫ßn ƒë·∫°t t·ªëi thi·ªÉu <span className="font-bold text-red-700">{settings.passScore} ƒëi·ªÉm</span> ƒë·ªÉ xem l·ªùi gi·∫£i chi ti·∫øt.</p>
                            <p className="text-gray-500 text-sm mt-2">H√£y √¥n t·∫≠p k·ªπ ki·∫øn th·ª©c v√† th·ª≠ l·∫°i nh√©!</p>
                        </div>
                    )}

                    {isPass && (
                        <div className="max-w-3xl mx-auto p-4 space-y-6">
                            <h3 className="font-bold text-green-700 flex items-center gap-2 mb-4"><Icon name="check-circle" size={20}/> Chi Ti·∫øt L·ªùi Gi·∫£i</h3>
                            {questions.map((q, idx) => {
                                const isOpen = openExplain[q.id];
                                return (
                                    <div key={q.id} className="bg-white rounded-lg shadow-sm border-l-4 border-blue-400 overflow-hidden">
                                        <div className="p-4 cursor-pointer hover:bg-gray-50 transition-colors" onClick={() => toggleExplain(q.id)}>
                                            <div className="flex justify-between items-start">
                                                <div className="font-medium text-gray-800 flex-1 flex gap-2"><span className="font-bold whitespace-nowrap">C√¢u {idx + 1}:</span> <MathText text={q.question} /></div>
                                            </div>
                                            <div className="text-right text-xs text-blue-500 mt-2 font-medium flex items-center justify-end gap-1">{isOpen ? 'Thu g·ªçn' : 'Xem chi ti·∫øt'} <Icon name={isOpen ? "chevron-up" : "chevron-down"} size={14}/></div>
                                        </div>
                                        {isOpen && (
                                            <div className="bg-blue-50 p-4 text-sm text-blue-900 border-t border-blue-100">
                                                {q.image && <div className="mb-4 flex justify-center">{q.image}</div>}
                                                <span className="font-bold block mb-1">üí° L·ªùi gi·∫£i chi ti·∫øt:</span>
                                                <MathText text={q.explanation} />
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    <div className="flex justify-center pt-6 pb-10">
                        <button onClick={onRetry} className="px-8 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 shadow-lg flex items-center gap-2 transform hover:scale-105 transition-all">
                            <Icon name="refresh-ccw"/> L√†m l·∫°i ƒë·ªÅ m·ªõi
                        </button>
                    </div>
                </div>
            );
        };

        // --- GI√ÅO VI√äN ---
        const TeacherLogin = ({ onLogin, onBack }) => {
            const [pass, setPass] = useState('');
            const handleLogin = (e) => { e.preventDefault(); if (pass === '12345678T') onLogin(); };
            return ( <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4 animate-fade-in"> <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm"> <h2 className="text-xl font-bold mb-6 text-gray-800 text-center">Gi√°o Vi√™n ƒêƒÉng Nh·∫≠p</h2> <form onSubmit={handleLogin} className="space-y-4"> <input type="password" value={pass} onChange={(e) => setPass(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." autoFocus/> <button type="submit" className="w-full py-3 bg-blue-700 text-white rounded-lg font-bold hover:bg-blue-800">Truy c·∫≠p</button> <button type="button" onClick={onBack} className="w-full py-2 text-gray-500 hover:text-gray-800 text-sm">Quay l·∫°i</button> </form> </div> </div> );
        };

        // Modal Chi Ti·∫øt H·ªçc Sinh (GI·ªÆ NGUY√äN)
        const StudentDetailModal = ({ result, onClose }) => {
            if (!result) return null;
            const answers = result.answers || {};
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm z-modal">
                    <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col animate-fade-in">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                            <div><h3 className="text-lg font-bold text-gray-800">{result.name}</h3><p className="text-sm text-gray-500">ƒêi·ªÉm: <span className="font-bold text-blue-600">{result.score?.toFixed(2)}</span> - {new Date(result.timestamp).toLocaleString('vi-VN')}</p></div>
                            <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-full"><Icon name="x" size={20}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto flex-1 space-y-6">
                            {QUESTION_BANK.map((q, idx) => {
                                let isCorrect = false, userAnsDisplay = "Ch∆∞a tr·∫£ l·ªùi", correctAnsDisplay = "";
                                if (q.type === 'mcq') { const userIdx = answers[q.id]; if (userIdx !== undefined) userAnsDisplay = String.fromCharCode(65 + userIdx); correctAnsDisplay = String.fromCharCode(65 + q.correct); isCorrect = userIdx === q.correct; } 
                                else if (q.type === 'text') { const userVal = (answers[q.id] || "").trim(); userAnsDisplay = userVal || "Tr·ªëng"; correctAnsDisplay = q.acceptable.join(" ho·∫∑c "); isCorrect = q.acceptable.includes(userVal); } 
                                else if (q.type === 'group_tf') { return ( <div key={q.id} className="p-4 rounded-lg border bg-gray-50 border-gray-200"> <div className="font-bold text-gray-700 mb-2">C√¢u {idx + 1}: <MathText text={q.question} /></div> <div className="ml-4 space-y-1"> {q.subQuestions.map(sub => { const userVal = (answers[q.id] || {})[sub.id]; const isSubCorrect = userVal === sub.correct; return ( <div key={sub.id} className="flex justify-between text-sm border-b border-gray-100 last:border-0 py-1"> <span className="flex-1"><MathText text={sub.text} /></span> <div className="flex gap-4"> <span className={isSubCorrect ? "text-green-600 font-bold" : "text-red-600 font-bold"}> {userVal === true ? 'ƒê√∫ng' : userVal === false ? 'Sai' : 'Ch∆∞a ch·ªçn'} </span> {!isSubCorrect && (<span className="text-gray-500">(ƒê.√°n: {sub.correct ? 'ƒê√∫ng' : 'Sai'})</span>)} </div> </div> ); })} </div> </div> ); }
                                return ( <div key={q.id} className={`p-4 rounded-lg border ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}> <div className="flex gap-2 mb-2"> <span className="font-bold text-gray-700">C√¢u {idx + 1}:</span> <div className="flex-1"><MathText text={q.question} /></div> </div> <div className="flex flex-col sm:flex-row gap-4 text-sm mt-2"> <div className={`${isCorrect ? 'text-green-700' : 'text-red-700'} font-medium`}>Tr·∫£ l·ªùi: {userAnsDisplay}</div> {!isCorrect && (<div className="text-gray-600">ƒê√°p √°n ƒë√∫ng: <span className="font-bold">{correctAnsDisplay}</span></div>)} </div> </div> );
                            })}
                        </div>
                        <div className="p-4 border-t bg-gray-50 rounded-b-xl text-right">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">ƒê√≥ng</button>
                        </div>
                    </div>
                </div>
            );
        };

        const TeacherDashboard = ({ onLogout, currentSettings, onUpdateSettings }) => {
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedResult, setSelectedResult] = useState(null);
            const [deleteId, setDeleteId] = useState(null);
            const [activeTab, setActiveTab] = useState('stats');
            const [settings, setSettings] = useState(currentSettings);
            const [savingSettings, setSavingSettings] = useState(false);

            useEffect(() => {
                if (!db) { setLoading(false); return; }
                const unsubscribe = db.collection(COLLECTION_NAME).orderBy('timestamp', 'desc').onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setResults(data);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleDeleteClick = (id) => setDeleteId(id);
            const confirmDelete = async () => { if (deleteId) { try { await db.collection(COLLECTION_NAME).doc(deleteId).delete(); setDeleteId(null); } catch (e) { alert("L·ªói: " + e.message); } } }
            const handleExport = () => { const header = "Thoi Gian,Ho Ten,Diem So\n"; const rows = results.map(r => `${new Date(r.timestamp).toLocaleString('vi-VN').replace(/,/g, '')},${r.name},${r.score}`).join("\n"); const blob = new Blob([header + rows], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", "ket_qua_thi.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const handleSaveSettings = async () => { setSavingSettings(true); try { await onUpdateSettings(settings); alert("ƒê√£ l∆∞u c·∫•u h√¨nh th√†nh c√¥ng!"); } catch (e) { alert("L·ªói l∆∞u c·∫•u h√¨nh: " + e.message); } setSavingSettings(false); };

            const filteredResults = results.filter(r => r.name.toLowerCase().includes(searchTerm.toLowerCase()));
            const stats = useMemo(() => {
                const total = results.length;
                if (total === 0) return { avg: 0, pass: 0, excellent: 0 };
                const sum = results.reduce((acc, curr) => acc + (curr.score || 0), 0);
                const passCount = results.filter(r => r.score >= settings.passScore).length;
                const excCount = results.filter(r => r.score >= 8).length;
                return { avg: (sum / total).toFixed(2), pass: ((passCount / total) * 100).toFixed(1), excellent: ((excCount / total) * 100).toFixed(1) };
            }, [results, settings.passScore]);

            return (
                <div className="min-h-screen bg-gray-50 animate-fade-in pb-10">
                    <div className="bg-white shadow px-6 py-4 flex justify-between items-center sticky top-0 z-10">
                        <div className="flex items-center gap-4">
                            <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2"><Icon name="layout-dashboard" className="text-blue-600"/> B·∫£ng ƒêi·ªÅu Khi·ªÉn</h1>
                            <div className="flex space-x-2 bg-gray-100 p-1 rounded-lg">
                                <button onClick={() => setActiveTab('stats')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeTab === 'stats' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>Th·ªëng k√™</button>
                                <button onClick={() => setActiveTab('settings')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeTab === 'settings' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>C·∫•u h√¨nh b√†i thi</button>
                            </div>
                        </div>
                        <button onClick={onLogout} className="text-red-600 hover:bg-red-50 px-4 py-2 rounded-lg flex items-center gap-2 font-medium"><Icon name="log-out" size={18}/> ƒêƒÉng xu·∫•t</button>
                    </div>

                    <div className="max-w-7xl mx-auto p-6 space-y-6">
                        {activeTab === 'stats' && (
                            <>
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-blue-100">
                                        <div className="text-gray-500 text-sm font-medium">T·ªïng b√†i thi</div>
                                        <div className="text-2xl font-bold text-blue-700">{results.length}</div>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-green-100">
                                        <div className="text-gray-500 text-sm font-medium">ƒêi·ªÉm trung b√¨nh</div>
                                        <div className="text-2xl font-bold text-green-700">{stats.avg}</div>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-yellow-100">
                                        <div className="text-gray-500 text-sm font-medium">T·ª∑ l·ªá ƒë·∫°t (&ge;{settings.passScore})</div>
                                        <div className="text-2xl font-bold text-yellow-600">{stats.pass}%</div>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-purple-100">
                                        <div className="text-gray-500 text-sm font-medium">T·ª∑ l·ªá gi·ªèi (>=8)</div>
                                        <div className="text-2xl font-bold text-purple-600">{stats.excellent}%</div>
                                    </div>
                                </div>

                                <div className="flex flex-col md:flex-row justify-between gap-4">
                                    <div className="relative flex-1 max-w-md">
                                        <Icon name="search" className="absolute left-3 top-3 text-gray-400" size={20}/>
                                        <input type="text" placeholder="T√¨m ki·∫øm theo t√™n h·ªçc sinh..." className="w-full pl-10 pr-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                    </div>
                                    <button onClick={handleExport} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2 font-medium shadow-sm"><Icon name="download" size={18}/> Xu·∫•t Excel</button>
                                </div>

                                <div className="bg-white rounded-xl shadow overflow-hidden border border-gray-200">
                                    <div className="overflow-x-auto">
                                        <table className="w-full whitespace-nowrap">
                                            <thead className="bg-gray-50 border-b">
                                                <tr>
                                                    <th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase">Th·ªùi gian</th>
                                                    <th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase">H·ªç v√† T√™n</th>
                                                    <th className="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase">ƒêi·ªÉm S·ªë</th>
                                                    <th className="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase">Tr·∫°ng th√°i</th>
                                                    <th className="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase">H√†nh ƒë·ªông</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-200">
                                                {loading ? (<tr><td colSpan="5" className="p-8 text-center text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>) : filteredResults.length === 0 ? (<tr><td colSpan="5" className="p-8 text-center text-gray-500">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o.</td></tr>) : (filteredResults.map((res) => (
                                                    <tr key={res.id} className="hover:bg-gray-50 transition-colors">
                                                        <td className="px-6 py-4 text-sm text-gray-500">{new Date(res.timestamp).toLocaleString('vi-VN')}</td>
                                                        <td className="px-6 py-4 font-medium text-gray-900">{res.name}</td>
                                                        <td className="px-6 py-4 text-center"><span className={`inline-flex items-center justify-center px-3 py-1 rounded-full text-sm font-bold ${res.score >= 8 ? 'bg-green-100 text-green-800' : res.score >= 5 ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}`}>{res.score?.toFixed(2)}</span></td>
                                                        <td className="px-6 py-4 text-center text-sm">{res.score >= 5 ? <span className="text-green-600 flex items-center justify-center gap-1"><Icon name="check" size={14}/> ƒê·∫°t</span> : <span className="text-red-500 flex items-center justify-center gap-1"><Icon name="x" size={14}/> Tr∆∞·ª£t</span>}</td>
                                                        <td className="px-6 py-4 text-right space-x-2">
                                                            <button onClick={() => setSelectedResult(res)} className="inline-flex items-center justify-center px-3 py-1.5 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors gap-1" title="Xem chi ti·∫øt"><Icon name="eye" size={16}/> Xem</button>
                                                            <button onClick={() => handleDeleteClick(res.id)} className="inline-flex items-center justify-center px-3 py-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors gap-1" title="X√≥a"><Icon name="trash-2" size={16}/> X√≥a</button>
                                                        </td>
                                                    </tr>
                                                )))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </>
                        )}

                        {activeTab === 'settings' && (
                            <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-200 max-w-2xl mx-auto">
                                <h3 className="text-lg font-bold text-gray-800 mb-6 border-b pb-2">C·∫•u H√¨nh B√†i Thi</h3>
                                
                                <div className="space-y-6">
                                    <div className="p-4 bg-gray-50 rounded-lg border border-gray-100">
                                        <Toggle 
                                            label="Ch·∫ø ƒë·ªô ch·ªëng gian l·∫≠n (Ph√°t hi·ªán chuy·ªÉn tab)" 
                                            checked={settings.antiCheat} 
                                            onChange={(val) => setSettings({...settings, antiCheat: val})}
                                        />
                                        {settings.antiCheat && (
                                            <div className="mt-3">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">S·ªë l·∫ßn vi ph·∫°m t·ªëi ƒëa (T·ª± ƒë·ªông n·ªôp khi v∆∞·ª£t qu√°)</label>
                                                <input type="number" min="1" value={settings.maxViolations || 3} onChange={(e) => setSettings({...settings, maxViolations: parseInt(e.target.value) || 3})} className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"/>
                                            </div>
                                        )}
                                        <p className="text-xs text-gray-500 mt-1">H·ªá th·ªëng s·∫Ω c·∫£nh b√°o v√† t·ª± ƒë·ªông n·ªôp b√†i n·∫øu h·ªçc sinh r·ªùi kh·ªèi m√†n h√¨nh qu√° s·ªë l·∫ßn quy ƒë·ªãnh.</p>
                                    </div>

                                    <div className="p-4 bg-gray-50 rounded-lg border border-gray-100">
                                        <Toggle 
                                            label="B·∫≠t ƒë·ªìng h·ªì" 
                                            checked={settings.timerEnabled} 
                                            onChange={(val) => setSettings({...settings, timerEnabled: val})}
                                        />
                                        {settings.timerEnabled && (
                                            <div className="mt-3 space-y-3">
                                                <div className="flex flex-col gap-2">
                                                    <label className="flex items-center space-x-2 cursor-pointer">
                                                        <input type="radio" name="timerMode" value="countdown" checked={settings.timerMode === 'countdown'} onChange={() => setSettings({...settings, timerMode: 'countdown'})} className="text-blue-600 focus:ring-blue-500"/>
                                                        <span>ƒê·∫øm ng∆∞·ª£c (Gi·ªõi h·∫°n th·ªùi gian)</span>
                                                    </label>
                                                    <label className="flex items-center space-x-2 cursor-pointer">
                                                        <input type="radio" name="timerMode" value="countup" checked={settings.timerMode === 'countup'} onChange={() => setSettings({...settings, timerMode: 'countup'})} className="text-blue-600 focus:ring-blue-500"/>
                                                        <span>B·∫•m gi·ªù (ƒê·∫øm xu√¥i)</span>
                                                    </label>
                                                    <label className="flex items-center space-x-2 cursor-pointer">
                                                        <input type="radio" name="timerMode" value="realtime" checked={settings.timerMode === 'realtime'} onChange={() => setSettings({...settings, timerMode: 'realtime'})} className="text-blue-600 focus:ring-blue-500"/>
                                                        <span>Th·ªùi gian th·ª±c (ƒê·ªìng h·ªì)</span>
                                                    </label>
                                                </div>

                                                {settings.timerMode === 'countdown' && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">Th·ªùi gian l√†m b√†i (ph√∫t)</label>
                                                        <input type="number" value={settings.timerDuration} onChange={(e) => setSettings({...settings, timerDuration: parseInt(e.target.value) || 0})} className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"/>
                                                    </div>
                                                )}
                                                {settings.timerMode === 'countup' && <p className="text-xs text-gray-500">ƒê·ªìng h·ªì s·∫Ω ch·∫°y t·ª´ 00:00. Kh√¥ng gi·ªõi h·∫°n th·ªùi gian t·ª± ƒë·ªông n·ªôp.</p>}
                                                {settings.timerMode === 'realtime' && <p className="text-xs text-gray-500">Hi·ªÉn th·ªã gi·ªù hi·ªán t·∫°i. Kh√¥ng gi·ªõi h·∫°n th·ªùi gian t·ª± ƒë·ªông n·ªôp.</p>}
                                            </div>
                                        )}
                                    </div>

                                    <div className="p-4 bg-gray-50 rounded-lg border border-gray-100">
                                        <Toggle 
                                            label="Y√™u c·∫ßu ƒë·∫°t ƒëi·ªÉm s√†n ƒë·ªÉ xem l·ªùi gi·∫£i" 
                                            checked={settings.requirePassToViewSolution} 
                                            onChange={(val) => setSettings({...settings, requirePassToViewSolution: val})}
                                        />
                                        {settings.requirePassToViewSolution && (
                                            <div className="mt-3">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">ƒêi·ªÉm ƒëi·ªÅu ki·ªán (>=)</label>
                                                <input type="number" step="0.1" value={settings.passScore} onChange={(e) => setSettings({...settings, passScore: parseFloat(e.target.value) || 0})} className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"/>
                                                <p className="text-xs text-gray-500 mt-1">H·ªçc sinh ph·∫£i ƒë·∫°t ƒëi·ªÉm n√†y tr·ªü l√™n m·ªõi ƒë∆∞·ª£c xem l·ªùi gi·∫£i chi ti·∫øt.</p>
                                            </div>
                                        )}
                                    </div>

                                    <button onClick={handleSaveSettings} disabled={savingSettings} className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-all flex justify-center items-center gap-2 shadow-lg">
                                        {savingSettings ? <Icon name="loader" className="animate-spin"/> : <Icon name="save"/>} L∆∞u C·∫•u H√¨nh
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {selectedResult && <StudentDetailModal result={selectedResult} onClose={() => setSelectedResult(null)} />}
                    {deleteId && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm z-modal">
                            <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center animate-fade-in">
                                <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4 text-red-600"><Icon name="trash-2" size={24}/></div>
                                <h3 className="text-lg font-bold text-gray-900 mb-2">X√°c nh·∫≠n x√≥a</h3>
                                <p className="text-sm text-gray-500 mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a k·∫øt qu·∫£ n√†y?</p>
                                <div className="flex gap-3 justify-center">
                                    <button onClick={() => setDeleteId(null)} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg">H·ªßy</button>
                                    <button onClick={confirmDelete} className="px-4 py-2 bg-red-600 text-white rounded-lg font-bold">X√≥a vƒ©nh vi·ªÖn</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- APP CH√çNH ---
        const App = () => {
            const [view, setView] = useState('welcome');
            const [studentName, setStudentName] = useState('');
            const [currentQuestions, setCurrentQuestions] = useState([]);
            const [finalScore, setFinalScore] = useState(0);
            const [userAnswers, setUserAnswers] = useState({});
            const [appSettings, setAppSettings] = useState(DEFAULT_SETTINGS);

            useEffect(() => {
                if (auth) auth.signInAnonymously().catch(console.error);
                if (db) {
                    const unsubscribe = db.collection(SETTINGS_COLLECTION).doc(SETTINGS_DOC_ID).onSnapshot(doc => {
                        if (doc.exists) {
                            setAppSettings({ ...DEFAULT_SETTINGS, ...doc.data() });
                        }
                    });
                    return () => unsubscribe();
                }
            }, []);

            const updateSettings = async (newSettings) => { if (db) await db.collection(SETTINGS_COLLECTION).doc(SETTINGS_DOC_ID).set(newSettings); };
            const startNewQuiz = (name) => { setStudentName(name); setCurrentQuestions(QUESTION_BANK); setView('quiz'); };
            const handleSubmitQuiz = async (answers) => {
                const score = calculateScore(currentQuestions, answers);
                setFinalScore(score);
                setUserAnswers(answers);
                if (db && auth && auth.currentUser) db.collection(COLLECTION_NAME).add({ name: studentName, score: score, answers: answers, timestamp: new Date().toISOString() });
                setView('result'); 
            };

            return (
                <div>
                    {view === 'welcome' && <WelcomeScreen onSelectMode={(mode) => setView(mode === 'student' ? 'name' : 'login')} />}
                    {view === 'name' && <StudentNameInput onStart={startNewQuiz} />}
                    {view === 'quiz' && <QuizView studentName={studentName} questions={currentQuestions} onSubmit={handleSubmitQuiz} settings={appSettings} />}
                    {view === 'result' && <SolutionView questions={currentQuestions} answers={userAnswers} score={finalScore} onRetry={() => startNewQuiz(studentName)} settings={appSettings} />}
                    {view === 'login' && <TeacherLogin onLogin={() => setView('teacher')} onBack={() => setView('welcome')} />}
                    {view === 'teacher' && <TeacherDashboard onLogout={() => setView('welcome')} currentSettings={appSettings} onUpdateSettings={updateSettings} />}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
